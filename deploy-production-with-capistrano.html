<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Andrew Tsai" />
        <meta name="copyright" content="Andrew Tsai" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="rails, Web, " />

<meta property="og:title" content="Deploy production with Capistrano "/>
<meta property="og:url" content="/deploy-production-with-capistrano.html" />
<meta property="og:description" content="This article will describe how to deploy production with Capistrano. The official site provides useful explanations on the usage and structure of capistrano. Here we assume that you are already able to login your production server with SSH key. Installation Add the lines to Gemfile: Gemfile: gem &#39;capistrano-rails&#39;, &#39;1.1 ..." />
<meta property="og:site_name" content="TH&#39;s Notes" />
<meta property="og:article:author" content="Andrew Tsai" />
<meta property="og:article:published_time" content="2015-03-19T00:00:00+08:00" />
<meta name="twitter:title" content="Deploy production with Capistrano ">
<meta name="twitter:description" content="This article will describe how to deploy production with Capistrano. The official site provides useful explanations on the usage and structure of capistrano. Here we assume that you are already able to login your production server with SSH key. Installation Add the lines to Gemfile: Gemfile: gem &#39;capistrano-rails&#39;, &#39;1.1 ...">

        <title>Deploy production with Capistrano  Â· TH&#39;s Notes
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="TH&#39;s Notes - Full Atom Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>TH's Notes</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/deploy-production-with-capistrano.html"> Deploy production with Capistrano  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>This article will describe how to deploy production with <a href="https://github.com/capistrano/rails/">Capistrano</a>.
The <a href="http://capistranorb.com/">official site</a> provides useful explanations on the usage and structure of capistrano.</p>
<p>Here we assume that you are already able to login your production server with SSH key.</p>
<h3>Installation</h3>
<p>Add the lines to Gemfile:</p>
<p>Gemfile:</p>
<div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.3&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
</pre></div>


<p>Install and initialize capistrano:</p>
<div class="highlight"><pre>bundle install
cap install
</pre></div>


<p>Add the followings lines to <code>Capfile</code>.</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;capistrano/setup&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/deploy&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/rbenv&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/bundler&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/rails/migrations&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/rails/assets&#39;</span>

<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;lib/capistrano/tasks/*.rake&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">import</span> <span class="n">r</span> <span class="p">}</span>
</pre></div>


<h3>Configuration</h3>
<p>Set up global configuration in <code>config/deploy.rb</code> as following sample.</p>
<p>config/deploy.rb:</p>
<div class="highlight"><pre><span class="c1"># config valid only for current version of Capistrano</span>
<span class="n">lock</span> <span class="s1">&#39;3.4.0&#39;</span>

<span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;YOUR_APP_Name&#39;</span>
<span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">.com&quot;</span>
<span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s2">&quot;deployer&quot;</span>
<span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s2">&quot;git@bitbucket.org:YOUR_ACCOUNT_NAME/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">.git&quot;</span>
<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/home/deployer/apps/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">set</span> <span class="ss">:current_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2">/current&quot;</span>
<span class="n">set</span> <span class="ss">:shared_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2">/shared&quot;</span>
<span class="n">set</span> <span class="ss">:releases_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2">/releases&quot;</span>
<span class="n">set</span> <span class="ss">:default_env</span><span class="p">,</span> <span class="p">{</span> <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;~/.rbenv/shims:~/.rbenv/bin:$PATH&quot;</span> <span class="p">}</span>
<span class="n">set</span> <span class="ss">:rbenv_ruby</span><span class="p">,</span> <span class="s1">&#39;2.1.5&#39;</span>
<span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:remote_cache</span>

<span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:linked_files</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s1">&#39;config/application.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;config/database.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;config/secrets.yml&#39;</span><span class="p">)</span>

<span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:linked_dirs</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
</pre></div>


<p>Next, set up the IP of your production server in <code>config/deploy/production.rb</code>:</p>
<p>config/deploy/production.rb:</p>
<div class="highlight"><pre><span class="n">server</span> <span class="s1">&#39;162.233.120.172&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deployer&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span>
</pre></div>


<p>Be sure that <code>db</code> is added for database migration will be executed.</p>
<h3>Start to deploy</h3>
<p>All you have to do is execute this command:</p>
<div class="highlight"><pre>cap production deploy
</pre></div>


<h3>List all tasks</h3>
<p>To view all available tasks in capistrano:</p>
<div class="highlight"><pre>cap -T
</pre></div>


<h3>Define your own tasks</h3>
<p>You can write your own tasks and put them under <code>lib/capistrano/tasks/</code>.</p>
<p>For example, assume we have wrote a task named <code>access_check.rake</code> with following content:</p>
<p>lib/capistrano/tasks/access_check.rake:</p>
<div class="highlight"><pre><span class="n">desc</span> <span class="s2">&quot;Check that we can access everything&quot;</span>
<span class="n">task</span> <span class="ss">:check_write_permissions</span> <span class="k">do</span>
  <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">host</span><span class="o">|</span>
    <span class="k">if</span> <span class="nb">test</span><span class="p">(</span><span class="s2">&quot;[ -w </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2"> ]&quot;</span><span class="p">)</span>
      <span class="n">info</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2"> is writable on </span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="n">error</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not writable on </span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Now, we can check if we have enough writing permissions on the production server by executing:</p>
<div class="highlight"><pre>cap production check_write_permissions
</pre></div>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-03-19T00:00:00+08:00"> 3 19, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#web-ref">Web</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#rails-ref">rails
                    <span>63</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="https://github.com/tsaith" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="https://twitter.com/tsunghuatsai" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="https://linkedin.com/in/tsunghua" title="My Linkedin Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-linkedin sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>