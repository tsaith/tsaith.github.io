{"pages":[{"tags":"Machine learning","title":"Implement multilayer perceptron for digit recognition","text":"This post will demonstrate how to implement multilayer perceptron for digit recognition. The detailed derivations of algorithm can be found from my script . Main workflow Preparing training/validation/testing datasets. Set the weight decay / numerical parameters. Check if the gradients of the loss function are correct. Training model. Estimate the accuracy of prediction. Ipython notebook In [1]: % load_ext autoreload % autoreload 2 % matplotlib inline import numpy as np import matplotlib.pyplot as plt from dnn_play.classifiers.mlp import MLP , mlp_loss , rel_err_gradients from dnn_play.utils.data_utils import load_mnist from dnn_play.utils.visualize_utils import display_network # Plot settings plt . rcParams [ 'figure.figsize' ] = ( 10.0 , 10.0 ) # set default size of plots plt . rcParams [ 'image.interpolation' ] = 'nearest' In [2]: # Load MNIST data ( X_train , y_train ), ( X_val , y_val ), ( X_test , y_test ) = load_mnist () #(X_train, y_train), (X_val, y_val), (X_test, y_test) = load_mnist(n_train=9000, n_val=1000, n_test=1000) print ( \"X_train shape = {} y_train shape = {}\" . format ( X_train . shape , y_train . shape )) print ( \"X_val shape = {} y_val shape = {}\" . format ( X_val . shape , y_val . shape )) print ( \"X_test shape = {} y_test shape = {}\" . format ( X_test . shape , y_test . shape )) X_train shape = (784, 55000) y_train shape = (55000,) X_val shape = (784, 5000) y_val shape = (5000,) X_test shape = (784, 10000) y_test shape = (10000,) In [3]: # Number of layer units input_size = X_train . shape [ 0 ] # Dimension of features hidden_size_L1 = 200 hidden_size_L2 = 200 output_size = np . max ( y_train ) + 1 # Number of classes # Network configuration #layer_units = ((input_size, output_size)) layer_units = (( input_size , hidden_size_L1 , output_size )) #layer_units = ((input_size, hidden_size_L1, hidden_size_L2, output_size)) # Hyperparameters reg = 1 e - 4 # Regulation, weight decay # Numerical parameters max_iters = 400 # Define the classifier clf = MLP ( layer_units ) # Initialize weights weights = clf . init_weights () loss , grad = mlp_loss ( weights , X_train , y_train , 0.0 ) # Note there are 10 classes. # As a rough sanity check, our loss should be something close to -log(0.1). print ( 'loss: %f' % loss ) print ( 'sanity check: %f' % ( - np . log ( 0.1 ))) loss: 2.302606 sanity check: 2.302585 In [4]: # Gradient checking if rel_err_gradients () < 1 e - 8 : print ( \"Gradient check passed!\" ) else : print ( \"Gradient check failed!\" ) Gradient check passed! In [5]: \"\"\" Training \"\"\" reg = 1 e - 4 # Regulation, weight decay #clf = MLP(layer_units, weights = weights) weights , loss_history , train_acc_history , val_acc_history = clf . fit ( X_train , y_train , X_val , y_val , reg = reg , max_iters = max_iters , verbose = True ) iter: 20, loss: 1.492642, train_acc: 0.469182, val_acc: 0.486800 iter: 40, loss: 0.374339, train_acc: 0.899927, val_acc: 0.917000 iter: 60, loss: 0.228775, train_acc: 0.943600, val_acc: 0.955400 iter: 80, loss: 0.164778, train_acc: 0.967891, val_acc: 0.974200 iter: 100, loss: 0.136664, train_acc: 0.980036, val_acc: 0.978600 iter: 120, loss: 0.119424, train_acc: 0.987036, val_acc: 0.980200 iter: 140, loss: 0.111179, train_acc: 0.990855, val_acc: 0.982000 iter: 160, loss: 0.106608, train_acc: 0.993455, val_acc: 0.982800 iter: 180, loss: 0.103801, train_acc: 0.994945, val_acc: 0.984400 iter: 200, loss: 0.101420, train_acc: 0.995164, val_acc: 0.984800 iter: 220, loss: 0.099555, train_acc: 0.995200, val_acc: 0.984800 iter: 240, loss: 0.098186, train_acc: 0.995655, val_acc: 0.986000 iter: 260, loss: 0.097174, train_acc: 0.995818, val_acc: 0.985400 iter: 280, loss: 0.096363, train_acc: 0.996073, val_acc: 0.985600 iter: 300, loss: 0.095713, train_acc: 0.996291, val_acc: 0.985600 iter: 320, loss: 0.095071, train_acc: 0.996036, val_acc: 0.985800 iter: 340, loss: 0.094583, train_acc: 0.996273, val_acc: 0.986400 iter: 360, loss: 0.094141, train_acc: 0.996455, val_acc: 0.986800 iter: 380, loss: 0.093763, train_acc: 0.996673, val_acc: 0.986600 iter: 400, loss: 0.093387, train_acc: 0.996673, val_acc: 0.986600 In [6]: # Plot the loss function and train / validation accuracies plt . subplot ( 2 , 1 , 1 ) plt . plot ( loss_history ) plt . title ( 'Loss history' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Loss' ) plt . subplot ( 2 , 1 , 2 ) plt . plot ( train_acc_history ) plt . plot ( val_acc_history ) plt . legend ([ 'Training accuracy' , 'Validation accuracy' ], loc = 'lower right' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Clasification accuracy' ) Out[6]: <matplotlib.text.Text at 0x10b853278> In [7]: # Visualize the weights W0 = weights [ 0 ][ 'W' ] image = display_network ( W0 . T ) plt . imshow ( image , cmap = plt . cm . gray ) Out[7]: <matplotlib.image.AxesImage at 0x10b91da20> In [8]: # Make predictions pred = clf . predict ( X_test ) acc = np . mean ( y_test == pred ) print ( \"Accuracy: {:5.2f}% \\n \" . format ( acc * 100 )) Accuracy: 98.19% In [9]: # View some images and predictions n_images = 4 images = X_test [:, : n_images ] . reshape (( 28 , 28 , n_images )) pred = clf . predict ( X_test [:, : n_images ]) for i in range ( n_images ): plt . subplot ( 1 , n_images , i + 1 ) plt . imshow ( images [:, :, i ], cmap = plt . cm . gray ) plt . title ( 'Predicted digit: {}' . format ( pred [ i ])) plt . axis ( 'off' ) Multilayer perceptron import numpy as np import scipy.optimize from dnn_play.activations import tanh, tanh_deriv, sigmoid, sigmoid_deriv from dnn_play.utils.np_utils import to_binary_class_matrix from dnn_play.utils.gradient_utils import eval_numerical_gradient, rel_norm_diff def f_ac(x): return sigmoid(x) #return tanh(x) def df_ac(x): return sigmoid_deriv(x) #return tanh_deriv(x) class MLP(object): \"\"\" Multilayer perceptron. \"\"\" def __init__(self, layer_units, weights=None): self.weights = weights self.layer_units = layer_units def init_weights(self, eps=1e-4): \"\"\" Initialize weights. layer_units: tuple stores the size of each layer. weights: structured weights. \"\"\" layer_units = self.layer_units n_layers = len(layer_units) weights = [{} for i in range(n_layers - 1)] for i in range(n_layers - 1): weights[i]['W'] = eps * np.random.randn(layer_units[i+1], layer_units[i]) weights[i]['b'] = np.zeros(layer_units[i+1]) self.weights = weights return self.weights def fit(self, X, y, X_val, y_val, reg=0.0, learning_rate=1e-2, optimizer='L-BFGS-B', max_iters=100, sample_batches=True, n_epochs=30, batch_size=128, verbose=False): epoch = 0 best_val_acc = 0.0 best_weights = {} input_size, n_train = X.shape n_classes = np.max(y) + 1 # assume y takes values 0...K-1 where K is number of classes if self.weights is None: # lazily initialize weights self.weights = self.init_weights() # Solve with L-BFGS-B options = {'maxiter': max_iters, 'disp': verbose} def J(theta): weights = pack_struct(theta, self.layer_units) loss, grad = mlp_loss(weights, X, y, reg) grad = flatten_struct(grad) return loss, grad # Callback to get accuracies based on training / validation sets iter_feval = 0 loss_history = [] train_acc_history = [] val_acc_history = [] def progress(x): nonlocal iter_feval, best_weights, best_val_acc iter_feval += 1 # Loss history weights = pack_struct(x, self.layer_units) loss, grad = mlp_loss(weights, X, y, reg) loss_history.append(loss) # Training accurary y_pred_train = mlp_predict(weights, X) train_acc = np.mean(y_pred_train == y) train_acc_history.append(train_acc) # Validation accuracy y_pred_val= mlp_predict(weights, X_val) val_acc = np.mean(y_pred_val == y_val) val_acc_history.append(val_acc) # Keep track of the best weights based on validation accuracy if val_acc > best_val_acc: best_val_acc = val_acc n_weights = len(weights) best_weights = [{} for i in range(n_weights)] for i in range(n_weights): for p in weights[i]: best_weights[i][p] = weights[i][p].copy() n_iters_verbose = max_iters / 20 if iter_feval % n_iters_verbose == 0: print(\"iter: {:4d}, loss: {:8f}, train_acc: {:4f}, val_acc: {:4f}\".format(iter_feval, loss, train_acc, val_acc)) # Minimize the loss function init_theta = flatten_struct(self.weights) results = scipy.optimize.minimize(J, init_theta, method=optimizer, jac=True, callback=progress, options=options) # Save weights self.weights = best_weights return self.weights, loss_history, train_acc_history, val_acc_history def predict(self, X): \"\"\" X: the N x M input matrix, where each column data[:, i] corresponds to a single test set pred: the predicted results. \"\"\" pred = mlp_predict(self.weights, X) return pred def flatten_struct(self, data): return flatten_struct(data) def pack_struct(self, data): return pack_struct(data, self.layer_units) def mlp_loss(weights, X, y, reg): \"\"\" Compute loss and gradients of the neutral network. \"\"\" L = len(weights) # The index of the output layer z = [] a = [] err_tol = 1e-10 # Error of tolerance # Number of samples m = X.shape[1] # Forward pass z.append(0) # Dummy element a.append(X) # Input activation for i in range(0, L): W = weights[i]['W'] b = weights[i]['b'] z.append(W.dot(a[-1]) + b.reshape((-1, 1))) a.append(f_ac(z[-1])) # Note the final element in a[:] will not be used zL_max = np.max(z[-1], axis=0) z[-1] -= zL_max # Avoid numerical problem due to large values of exp(z[-1]) proba = np.exp(z[-1]) / np.sum(np.exp(z[-1]), axis=0) + err_tol # Add err_tol to avoid this value too close to zero # Target matrix of labels target = to_binary_class_matrix(y) # Cost function sum_weight_square = 0.0 # Sum of weight square for i in range(L): W = weights[i]['W'] sum_weight_square += np.sum(W*W) cost = -1.0/m * np.sum(target * np.log(proba)) + 0.5*reg*sum_weight_square # Backpropagation delta = [-1.0 * (target - proba)] for i in reversed(range(L)): # Note that delta[0] will not be used W = weights[i]['W'] d = W.T.dot(delta[0])*df_ac(z[i]) delta.insert(0, d) # Insert element at beginning # Gradients grad = [{} for i in range(L)] for i in range(L): W = weights[i]['W'] grad[i]['W'] = delta[i+1].dot(a[i].T) / m + reg*W grad[i]['b'] = np.mean(delta[i+1], axis=1) return cost, grad def mlp_predict(weights, X): \"\"\" X: the N x M input matrix, where each column data[:, i] corresponds to a single test set pred: the predicted results. \"\"\" L = len(weights) # The index of the output layer z = [] a = [] err_tol = 1e-10 # Error of tolerance # Number of samples m = X.shape[1] # Forward pass z.append(0) # Dummy element a.append(X) # Input activation for i in range(0, L): W = weights[i]['W'] b = weights[i]['b'] z.append(W.dot(a[-1]) + b.reshape((-1, 1))) a.append(f_ac(z[-1])) # Note the final element in a[:] will not be used zL_max = np.max(z[-1], axis=0) z[-1] -= zL_max # Avoid numerical problem due to large values of exp(z[-1]) proba = np.exp(z[-1]) / np.sum(np.exp(z[-1]), axis=0) + err_tol # Add err_tol to avoid this value too close to zero # Predictions pred = np.argmax(proba, axis=0) return pred def flatten_struct(data): \"\"\" Flatten the data structure. \"\"\" n_data = len(data) # Data vector data_vec = np.concatenate((data[0]['W'].flatten(), data[0]['b'].flatten())) out = data_vec for i in range(1, n_data): data_vec = np.concatenate((data[i]['W'].flatten(), data[i]['b'].flatten())) out = np.concatenate((out, data_vec)) return out def pack_struct(data, layer_units): \"\"\" Pack the flattened data with structure. \"\"\" n_layers = len(layer_units) struct = [{} for i in range(n_layers - 1)] iz = 0 for i in range(n_layers - 1): ia = iz; iz = ia + layer_units[i+1]*layer_units[i] struct[i]['W'] = data[ia:iz].reshape((layer_units[i+1], layer_units[i])) ia = iz; iz = ia + layer_units[i+1] struct[i]['b'] = data[ia:iz] return struct def rel_err_gradients(): \"\"\" Return the relative error between analytic gradients and nemerical ones. \"\"\" # Number of layer units input_size = 4 * 4 hidden_size_L1 = 4 hidden_size_L2 = 4 output_size = 10 layer_units = (input_size, hidden_size_L1, hidden_size_L2, output_size) X_train = np.random.randn(input_size, 100) y_train = np.random.randint(output_size, size=100) reg = 1e-4 # Define the classifier clf = MLP(layer_units) # Initialize weights weights = clf.init_weights() # Analytic gradients of the cost function cost, grad = mlp_loss(weights, X_train, y_train, reg) grad = clf.flatten_struct(grad) # Flattened gradients def J(theta): # Structured weights weights = clf.pack_struct(theta) return mlp_loss(weights, X_train, y_train, reg)[0] theta = clf.flatten_struct(weights) numerical_grad = eval_numerical_gradient(J, theta) # Compare numerically computed gradients with those computed analytically rel_err = rel_norm_diff(numerical_grad, grad) return rel_err In case you are interested in all codes related in this demonstration, please check the repository .","url":"http://tsaith.github.io/implement-multilayer-perceptron-for-digit-recognition.html"},{"tags":"Machine learning","title":"Implement softmax regression for digit recognition","text":"This post will demonstrate how to implement softmax regression for digit recognition. The detailed derivations of algorithm can be found from my script . Main workflow Preparing training/validation/testing datasets. Set the weight decay / numerical parameters. Check if the gradients of the loss function are correct. Training model. Estimate the accuracy of prediction. Ipython notebook In [1]: % load_ext autoreload % autoreload 2 % matplotlib inline import numpy as np import matplotlib.pyplot as plt from dnn_play.classifiers.softmax import Softmax , softmax_loss , rel_err_gradients from dnn_play.utils.data_utils import load_mnist from dnn_play.utils.visualize_utils import display_network # Plot settings plt . rcParams [ 'figure.figsize' ] = ( 10.0 , 10.0 ) # set default size of plots plt . rcParams [ 'image.interpolation' ] = 'nearest' In [2]: # Load MNIST data ( X_train , y_train ), ( X_val , y_val ), ( X_test , y_test ) = load_mnist () #(X_train, y_train), (X_val, y_val), (X_test, y_test) = load_mnist(n_train=9000, n_val=1000, n_test=1000) print ( \"X_train shape = {} y_train shape = {}\" . format ( X_train . shape , y_train . shape )) print ( \"X_val shape = {} y_val shape = {}\" . format ( X_val . shape , y_val . shape )) print ( \"X_test shape = {} y_test shape = {}\" . format ( X_test . shape , y_test . shape )) X_train shape = (784, 55000) y_train shape = (55000,) X_val shape = (784, 5000) y_val shape = (5000,) X_test shape = (784, 10000) y_test shape = (10000,) In [3]: # Sanity check of softmax loss function # Number of layer units input_size = X_train . shape [ 0 ] # Dimension of features n_classes = np . max ( y_train ) + 1 layer_units = ( input_size , n_classes ) # Hyperparameters reg = 1 e - 4 # Numerical parameters max_iters = 400 # Define classifier clf = Softmax ( layer_units ) weights = clf . init_weights () loss , grad = softmax_loss ( weights , X_train , y_train , 0.0 ) # Note there are 10 classes. # As a rough sanity check, our loss should be something close to -log(0.1). print ( 'loss: %f' % loss ) print ( 'sanity check: %f' % ( - np . log ( 0.1 ))) loss: 2.302622 sanity check: 2.302585 In [4]: # Gradient checking if rel_err_gradients () < 1 e - 8 : print ( \"Gradient check passed!\" ) else : print ( \"Gradient check failed!\" ) Gradient check passed! In [5]: \"\"\" Training \"\"\" model , loss_history , train_acc_history , val_acc_history = clf . fit ( X_train , y_train , X_val , y_val , reg = reg , max_iters = max_iters , verbose = True ) iter: 20, loss: 0.325899, train_acc: 0.909036, val_acc: 0.928800 iter: 40, loss: 0.283475, train_acc: 0.923764, val_acc: 0.936000 iter: 60, loss: 0.271253, train_acc: 0.927873, val_acc: 0.939600 iter: 80, loss: 0.266398, train_acc: 0.930273, val_acc: 0.941400 iter: 100, loss: 0.264352, train_acc: 0.931582, val_acc: 0.941000 iter: 120, loss: 0.263492, train_acc: 0.932782, val_acc: 0.942000 iter: 140, loss: 0.263079, train_acc: 0.932873, val_acc: 0.941400 iter: 160, loss: 0.262900, train_acc: 0.933000, val_acc: 0.942400 iter: 180, loss: 0.262810, train_acc: 0.933109, val_acc: 0.942400 iter: 200, loss: 0.262773, train_acc: 0.933127, val_acc: 0.942400 iter: 220, loss: 0.262754, train_acc: 0.933018, val_acc: 0.942200 iter: 240, loss: 0.262747, train_acc: 0.933018, val_acc: 0.942600 iter: 260, loss: 0.262743, train_acc: 0.933073, val_acc: 0.942400 In [6]: # Plot the loss function and train / validation accuracies plt . subplot ( 2 , 1 , 1 ) plt . plot ( loss_history ) plt . title ( 'Loss history' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Loss' ) plt . subplot ( 2 , 1 , 2 ) plt . plot ( train_acc_history ) plt . plot ( val_acc_history ) plt . legend ([ 'Training accuracy' , 'Validation accuracy' ], loc = 'lower right' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Clasification accuracy' ) Out[6]: <matplotlib.text.Text at 0x109e8f4e0> In [7]: # Visualize the weights W0 = model [ 0 ][ 'W' ] image = display_network ( W0 . T ) plt . imshow ( image , cmap = plt . cm . gray ) Out[7]: <matplotlib.image.AxesImage at 0x10b22e6d8> In [8]: # Make predictions pred = clf . predict ( X_test ) acc = np . mean ( y_test == pred ) print ( \"Accuracy: {:5.2f}% \\n \" . format ( acc * 100 )) Accuracy: 92.54% In [9]: # View some images and predictions n_images = 3 images = X_test [:, : n_images ] . reshape (( 28 , 28 , n_images )) pred = clf . predict ( X_test [:, : n_images ]) for i in range ( n_images ): plt . subplot ( 1 , n_images , i + 1 ) plt . imshow ( images [:, :, i ], cmap = plt . cm . gray ) plt . title ( 'Predicted digit: {}' . format ( pred [ i ])) plt . axis ( 'off' ) Softmax classifier import numpy as np import scipy.optimize from dnn_play.utils.np_utils import to_binary_class_matrix, flatten_struct, pack_struct from dnn_play.utils.gradient_utils import eval_numerical_gradient, rel_norm_diff class Softmax(object): \"\"\" Softmax classifer \"\"\" def __init__(self, layer_units, weights=None): self.weights = weights self.layer_units = layer_units def init_weights(self, eps=1e-4): self.weights = init_weights(self.layer_units, eps=eps) return self.weights def fit(self, X, y, X_val, y_val, reg=0.0, optimizer='L-BFGS-B', max_iters=100, verbose=False): epoch = 0 best_val_acc = 0.0 best_weights = {} input_size, n_train = X.shape n_classes = np.max(y) + 1 # assume y takes values 0...K-1 where K is number of classes if self.weights is None: # lazily initialize weights self.weights = init_weights(self.layer_units) # Solve with L-BFGS-B options = {'maxiter': max_iters, 'disp': verbose} def J(theta): weights = pack_struct(theta, self.layer_units) loss, grad = softmax_loss(weights, X, y, reg) grad = flatten_struct(grad) return loss, grad # Callback to get accuracies based on training / validation sets iter_feval = 0 loss_history = [] train_acc_history = [] val_acc_history = [] def progress(x): nonlocal iter_feval, best_weights, best_val_acc iter_feval += 1 # Loss history weights = pack_struct(x, self.layer_units) loss, grad = softmax_loss(weights, X, y, reg) loss_history.append(loss) # Training accurary y_pred_train = softmax_predict(weights, X) train_acc = np.mean(y_pred_train == y) train_acc_history.append(train_acc) # Validation accuracy y_pred_val= softmax_predict(weights, X_val) val_acc = np.mean(y_pred_val == y_val) val_acc_history.append(val_acc) # Keep track of the best weights based on validation accuracy if val_acc > best_val_acc: best_val_acc = val_acc n_weights = len(weights) best_weights = [{} for i in range(n_weights)] for i in range(n_weights): for p in weights[i]: best_weights[i][p] = weights[i][p].copy() n_iters_verbose = max_iters / 20 if iter_feval % n_iters_verbose == 0: print(\"iter: {:4d}, loss: {:8f}, train_acc: {:4f}, val_acc: {:4f}\".format(iter_feval, loss, train_acc, val_acc)) # Minimize the loss function init_theta = flatten_struct(self.weights) results = scipy.optimize.minimize(J, init_theta, method=optimizer, jac=True, callback=progress, options=options) # Save weights self.weights = best_weights return self.weights, loss_history, train_acc_history, val_acc_history def predict(self, X): \"\"\" X: the N x M input matrix, where each column data[:, i] corresponds to a single test set pred: the predicted results. \"\"\" pred = softmax_predict(self.weights, X) return pred def flatten_struct(self, data): return flatten_struct(data) def pack_struct(self, data): return pack_struct(data, self.layer_units) def get_weights(self): return self.weights def softmax_loss(weights, X, y, reg): \"\"\" Compute the loss and derivative. theta: weight matrix X: the N x M input matrix, where each column data[:, i] corresponds to a single test set y: labels corresponding to the input data \"\"\" # Small constant used to avoid numerical problem eps = 1e-10 # Weighting parameters W0 = weights[0]['W'] b0 = weights[0]['b'] # Number of samples m = X.shape[1] # Forward pass a0 = X # Input activation z1 = W0.dot(a0) + b0.reshape((-1, 1)) z1_max = np.max(z1, axis=0) z1 -= z1_max # Avoid numerical problem due to large values of exp(z1) proba = np.exp(z1) / np.sum(np.exp(z1), axis=0) + eps # Add eps to avoid this value too close to zero # Target matrix of labels target = to_binary_class_matrix(y) # Cost function cost = -1.0/m * np.sum(target* np.log(proba)) + 0.5*reg*np.sum(W0*W0) # Gradients delta1 = -1.0 * (target - proba) grad = [{}] grad[0]['W'] = delta1.dot(a0.T)/m + reg*W0 grad[0]['b'] = np.mean(delta1, axis=1) return cost, grad def softmax_predict(weights, X): \"\"\" weights: weights trained using softmax_train X: the test matrix, where each column X[:, i] corresponds to a single test set pred: the prediction array. \"\"\" # Small constant used to avoid numerical problem eps = 1e-10 # Weighting parameters W0 = weights[0]['W'] b0 = weights[0]['b'] # Number of samples m = X.shape[1] # Forward pass a0 = X # Input activation z1 = W0.dot(a0) + b0.reshape((-1, 1)) # Propabilities z1_max = np.max(z1, axis=0) z1 -= z1_max # Avoid numerical problem due to large values of exp(z1) proba = np.exp(z1) / np.sum(np.exp(z1), axis=0) + eps # Add eps to avoid this value too close to zero # Predictions pred = np.argmax(proba, axis=0) return pred def init_weights(layer_units, eps=1e-4): \"\"\" Initialize weights. layer_units: tuple stores the size of each layer. weights: structured weights. \"\"\" assert len(layer_units) == 2 weights = [{}] weights[0]['W'] = eps * np.random.randn(layer_units[1], layer_units[0]) weights[0]['b'] = np.zeros(layer_units[1]) return weights def rel_err_gradients(): \"\"\" Return the relative error between analytic gradients and nemerical ones. \"\"\" # Number of layer units input_size = 4 * 4 hidden_size = 4 n_classes = 10 layer_units = (input_size, n_classes) X_train = np.random.randn(input_size, 100) y_train = np.random.randint(n_classes, size=100) reg = 1e-4 # Define the classifier clf = Softmax(layer_units) # Initialize weights weights = clf.init_weights() # Analytic gradients of the cost function cost, grad = softmax_loss(weights, X_train, y_train, reg) grad = clf.flatten_struct(grad) # Flattened gradients def J(theta): # Structured weights weights = clf.pack_struct(theta) return softmax_loss(weights, X_train, y_train, reg)[0] theta = clf.flatten_struct(weights) numerical_grad = eval_numerical_gradient(J, theta) # Compare numerically computed gradients with those computed analytically rel_err = rel_norm_diff(numerical_grad, grad) return rel_err In case you are interested in all codes related in this demonstration, please check the repository .","url":"http://tsaith.github.io/implement-softmax-regression-for-digit-recognition.html"},{"tags":"Machine learning","title":"Implement a neural network for digit recognition","text":"This post will demonstrate how to implement a three-layers neural network for digit recognition. The detailed derivations of algorithm can be found from my script . Main workflow Preparing training/validation/testing datasets. Set the weight decay / numerical parameters. Check if the gradients of the loss function are correct. Training model. Estimate the accuracy of prediction. Ipython notebook In [1]: % load_ext autoreload % autoreload 2 % matplotlib inline import numpy as np import matplotlib.pyplot as plt from dnn_play.classifiers.neural_net import NeuralNet , neural_net_loss , rel_err_gradients from dnn_play.utils.data_utils import load_mnist from dnn_play.utils.visualize_utils import display_network # Plot settings plt . rcParams [ 'figure.figsize' ] = ( 10.0 , 10.0 ) # set default size of plots plt . rcParams [ 'image.interpolation' ] = 'nearest' In [2]: # Load MNIST data ( X_train , y_train ), ( X_val , y_val ), ( X_test , y_test ) = load_mnist () #(X_train, y_train), (X_val, y_val), (X_test, y_test) = load_mnist(n_train=5500, n_val=500, n_test=1000) print ( \"X_train shape = {} y_train shape = {}\" . format ( X_train . shape , y_train . shape )) print ( \"X_val shape = {} y_val shape = {}\" . format ( X_val . shape , y_val . shape )) print ( \"X_test shape = {} y_test shape = {}\" . format ( X_test . shape , y_test . shape )) X_train shape = (784, 55000) y_train shape = (55000,) X_val shape = (784, 5000) y_val shape = (5000,) X_test shape = (784, 10000) y_test shape = (10000,) In [3]: # Number of layer units input_size = X_train . shape [ 0 ] # Dimension of features hidden_size = 28 n_classes = np . max ( y_train ) + 1 layer_units = (( input_size , hidden_size , n_classes )) # Hyperparameters reg = 1 e - 4 # Regulation, weight decay # Numerical parameters max_iters = 400 # Initialize weights clf = NeuralNet ( layer_units ) weights = clf . init_weights () loss , grad = neural_net_loss ( weights , X_train , y_train , reg ) print ( 'loss: %f' % loss ) loss: 1.249960 In [4]: # Gradient checking if rel_err_gradients () < 1 e - 8 : print ( \"Gradient check passed!\" ) else : print ( \"Gradient check failed!\" ) Gradient check passed! In [5]: \"\"\" Training \"\"\" weights , loss_history , train_acc_history , val_acc_history = clf . fit ( X_train , y_train , X_val , y_val , reg = reg , max_iters = max_iters , verbose = True ) iter: 20, loss: 0.419866, train_acc: 0.271382, val_acc: 0.275600 iter: 40, loss: 0.227288, train_acc: 0.701836, val_acc: 0.721800 iter: 60, loss: 0.146925, train_acc: 0.830582, val_acc: 0.853400 iter: 80, loss: 0.125238, train_acc: 0.852873, val_acc: 0.867800 iter: 100, loss: 0.096621, train_acc: 0.925655, val_acc: 0.944400 iter: 120, loss: 0.084912, train_acc: 0.940091, val_acc: 0.952800 iter: 140, loss: 0.081210, train_acc: 0.947855, val_acc: 0.960000 iter: 160, loss: 0.079193, train_acc: 0.951855, val_acc: 0.961800 iter: 180, loss: 0.078076, train_acc: 0.954109, val_acc: 0.963200 iter: 200, loss: 0.077142, train_acc: 0.955709, val_acc: 0.964800 iter: 220, loss: 0.076304, train_acc: 0.957345, val_acc: 0.966200 iter: 240, loss: 0.075594, train_acc: 0.958964, val_acc: 0.968400 iter: 260, loss: 0.075044, train_acc: 0.959473, val_acc: 0.968200 iter: 280, loss: 0.074649, train_acc: 0.960309, val_acc: 0.967000 iter: 300, loss: 0.074324, train_acc: 0.960764, val_acc: 0.968000 iter: 320, loss: 0.074067, train_acc: 0.961273, val_acc: 0.969000 iter: 340, loss: 0.073854, train_acc: 0.961636, val_acc: 0.968200 iter: 360, loss: 0.073678, train_acc: 0.961764, val_acc: 0.968800 iter: 380, loss: 0.073546, train_acc: 0.962364, val_acc: 0.969600 iter: 400, loss: 0.073417, train_acc: 0.962582, val_acc: 0.968200 In [6]: # Plot the loss function and train / validation accuracies plt . subplot ( 2 , 1 , 1 ) plt . plot ( loss_history ) plt . title ( 'Loss history' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Loss' ) plt . subplot ( 2 , 1 , 2 ) plt . plot ( train_acc_history ) plt . plot ( val_acc_history ) plt . legend ([ 'Training accuracy' , 'Validation accuracy' ], loc = 'lower right' ) plt . xlabel ( 'Iteration' ) plt . ylabel ( 'Clasification accuracy' ) Out[6]: <matplotlib.text.Text at 0x1137ca390> In [7]: # Visualize the weights W0 = weights [ 0 ][ 'W' ] image = display_network ( W0 . T ) plt . imshow ( image , cmap = plt . cm . gray ) Out[7]: <matplotlib.image.AxesImage at 0x11381e400> In [8]: # Make predictions pred = clf . predict ( X_test ) acc = np . mean ( y_test == pred ) print ( \"Accuracy: {:5.2f}% \\n \" . format ( acc * 100 )) Accuracy: 95.87% In [9]: # View some images and predictions n_images = 3 images = X_test [:, : n_images ] . reshape (( 28 , 28 , n_images )) pred = clf . predict ( X_test [:, : n_images ]) for i in range ( n_images ): plt . subplot ( 1 , n_images , i + 1 ) plt . imshow ( images [:, :, i ], cmap = plt . cm . gray ) plt . title ( 'Predicted digit: {}' . format ( pred [ i ])) plt . axis ( 'off' ) NeuralNet classifier import numpy as np import scipy.optimize from dnn_play.activations import sigmoid, sigmoid_deriv from dnn_play.utils.np_utils import to_binary_class_matrix, flatten_struct, pack_struct from dnn_play.utils.gradient_utils import eval_numerical_gradient, rel_norm_diff def ac_func(x): return sigmoid(x) def ac_func_deriv(x): return sigmoid_deriv(x) class NeuralNet(object): \"\"\" Classifier of the neural network. \"\"\" def __init__(self, layer_units, weights=None): self.weights = weights self.layer_units = layer_units def init_weights(self, eps=1e-4): \"\"\" Initialize weights. layer_units: tuple stores the size of each layer. weights: structured weights. \"\"\" layer_units = self.layer_units n_layers = len(layer_units) weights = [{} for i in range(n_layers - 1)] for i in range(n_layers - 1): weights[i]['W'] = eps * np.random.randn(layer_units[i+1], layer_units[i]) weights[i]['b'] = np.zeros(layer_units[i+1]) self.weights = weights return self.weights def fit(self, X, y, X_val, y_val, reg=0.0, learning_rate=1e-2, optimizer='L-BFGS-B', max_iters=100, sample_batches=True, n_epochs=30, batch_size=128, verbose=False): epoch = 0 best_val_acc = 0.0 best_weights = {} input_size, n_train = X.shape n_classes = np.max(y) + 1 # assume y takes values 0...K-1 where K is number of classes if self.weights is None: # lazily initialize weights self.weights = self.init_weights() # Solve with L-BFGS-B options = {'maxiter': max_iters, 'disp': verbose} def J(theta): weights = pack_struct(theta, self.layer_units) loss, grad = neural_net_loss(weights, X, y, reg) grad = flatten_struct(grad) return loss, grad # Callback to get accuracies based on training / validation sets iter_feval = 0 loss_history = [] train_acc_history = [] val_acc_history = [] def progress(x): nonlocal iter_feval, best_weights, best_val_acc iter_feval += 1 # Loss history weights = pack_struct(x, self.layer_units) loss, grad = neural_net_loss(weights, X, y, reg) loss_history.append(loss) # Training accurary y_pred_train = neural_net_predict(weights, X) train_acc = np.mean(y_pred_train == y) train_acc_history.append(train_acc) # Validation accuracy y_pred_val= neural_net_predict(weights, X_val) val_acc = np.mean(y_pred_val == y_val) val_acc_history.append(val_acc) # Keep track of the best weights based on validation accuracy if val_acc > best_val_acc: best_val_acc = val_acc n_weights = len(weights) best_weights = [{} for i in range(n_weights)] for i in range(n_weights): for p in weights[i]: best_weights[i][p] = weights[i][p].copy() n_iters_verbose = max_iters / 20 if iter_feval % n_iters_verbose == 0: print(\"iter: {:4d}, loss: {:8f}, train_acc: {:4f}, val_acc: {:4f}\".format(iter_feval, loss, train_acc, val_acc)) # Minimize the loss function init_theta = flatten_struct(self.weights) results = scipy.optimize.minimize(J, init_theta, method=optimizer, jac=True, callback=progress, options=options) # Save weights self.weights = best_weights return self.weights, loss_history, train_acc_history, val_acc_history def predict(self, X): \"\"\" X: the N x M input matrix, where each column data[:, i] corresponds to a single test set pred: the predicted results. \"\"\" pred = neural_net_predict(self.weights, X) return pred def flatten_struct(self, data): return flatten_struct(data) def pack_struct(self, data): return pack_struct(data, self.layer_units) def neural_net_loss(weights, X, y, reg): \"\"\" Compute loss and gradients of the neutral network. \"\"\" Y = to_binary_class_matrix(y) L = len(weights) # The index of the output layer z = [] a = [] # Number of samples m = X.shape[1] # Forward pass z.append(0) # Dummy element a.append(X) # Input activation for i in range(0, L): W = weights[i]['W'] b = weights[i]['b'] z.append(W.dot(a[-1]) + b.reshape((-1, 1))) a.append(ac_func(z[-1])) # Cost function sum_weight_square = 0.0 # Sum of weight square for i in range(L): W = weights[i]['W'] sum_weight_square += np.sum(W*W) cost = 1.0/(2.0*m) * np.sum((a[-1] - Y)**2) + 0.5*reg*sum_weight_square # Backpropagation delta = [(a[-1] - Y) * ac_func_deriv(z[-1])] for i in reversed(range(L)): # Note that delta[0] will not be used W = weights[i]['W'] d = W.T.dot(delta[0]) * ac_func_deriv(z[i]) delta.insert(0, d) # Insert element at beginning # Gradients grad = [{} for i in range(L)] for i in range(L): W = weights[i]['W'] grad[i]['W'] = delta[i+1].dot(a[i].T) / m + reg*W grad[i]['b'] = np.mean(delta[i+1], axis=1) return cost, grad def neural_net_predict(weights, X): \"\"\" X: the N x M input matrix, where each column data[:, i] corresponds to a single test set pred: the predicted results. \"\"\" L = len(weights) # The index of the output layer z = [] a = [] # Number of samples m = X.shape[1] # Forward pass z.append(0) # Dummy element a.append(X) # Input activation for i in range(0, L): W = weights[i]['W'] b = weights[i]['b'] z.append(W.dot(a[-1]) + b.reshape((-1, 1))) a.append(ac_func(z[-1])) # Predictions pred = np.argmax(a[-1], axis=0) return pred def rel_err_gradients(): \"\"\" Return the relative error between analytic and nemerical gradients. \"\"\" # Number of layer units input_size = 4 * 4 hidden_size = 4 n_classes = 10 layer_units = (input_size, hidden_size, n_classes) X_train = np.random.randn(input_size, 100) y_train = np.random.randint(n_classes, size=100) reg = 1e-4 # Define the classifier clf = NeuralNet(layer_units) # Initialize weights weights = clf.init_weights() # Analytic gradients of the cost function cost, grad = neural_net_loss(weights, X_train, y_train, reg) grad = clf.flatten_struct(grad) # Flattened gradients def J(theta): # Structured weights weights = clf.pack_struct(theta) return neural_net_loss(weights, X_train, y_train, reg)[0] theta = clf.flatten_struct(weights) numerical_grad = eval_numerical_gradient(J, theta) # Compare numerically computed gradients with those computed analytically rel_err = rel_norm_diff(numerical_grad, grad) return rel_err In case you are interested in all codes related in this demonstration, please check the repository .","url":"http://tsaith.github.io/implement-a-neural-network-for-digit-recognition.html"},{"tags":"Machine learning","title":"Install Theano and CUDA Toolkit 7.5 on OSX","text":"This post describes the steps I used to install Theano on my Mac (OSX 10.9.5) with NVIDIA GeForce GTX 660M graphics card. Install Theano Please use pip to install Theano as below $ pip install Theano Then, create the ~/.theanorc with content as [global] mode = FAST_RUN floatX = float32 device = gpu [nvcc] fastmath = True Install CUDA Toolkit Download the package of CUDA Toolkit 7.5 from the official link . Install cuDNN Next, we have to register on NVIDIA to be able to download cuDNN , which is a GPU-accelerated library of primitives for deep neural networks. After downloading, please uncompress the package and copy the header file and libraries to include and lib under the root directory of CUDA Toolkit (e.g. /usr/local/cuda), respectively. $ tar xzf cudnn-7.0-osx-x64-v3.0-prod.tgz $ cd cuda $ sudo cp include/cudnn.h /usr/local/cuda/include/ $ sudo cp lib/libcudnn* /usr/local/cuda/lib/ Add environment variables Add the following environment variables to ~/.bash_profile . # Theano export CUDA_ROOT=\"/usr/local/cuda\" export THEANO_FLAGS=\"mode=FAST_RUN,device=gpu,floatX=float32\" # CUDA export LD_LIBRARY_PATH=\" $ CUDA_ROOT /lib: $ LD_LIBRARY_PATH \" export PATH=\" $ CUDA_ROOT /bin: $ PATH \" You may want to execute source ~/.bash_profile to validate the settings right away. Testing Now, we can run a test code to see if the Theano works as expected. test.py: from theano import function , config , shared , sandbox import theano.tensor as T import numpy import time vlen = 10 * 30 * 768 # 10 x #cores x # threads per core iters = 1000 rng = numpy . random . RandomState ( 22 ) x = shared ( numpy . asarray ( rng . rand ( vlen ), config . floatX )) f = function ([], T . exp ( x )) print ( f . maker . fgraph . toposort ()) t0 = time . time () for i in range ( iters ): r = f () t1 = time . time () print ( \"Looping %d times took %f seconds\" % ( iters , t1 - t0 )) print ( \"Result is %s \" % ( r ,)) if numpy . any ([ isinstance ( x . op , T . Elemwise ) for x in f . maker . fgraph . toposort ()]): print ( 'Used the cpu' ) else : print ( 'Used the gpu' ) Let's run this code on CPU and GPU, separately. CPU case: $ THEANO_FLAGS = 'device=cpu' python test.py [ Elemwise { exp,no_inplace }( <TensorType ( float32, vector ) > )] Looping 1000 times took 14.474722 seconds Result is [ 1.23178029 1.61879337 1.52278066 ..., 2.20771813 2.29967761 1.62323284 ] Used the cpu GPU case: $ THEANO_FLAGS = 'device=gpu' python test.py Using gpu device 0: GeForce GTX 660M ( CNMeM is disabled ) [ GpuElemwise { exp,no_inplace }( <CudaNdarrayType ( float32, vector ) > ) , HostFromGpu ( GpuElemwise { exp,no_inplace } .0 )] Looping 1000 times took 0.517552 seconds Result is [ 1.23178029 1.61879349 1.52278066 ..., 2.20771813 2.29967761 1.62323296 ] Used the gpu Please note that Theano will have to compile the python code to generate C++/CUDA code when executing with GPU for the first time. Thus, the results shown above came from the execution of the second time. Finally, it can be observed that the runtime is greatly reduced when GPU is used : )","url":"http://tsaith.github.io/install-theano-and-cuda-toolkit-75-on-osx.html"},{"tags":"Machine learning","title":"Implement the exercises of UFLDL Tutorial with python 3","text":"In recent years, deep learning has received more and more attention and is applied to many things in our daily life. Thus, I decide to dig into this powerful technology by self-teaching. Last month, I started to study UFLDL Tutorial which is an excellent learning material contributed by Andrew Ng . I really like his way to explain concepts and appreciate his generosity to carefully prepare the online courses. In UFLDL Tutorial, the exercises are originally supposed to be done with Matlab. However, I have no Matlab license. Thus, I chose python (with version 3.4) to implement those exercises. The codes and related introduction can be found here .","url":"http://tsaith.github.io/implement-the-exercises-of-ufldl-tutorial-with-python-3.html"},{"tags":"Machine learning","title":"A quick demo on face detection with python 3 and opencv 3","text":"Here, I record how to write a simple code for face detection with Harr-like features, which is based on python 3 and opencv 3. The script face_detector_haar.py below is just slightly modified from the post written by Shantnu Tiwari. face_detector_haar.py: import cv2 # OpenCV import sys # Input image image_path = sys . argv [ 1 ] # Model parameters dir_path = \"/usr/local/Cellar/opencv3/3.0.0/share/OpenCV/haarcascades\" # Please modify this for your environment filename = \"haarcascade_frontalface_default.xml\" # for frontal faces #filename = \"haarcascade_profileface.xml\" # for profile faces model_path = dir_path + \"/\" + filename # Create the classifier clf = cv2 . CascadeClassifier ( model_path ) # Read the image image = cv2 . imread ( image_path ) gray = cv2 . cvtColor ( image , cv2 . COLOR_BGR2GRAY ) # Detect faces on image faces = clf . detectMultiScale ( gray , scaleFactor = 1.1 , minNeighbors = 5 , minSize = ( 30 , 30 ), flags = cv2 . CASCADE_SCALE_IMAGE ) print ( \"Found {0} faces!\" . format ( len ( faces ))) # Draw a rectangle around the faces for ( x , y , w , h ) in faces : cv2 . rectangle ( image , ( x , y ), ( x + w , y + h ), ( 0 , 255 , 0 ), 2 ) cv2 . imshow ( \"Faces found\" , image ) cv2 . waitKey ( 0 ) Please make sure the model_path in code is correctly set when considering your OpenCV environment. The haarcascade_frontalface_default.xml and haarcascade_profileface.xml are the model files of frontal and profile face detection, respectively. To execute the script: python3 face_detector_haar.py photo.jpg Some results are demonstrated as following.","url":"http://tsaith.github.io/a-quick-demo-on-face-detection-with-python-3-and-opencv-3.html"},{"tags":"Machine learning","title":"A Python binding of Compressive Tracking","text":"Recently I read an interesting paper \"Real-time Compressive Tracking\" which applied compressive sensing on object tracking to dramatically reduce the calculations and showed remarkable results. Kaihua Zhang (the author) kindly had released the source code(both Matlab and C++ versions) of the algorithm on his webpage . A python binding Personally I prefer to test algorithms with python, hence, I have tried to build a python binding of compressive tracking and tested it on my Mac. Some results are as below: Kitesurf Bolt and the source code can be found from this link . More details This section will describe the main steps how I wrapped the C++ version of compressive tracking as the python binding and is not important in the aspect of usage. In case you are interested in the procedures, please keep reading. The class CompressiveTracker in compressive_tracker.cpp provides two public methods init(Mat& _frame, Rect& _objectBox) and processFrame(Mat& _frame, Rect& _objectBox) , where _frame and _objectBox are the video frame and object box, respectively. I added two public methods init_wrap(vector<vector<uint8> > &_frame, vector<int> &_object_box) and process_frame_wrap(vector<vector<uint8> > &_frame, vector<int> &_object_box) to wrap the methods init and processFrame , which expect vector array arguments instead of Mat or Rect ones. Next, the cython files wrap.pxd and wrap.pyx were created to wrap the C++ class CompressiveTracker into the Python class CyCompressiveTracker . Besides, setup.py was added for compilation. Finally, run.py is the testing code which will load the python binding for object tracking. Frankly speaking, the existences of init_wrap and process_frame_wrap come from that I don't know how to use cython to directly convert numpy array into Mat or Rect instances of OpenCv. I will grateful if someone can show me how to do that : )","url":"http://tsaith.github.io/a-python-binding-of-compressive-tracking.html"},{"tags":"Machine learning","title":"Combine images into a video with Python 3 and OpenCv 3","text":"Here, we will inspect a python script (named tk-img2video ) which will combine images into a video. tk-img2video: #!/usr/local/bin/python3 import cv2 import argparse import os # Construct the argument parser and parse the arguments ap = argparse . ArgumentParser () ap . add_argument ( \"-ext\" , \"--extension\" , required = False , default = 'png' , help = \"extension name. default is 'png'.\" ) ap . add_argument ( \"-o\" , \"--output\" , required = False , default = 'output.mp4' , help = \"output video file\" ) args = vars ( ap . parse_args ()) # Arguments dir_path = '.' ext = args [ 'extension' ] output = args [ 'output' ] images = [] for f in os . listdir ( dir_path ): if f . endswith ( ext ): images . append ( f ) # Determine the width and height from the first image image_path = os . path . join ( dir_path , images [ 0 ]) frame = cv2 . imread ( image_path ) cv2 . imshow ( 'video' , frame ) height , width , channels = frame . shape # Define the codec and create VideoWriter object fourcc = cv2 . VideoWriter_fourcc ( * 'mp4v' ) # Be sure to use lower case out = cv2 . VideoWriter ( output , fourcc , 20.0 , ( width , height )) for image in images : image_path = os . path . join ( dir_path , image ) frame = cv2 . imread ( image_path ) out . write ( frame ) # Write out frame to video cv2 . imshow ( 'video' , frame ) if ( cv2 . waitKey ( 1 ) & 0xFF ) == ord ( 'q' ): # Hit `q` to exit break # Release everything if job is finished out . release () cv2 . destroyAllWindows () print ( \"The output video is {}\" . format ( output )) Sample usage: tk-img2video -ext png -o output.mp4 It will combine all images with png file extension into a video file named output.mp4 .","url":"http://tsaith.github.io/combine-images-into-a-video-with-python-3-and-opencv-3.html"},{"tags":"Machine learning","title":"Write a python script to define the detecting region by clicking and dragging mouse","text":"In object tracking, usually, we need to define a rectangular box which contains the object of interest and obtain the box information as follows. Box: (80, 86, 263, 312) where (80, 86) is the upper-left point of box. The 263 and 312 are the width and height, respectively. And this work can be done by writing a simple script (named tk-detect-box ) as below. tk-detect-box: #!/usr/local/bin/python3 import cv2 import argparse import os class Rect : def __init__ ( self , x , y , width , height ): self . x = x self . y = x self . width = width self . height = height def detect_box ( image , win_name = \"window (hit q to exit)\" ): # Return a box for detection box_defined = False box = Rect ( 0 , 0 , 0 , 0 ) def define_box ( event , x , y , flags , param ): nonlocal box_defined , box if event == cv2 . EVENT_LBUTTONDOWN : box_defined = False box . x = x box . y = y box . width = 0 box . height = 0 if event == cv2 . EVENT_MOUSEMOVE : if not box_defined : box . width = x - box . x box . height = y - box . y if event == cv2 . EVENT_LBUTTONUP : box_defined = True def do_nothing ( event , x , y , flags , param ): pass # set mouse callback cv2 . setMouseCallback ( win_name , define_box ) while True : # display the frame from video capture clone = image . copy () if box . x > 0 and box . width > 0 : # Starting and ending point of the rectangle p0 = ( box . x , box . y ) p1 = ( box . x + box . width , box . y + box . height ) cv2 . rectangle ( clone , p0 , p1 , ( 0 , 255 , 0 ), thickness = 2 ) cv2 . imshow ( win_name , clone ) if ( cv2 . waitKey ( 1 ) & 0xFF ) == ord ( 'q' ): # Hit `q` to exit break # Set a mouse callback which does nothing cv2 . setMouseCallback ( win_name , do_nothing ) return box # Construct the argument parser and parse the arguments ap = argparse . ArgumentParser () ap . add_argument ( \"-i\" , \"--image\" , required = True , help = \"image path.\" ) args = vars ( ap . parse_args ()) # Arguments image_path = args [ 'image' ] # Determine the width and height from the first image image = cv2 . imread ( image_path ) # Create a window win_name = 'window (hit q to exit)' cv2 . namedWindow ( win_name ) # Define the detecting box box = detect_box ( image , win_name ) # Output box information print ( \"Box: ({}, {}, {}, {}) \" . format ( box . x , box . y , box . width , box . height )) cv2 . destroyAllWindows () { % endcodeblock % } The usage of this script is like tk-detect-box -i girl.png It will open the image and let you define a rectangular box by clicking and dragging the mouse. After hitting q and it will show out the box information.","url":"http://tsaith.github.io/write-a-python-script-to-define-the-detecting-region-by-clicking-and-dragging-mouse.html"},{"tags":"Machine learning","title":"Define a detection window on image with mouse through Python 3 and OpenCV 3","text":"For image recognition or object tracking, we often need to define a target window to locate the area interested as below. In this post, I would like to demonstrate how to use a mouse to define a rectangular window on the image with python 3 and OpenCV 3. The following sample code named target_win.py , which is slightly modified from the code in a great post written by Adrian Rosebrock. It shows an image for you to define a rectangular region as the target window with your mouse. After hitting the key c to confirm your selection, it will write out the starting and ending points of the target window. target_win.py: import cv2 from skimage import data def define_rect ( image ): \"\"\" Define a rectangular window by click and drag your mouse. Parameters ---------- image: Input image. \"\"\" clone = image . copy () rect_pts = [] # Starting and ending points win_name = \"image\" # Window name def select_points ( event , x , y , flags , param ): nonlocal rect_pts if event == cv2 . EVENT_LBUTTONDOWN : rect_pts = [( x , y )] if event == cv2 . EVENT_LBUTTONUP : rect_pts . append (( x , y )) # draw a rectangle around the region of interest cv2 . rectangle ( clone , rect_pts [ 0 ], rect_pts [ 1 ], ( 0 , 255 , 0 ), 2 ) cv2 . imshow ( win_name , clone ) cv2 . namedWindow ( win_name ) cv2 . setMouseCallback ( win_name , select_points ) while True : # display the image and wait for a keypress cv2 . imshow ( win_name , clone ) key = cv2 . waitKey ( 0 ) & 0xFF if key == ord ( \"r\" ): # Hit 'r' to replot the image clone = image . copy () elif key == ord ( \"c\" ): # Hit 'c' to confirm the selection break # close the open windows cv2 . destroyWindow ( win_name ) return rect_pts # Prepare an image for testing lena = data . lena () # A image array with RGB color channels lena = cv2 . cvtColor ( lena , cv2 . COLOR_BGR2RGB ) # Convert RGB to BGR # Points of the target window points = define_rect ( lena ) print ( \"--- target window ---\" ) print ( \"Starting point is \" , points [ 0 ]) print ( \"Ending point is \" , points [ 1 ]) In case you haven't installed skimage which is a useful library for image processing in python, it can be installed by executing pip3 install scikit-image","url":"http://tsaith.github.io/define-a-detection-window-on-image-with-mouse-through-python-3-and-opencv-3.html"},{"tags":"Machine learning","title":"Record video with Python 3 + OpenCV 3 on OSX","text":"This simple example will demonstrate how to use python + OpenCV 3 to capture frames from the webcam and save them as a video file of mp4 format on your Mac. import numpy as np import cv2 cap = cv2 . VideoCapture ( 0 ) # Capture video from camera # Get the width and height of frame width = int ( cap . get ( cv2 . CAP_PROP_FRAME_WIDTH ) + 0.5 ) height = int ( cap . get ( cv2 . CAP_PROP_FRAME_HEIGHT ) + 0.5 ) # Define the codec and create VideoWriter object fourcc = cv2 . VideoWriter_fourcc ( * 'mp4v' ) # Be sure to use the lower case out = cv2 . VideoWriter ( 'output.mp4' , fourcc , 20.0 , ( width , height )) while ( cap . isOpened ()): ret , frame = cap . read () if ret == True : frame = cv2 . flip ( frame , 0 ) # write the flipped frame out . write ( frame ) cv2 . imshow ( 'frame' , frame ) if ( cv2 . waitKey ( 1 ) & 0xFF ) == ord ( 'q' ): # Hit `q` to exit break else : break # Release everything if job is finished out . release () cap . release () cv2 . destroyAllWindows () After running the code, you should see a pop-up window displaying the flipped video captured by your webcam. Just hit the key q to terminate the execution.","url":"http://tsaith.github.io/record-video-with-python-3-opencv-3-on-osx.html"},{"tags":"Misc","title":"Manage project packages with virtualenv","text":"While developing two or more projects at the same time, it is unavoidable to switch among projects which may use the same python package of different version. In order to resolve the headache of package management, virtualenv is designed to create isolated python environments. Install virtualenv Open your terminal and execute pip3 install virtualenv virtualenvwrapper where virtualenvwrapper is a set of extension of virtualenv . Set environment variables In ~/.profile , add the lines below : export VIRTUALENVWRAPPER_PYTHON=/usr/local/bin/python3 export WORKON_HOME= $ HOME /.virtualenvs source /usr/local/bin/virtualenvwrapper.sh Followed by reloading ~/.profile : source ~/.profile Some examples of usage To create a new project environment named vision with python 3.4 support : $ mkvirtualenv -p /usr/local/bin/python3.4 vision In case we want to install ipython under vision environment : pip install ipython[notebook] To leave the environment of current project : deactivate To work on a existed project : workon project_name","url":"http://tsaith.github.io/manage-project-packages-with-virtualenv.html"},{"tags":"Machine learning","title":"Install OpenCV 3 for Python 3 on OSX","text":"First, install OpenCV 3 with homebrew as brew install opencv3 --with-python3 --with-contrib with --with-contrib flag, opencv_contrib packages containing algorithms that are either patented or in experimental development will also be installed. Second, set the environment variable PYTHONPATH to include the path of cv2.so which is a python binding to OpenCV. There are several ways to set PYTHONPATH , one way is to add the following line to ~/.profile . export PYTHONPATH= $ PYTHONPATH :/usr/local/Cellar/opencv3/3.0.0/lib/python3.4/site-packages Please note that the name of python directry depends on which python version you use, in my case is python3.4 . Be sure to execute source ~/.profile or restart your terminal to update PYTHONPATH . Now, let's check if our python 3 can import the module of OpenCV in the terminal. $ python3 Python 3.4 . 3 ( default , Jun 10 2015 , 19 : 57 : 30 ) [ GCC 4.2 . 1 Compatible Apple LLVM 6.0 ( clang - 600.0 . 57 )] on darwin Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> import cv2 >>> cv2 . __version__ '3.0.0'","url":"http://tsaith.github.io/install-opencv-3-for-python-3-on-osx.html"},{"tags":"Machine learning","title":"A quick demo to recognizing hand-written digits with logistic regression","text":"This article will quickly demonstrate how to use the Logistic regression to recognize hand-written digits. The scikit-learn package is required in the example shown later. If you haven't installed it, please executing pip install scikit-learn and make sure that your IPython is ready to go. In this example, we want to fit a model of logistic regression with training data and labels. After that, the model can be used to predict the label corresponding to each instance of testing data. % matplotlib inline import matplotlib.pyplot as plt from sklearn import datasets , linear_model digits = datasets . load_digits () train_set_x = digits . data [: - 10 , :] # Training set x train_set_y = digits . target [: - 10 ] # Training set y (labels) test_set_x = digits . data [ - 10 :, :] # Test set x test_set_y = digits . target [ - 10 :] # Test set y (labels) test_set_images = digits . images [ - 10 :] # Test set images clf = linear_model . LogisticRegression () # Logistic regression clf . fit ( train_set_x , train_set_y ) # Fitting model predicted_y = clf . predict ( test_set_x ) print ( \"Predicted y = \" , predicted_y ) # Predicted labels print ( \"Test set y = \" , test_set_y ) # Expected labels plt . imshow ( test_set_images [ - 1 ], cmap = plt . cm . gray ) # Show the last image in the test set and the output is as As observed, the predicted labels are consistent with the expected ones. The last label is 8 as we see.","url":"http://tsaith.github.io/a-quick-demo-to-recognizing-hand-written-digits-with-logistic-regression.html"},{"tags":"Machine learning","title":"Automatically reload modules in IPython","text":"IPython provides an extension autoreload to reload the modules automatically. This is especially useful because we don't want to manually reload modules for testing when developing new functions. Just execute the following lines within IPython, all modules will be automatically reloaded before executing your code. % load_ext autoreload % autoreload 2","url":"http://tsaith.github.io/automatically-reload-modules-in-ipython.html"},{"tags":"Machine learning","title":"Visualize data with IPython","text":"This post will show how to visualize data with ipython. matplotlib install: pip install matplotlib With matplotlib , we are able to make inline plots by setting % matplotlib inline import matplotlib.pyplot as plt e.g. mpld3 install: pip install matplotlib With mpld3 , it is handy to zoom in/out or shift the plot through the lower left icons. To use mpld3, the following lines are required. import mpld3 mpld3 . enable_notebook () e.g.","url":"http://tsaith.github.io/visualize-data-with-ipython.html"},{"tags":"Machine learning","title":"Set up the python environment for computer vision","text":"Please install the following packages to set up the python environment for computer vision. Python The compiler of Python 3. brew install python3 Numpy A library for numerical calculation. pip install numpy Scipy A library for scientific computing. pip install scipy Matplotlib Powerful library to make plots. pip install matplotlib Ipython A browser-based notebook for interactive computing. pip install ipython[notebook] pip install pyzmq jinja2 tornado jsonschema mpld3 Ipdb IPython-enabled python debuger. pip install ipdb Scikit-learn Machine Learning library. pip install scikit-learn Scikit-image Image processing library. pip install scikit-image Pandas A library for data analysis. pip install pandas pytest A mature full-featured Python testing tool. pip install pytest","url":"http://tsaith.github.io/set-up-the-python-environment-for-computer-vision.html"},{"tags":"Web","title":"Create an IAM user for ElasticBeanstalk","text":"To use AWS ElasticBeanstalk , we have to create a IAM user first. After logging in AWS, go to IAM under Services . Click Create New Group under Groups and specify a group name (here, assumed as ElasticBeanstalkFullAccess ). Attach policy AWSElasticBeanstalkFullAccess to the group ElasticBeanstalkFullAccess . Click Create New Users under Users to create a new user supposed to use ElasticBeanstalk. During the process, it will prompt you to download security credentials composed by AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY . Under Users , add the user to the group ElasticBeanstalkFullAccess . From now on, you should be able to use ElasticBeanstalk with the security credentials downloaded.","url":"http://tsaith.github.io/create-an-iam-user-for-elasticbeanstalk.html"},{"tags":"Web","title":"Set up a postgres-backed rails app with ElasticBeanstalk","text":"This article will describe the way I set up a Rails app with ElasticBeanstalk and PostgresSQL. Here Rails 4.1 based on Puma 2.10.2 and Nginx 1.6.2 is demonstrated. Install ElasticBeanstalk CLI AWS provides both Management Console and EB CLI to work with ElasticBeanstalk. The CLI requires python and is easier to perform some features of ElasticBeanstalk. pip install awsebcli Create an IAM user ElasticBeanstalk will require an IAM user to create app environment. In case you have no idea how to create an IAM user, please view this post . Initialize a git repository Here agileorder is the name of my app. $ cd agileorder $ git init $ git add -A $ git commit -m \"Initial commit\" Initialize EB environment $ eb init Select a default region 1 ) us-east-1 : US East ( N. Virginia ) 2 ) us-west-1 : US West ( N. California ) 3 ) us-west-2 : US West ( Oregon ) 4 ) eu-west-1 : EU ( Ireland ) 5 ) eu-central-1 : EU ( Frankfurt ) 6 ) ap-southeast-1 : Asia Pacific ( Singapore ) 7 ) ap-southeast-2 : Asia Pacific ( Sydney ) 8 ) ap-northeast-1 : Asia Pacific ( Tokyo ) 9 ) sa-east-1 : South America ( Sao Paulo ) ( default is 3 ) : 8 Select an application to use 1 ) [ Create new Application ] ( default is 1 ) : 1 Enter Application Name: agileorder It appears you are using Ruby. Is this correct? ( y/n ) : y Select a platform version. 1 ) Ruby 2.2 ( Puma ) 2 ) Ruby 2.1 ( Puma ) 3 ) Ruby 2.0 ( Puma ) 4 ) Ruby 2.2 ( Passenger Standalone ) 5 ) Ruby 2.1 ( Passenger Standalone ) 6 ) Ruby 2.0 ( Passenger Standalone ) 7 ) Ruby 1.9.3 ( default is 1 ) : 2 Do you want to set up SSH for your instances? ( y/n ) : n Please note that eb init will add .elasticbeanstalk to the .gitignore . Be sure to commit .gitignore once again. $ git add .gitignore $ git commit -m \"Update .gitignore\" Configure EB to install postgresql-devel Under project directory, create .ebextensions/packages.config with following content. {% codeblock .ebextensions/packages.config lang:yaml %} packages: yum: postgresql93-devel: [] Then add the .ebextensions to repository git add .ebextensions git commit -m \"Add .ebextensions\" Create environment $ eb create agileorder-env After waiting for a while, the last part of output messages are shown as INFO : Application available at agileorder - env - jmcrf7dbdr . elasticbeanstalk . com . ERROR : Create environment operation is complete , but with errors . For more information , see troubleshooting documentation . INFO : Adding instance 'i-72db7287' to your environment . After checking logs, I figured out the errors come from the missing environment variables used in my app. Set up environment variables Under Software Configuration of Elastic Beanstalk of AWS Management Console , add essential environments used in app like SECRET_KEY_BASE , SENTRY_DSN , ...etc. Create a RDS instance Under Data Tier of Elastic Beanstalk of AWS Management Console , create a new RDS database and set the DB engine to postgres . After setting Master Username and Master Password , then click Save , environment variables will have been added to EB environment automatically. Configure database.yml to work with RDS instance Under project directory, modify the database.yml as config/database.yml: ... skip the parts of development and test modes ... production : adapter : postgresql encoding : unicode database : <%= ENV['RDS_DB_NAME'] %> username : <%= ENV['RDS_USERNAME'] %> password : <%= ENV['RDS_PASSWORD'] %> host : <%= ENV['RDS_HOSTNAME'] %> port : <%= ENV['RDS_PORT'] %> Commit the database.yml to repository git add -A git commit -m \"Update database.yml\" Finally, deploy the app to AWS. eb deploy To open the app URL in a browser, simply execute eb open","url":"http://tsaith.github.io/set-up-a-postgres-backed-rails-app-with-elasticbeanstalk.html"},{"tags":"Web","title":"Wait for Ajax with Capybara Automatically","text":"While writing feature tests involved in Ajax, we have to resolve race condition from time to time. Let's see the following code as an example. spec/features/admin_deletes_product_spec.rb: require 'spec_helper.rb' feature \"Admin deletes product category\" , { js : true } do before { page . driver . allow_url ( \"fonts.googleapis.com\" ) } after { clear_email } scenario \"when the action is successful\" do category = Fabricate ( :product_category ) product = Fabricate ( :product , category : category ) cloud = Fabricate ( :admin ) sign_in ( cloud ) visit admin_products_path find ( \"a[id='delete_product_ #{ product . id } ']\" ) . click # Without this line, there will be a race condition between deleting product and database query wait_for_ajax expect ( Product . count ) . to eq 0 end end where the function wait_for_ajax is used to make sure the product has been deleted before querying the count of products in database. spec/support/wait_for_ajax.rb: module WaitForAjax def wait_for_ajax Timeout . timeout ( Capybara . default_wait_time ) do loop until finished_all_ajax_requests? end end def finished_all_ajax_requests? page . evaluate_script ( 'jQuery.active' ) . zero? end end More discussion about this issue can be found in Thoughtbot's post .","url":"http://tsaith.github.io/wait-for-ajax-with-capybara-automatically.html"},{"tags":"Misc","title":"Create a user account to deploy production on ubuntu","text":"On production server, it is a good practice to create a user account (named deployer ) which is supposed to take care jobs of deployment. The steps are described as following. Log in the server as root via ssh ssh SERVER_IP Add new user named deployer adduser deployer Add deployer to group sudo gpasswd -a deployer sudo Switch from root to deployer su -l deployer Create .ssh directory and set proper access permission mkdir ~/.ssh chmod 700 ~/.ssh Copy the content of id_rsa.pub and paste it to authorized_keys On local computer: cat ~/.ssh/id_rsa.pub | pbcopy On remote server: vi ~/.ssh/authorized_keys and paste the content of public key. Set proper access permission on authorized_keys chmod 600 .ssh/authorized_keys Return to root exit Disable root login through SSH vi /etc/ssh/sshd_config and modify the line of PermitRootLogin as PermitRootLogin no Restart SSH service ssh restart Open a new terminal on local computer and log in the server as deployer ssh deployer@SERVER_IP Let deployer can use sudo without password sudo visudo Add following line at the end of file deployer ALL=(ALL) NOPASSWD: ALL Execute Ctrl-x -> Y -> Enter to save and exit file.","url":"http://tsaith.github.io/create-a-user-account-to-deploy-production-on-ubuntu.html"},{"tags":"Web","title":"Install rbenv and rails on ubuntu","text":"This article will describe how to install rbenv , rails and some useful libraries on a production server of ubuntu . Assuming that, on a fresh ubuntu, we have just built and logged in with a user account named deployer . Update apt-get sudo apt-get update Install gcc, make and curl sudo apt-get install gcc make curl Install git sudo apt-get install git git-core Configure git git config --global user.name \"Your Name\" git config --global user.email \"Your Email Address\" git config --global core.editor vi git config --global color.ui true git config --global color.branch auto git config --global color.diff auto git config --global color.status auto Install libraries required by rbenv sudo apt-get install autoconf bison build-essential libssl-dev libyaml-dev libreadline6-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm3 libgdbm-dev Install rbenv and the ruby versions builder git clone git://github.com/sstephenson/rbenv.git .rbenv echo 'export PATH=\" $ HOME /.rbenv/bin: $ PATH \"' >> ~/.bashrc echo 'eval \" $( rbenv init - ) \"' >> ~/.bashrc git clone git://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build echo 'export PATH=\" $ HOME /.rbenv/plugins/ruby-build/bin: $ PATH \"' >> ~/.bashrc git clone https://github.com/sstephenson/rbenv-gem-rehash.git ~/.rbenv/plugins/rbenv-gem-rehash git clone https://github.com/ianheggie/rbenv-binstubs.git ~/.rbenv/plugins/rbenv-binstubs Add path for binstubs echo 'PATH=\"./bin: $ PATH \"' >> ~/.bashrc Relogin the server exit ssh deployer@SERVER_IP Install Ruby version rbenv install 2.1.5 rbenv global 2.1.5 Install bundler gem install bundler Install gems without documents echo 'gem: --no-rdoc --no-ri' >> ~/.gemrc Install rails gem install rails -v 4.1.1 Install Node.js (javascript runtime) which is required to compile assests of rails sudo apt-add-repository -y ppa:chris-lea/node.js sudo apt-get -y update sudo apt-get -y install nodejs Install qt lib for capybara-webkit [https://github.com/thoughtbot/capybara-webkit] sudo apt-get install libqt4-dev Install ImageMagick sudo apt-get install imagemagick Install PostgreSQL sudo apt-get install postgresql libpq-dev Execute the following command under project directory to make binstubs work bundle install --binstubs .bundle/bin Set environment variables sudo vi /etc/environment and add the following lines: RAILS_ENV=production RACK_ENV=production Create a new user named deployer as superuser within PostgreSQL sudo su -l postgres createuser deployer --pwprompt psql ALTER USER deployer WITH SUPERUSER; \\q exit","url":"http://tsaith.github.io/install-rbenv-and-rails-on-ubuntu.html"},{"tags":"Web","title":"Install Sidekiq and Redis on Ubuntu","text":"Sidekiq is a efficient tool to take care backgroud jobs of rails and reuired the support of Redis . Switch to root sudo su -l Install Redis apt-get install redis-server service redis-server restart Write a init script for Sidekiq Create /etc/init.d/sidekiq with following content: /etc/init.d/sidekiq: #!/bin/sh # File: /etc/init.d/sidekiq ### BEGIN INIT INFO # Provides: unicorn # Required-Start: $local_fs $remote_fs $network $syslog # Required-Stop: $local_fs $remote_fs $network $syslog # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: starts the sidekiq # Description: starts sidekiq ### END INIT INFO # Feel free to change any of the following variables for your app: # Set user USER = deployer # Set app name APP_NAME = myflix # R.eplace [PATH_TO_RAILS_ROOT_FOLDER] with your application's path. APP_ROOT = /home/ $USER /apps/ $APP_NAME /current # Set the environment. This can be changed to staging or development for staging # servers. RAILS_ENV = production PID_FILE = $APP_ROOT /tmp/sidekiq.pid LOG_FILE = $APP_ROOT /log/sidekiq.log # A simple description for service output. DESC = \"Sidekiq - $RAILS_ENV \" SIDEKIQ = \"/home/ $USER /.rbenv/shims/sidekiq\" SIDEKIQ_OPTS = \"--pidfile $PID_FILE --logfile $LOG_FILE --environment $RAILS_ENV --daemon\" CMD = \"cd $APP_ROOT ; $SIDEKIQ $SIDEKIQ_OPTS \" REMOVE_PID_FILE = \"rm -f $PID_FILE \" # Give your upgrade action a timeout of 60 seconds. TIMEOUT = 60 # Store the action that we should take from the service command's first # argument (e.g. start, stop, upgrade). action = \" $1 \" # Make sure the script exits if any variables are unset. This is short for # set -o nounset. set -u # Set the location of the old pid. The old pid is the process that is getting # replaced. old_pid = \" $PID_FILE .oldbin\" # Make sure the APP_ROOT is actually a folder that exists. An error message from # the cd command will be displayed if it fails. cd $APP_ROOT || exit 1 # A function to send a signal to the current unicorn master process. sig () { test -s \" $PID_FILE \" && kill - $1 ` cat $PID_FILE ` } # Send a signal to the old process. oldsig () { test -s $old_pid && kill - $1 ` cat $old_pid ` } # A switch for handling the possible actions to take on the unicorn process. case $action in # Start the process by testing if it's there (sig 0), failing if it is, # otherwise running the command as specified above. start ) sig 0 && echo > & 2 \" $DESC is already running\" && exit 0 su - $USER -c \" $CMD \" ;; # Graceful shutdown. Send QUIT signal to the process. Requests will be # completed before the processes are terminated. stop ) sig QUIT && echo \"Stopping $DESC \" exit 0 su - $USER -c \" $REMOVE_PID_FILE \" echo > & 2 \"Not running\" ;; # Quick shutdown - kills all workers immediately. force-stop ) sig TERM && echo \"Force-stopping $DESC \" && exit 0 echo > & 2 \"Not running\" ;; # Graceful shutdown and then start. restart ) sig QUIT && echo \"Restarting $DESC \" && sleep 2 \\ && su - $USER -c \" $CMD \" && exit 0 echo > & 2 \"Couldn't restart.\" ;; # Reloads config file (unicorn.rb) and gracefully restarts all workers. This # command won't pick up application code changes if you have `preload_app # true` in your unicorn.rb config file. reload ) sig HUP && echo \"Reloading configuration for $DESC \" && exit 0 echo > & 2 \"Couldn't reload configuration.\" ;; # Re-execute the running binary, then gracefully shutdown old process. This # command allows you to have zero-downtime deployments. The application may # spin for a minute, but at least the user doesn't get a 500 error page or # the like. Unicorn interprets the USR2 signal as a request to start a new # master process and phase out the old worker processes. If the upgrade fails # for some reason, a new process is started. upgrade ) if sig USR2 && echo \"Upgrading $DESC \" && sleep 10 \\ && sig 0 && oldsig QUIT then n = $TIMEOUT while test -s $old_pid && test $n -ge 0 do printf '.' && sleep 1 && n = $(( $n - 1 )) done echo if test $n -lt 0 && test -s $old_pid then echo > & 2 \" $old_pid still exists after $TIMEOUT seconds\" exit 1 fi exit 0 fi echo > & 2 \"Couldn't upgrade, starting 'su - $USER -c \\\" $CMD \\\"' instead\" su - $USER -c \" $CMD \" ;; # A basic status checker. Just checks if the master process is responding to # the `kill` command. status ) sig 0 && echo > & 2 \" $DESC is running.\" && exit 0 echo > & 2 \" $DESC is not running.\" ;; # Reopen all logs owned by the master and all workers. reopen-logs ) sig USR1 ;; # Any other action gets the usage message. * ) # Usage echo > & 2 \"Usage: $0 <start|stop|restart|reload|upgrade|force-stop|reopen-logs>\" exit 1 ;; esac and execute the commands below. chmod 755 sidekiq update-rc.d sidekiq defaults 99 service sidekiq restart","url":"http://tsaith.github.io/install-sidekiq-and-redis-on-ubuntu.html"},{"tags":"Web","title":"Setting up a rails production server on Ubuntu","text":"In this article, the steps to set up a rails production server based on DigitalOcean VPS of Ubuntu 14.04 x64 are recorded as following. Create a user account to deploy production Install Rbenv and Rails Setting up Nginx+Unicorn Install Sidekiq and Redis Setting up Logrotate","url":"http://tsaith.github.io/setting-up-a-rails-production-server-on-ubuntu.html"},{"tags":"Web","title":"Setting up logrotate for production server","text":"This article will demonstrate how to use logrotate to maintain log files of rails. Switch to root sudo su -l Define a file to maintain log files of rails Assuming your app name is myflix , create /etc/logrotate.d/rails with following content: /etc/logrotate.d/rails: /home/deployer/apps/myflix/current/log/*.log { daily missingok rotate 7 compress delaycompress notifempty copytruncate sharedscripts postrotate service sidekiq restart service unicorn restart endscript } You may execute the command below for testing logrotate -vf /etc/logrotate.conf","url":"http://tsaith.github.io/setting-up-logrotate-for-production-server.html"},{"tags":"Web","title":"Setting up Nginx+Unicorn production server","text":"This article will describe how to install and configure Nginx with Unicorn to build a concurrent rails server based on Ubuntu. Assume that we have logged in with a user account named deployer . Install Unicorn Adding the following line to your Gemfile and execute bundle install . gem 'unicorn' Switch to root sudo su -l Write a init script for Unicorn Asuming the name of your app is myflix , create /etc/init.d/unicorn with the following content: /etc/init.d/unicorn: #!/bin/sh # File: /etc/init.d/unicorn ### BEGIN INIT INFO # Provides: unicorn # Required-Start: $local_fs $remote_fs $network $syslog # Required-Stop: $local_fs $remote_fs $network $syslog # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: starts the unicorn web server # Description: starts unicorn ### END INIT INFO # Feel free to change any of the following variables for your app: # Set user USER = deployer # Set app name APP_NAME = myflix # Replace [PATH_TO_RAILS_ROOT_FOLDER] with your application's path. APP_ROOT = /home/ $USER /apps/ $APP_NAME /current # Set the environment. This can be changed to staging or development for staging # servers. RAILS_ENV = production # This should match the pid setting in $APP_ROOT/config/unicorn.rb. PID_FILE = $APP_ROOT /tmp/unicorn.pid # A simple description for service output. DESC = \"Unicorn app - $RAILS_ENV \" # If you're using rbenv, you may need to use the following setup to get things # working properly: RBENV_RUBY_VERSION = ` cat $APP_ROOT /.ruby-version ` RBENV_ROOT = \"/home/ $USER /.rbenv\" RBENV = \" $RBENV_ROOT /bin/rbenv\" PATH = \" $RBENV_ROOT /bin: $PATH \" SET_PATH = \"cd $APP_ROOT && $RBENV rehash && $RBENV local $RBENV_RUBY_VERSION \" # Unicorn can be run using `bundle exec unicorn` or `bin/unicorn`. UNICORN = \" $RBENV_ROOT /shims/unicorn\" # Execute the unicorn executable as a daemon, with the appropriate configuration # and in the appropriate environment. UNICORN_OPTS = \"-c $APP_ROOT /config/unicorn.rb -E $RAILS_ENV -D\" CMD = \" $UNICORN $UNICORN_OPTS \" # Give your upgrade action a timeout of 60 seconds. TIMEOUT = 60 # Store the action that we should take from the service command's first # argument (e.g. start, stop, upgrade). action = \" $1 \" # Make sure the script exits if any variables are unset. This is short for # set -o nounset. set -u # Set the location of the old pid. The old pid is the process that is getting # replaced. old_pid = \" $PID_FILE .oldbin\" # Make sure the APP_ROOT is actually a folder that exists. An error message from # the cd command will be displayed if it fails. cd $APP_ROOT || exit 1 # A function to send a signal to the current unicorn master process. sig () { test -s \" $PID_FILE \" && kill - $1 ` cat $PID_FILE ` } # Send a signal to the old process. oldsig () { test -s $old_pid && kill - $1 ` cat $old_pid ` } # A switch for handling the possible actions to take on the unicorn process. case $action in # Start the process by testing if it's there (sig 0), failing if it is, # otherwise running the command as specified above. start ) sig 0 && echo > & 2 \" $DESC is already running\" && exit 0 su - $USER -c \" $CMD \" ;; # Graceful shutdown. Send QUIT signal to the process. Requests will be # completed before the processes are terminated. stop ) sig QUIT && echo \"Stopping $DESC \" exit 0 echo > & 2 \"Not running\" ;; # Quick shutdown - kills all workers immediately. force-stop ) sig TERM && echo \"Force-stopping $DESC \" && exit 0 echo > & 2 \"Not running\" ;; # Graceful shutdown and then start. restart ) sig QUIT && echo \"Restarting $DESC \" && sleep 2 \\ && su - $USER -c \" $CMD \" && exit 0 echo > & 2 \"Couldn't restart.\" ;; # Reloads config file (unicorn.rb) and gracefully restarts all workers. This # command won't pick up application code changes if you have `preload_app # true` in your unicorn.rb config file. reload ) sig HUP && echo \"Reloading configuration for $DESC \" && exit 0 echo > & 2 \"Couldn't reload configuration.\" ;; # Re-execute the running binary, then gracefully shutdown old process. This # command allows you to have zero-downtime deployments. The application may # spin for a minute, but at least the user doesn't get a 500 error page or # the like. Unicorn interprets the USR2 signal as a request to start a new # master process and phase out the old worker processes. If the upgrade fails # for some reason, a new process is started. upgrade ) if sig USR2 && echo \"Upgrading $DESC \" && sleep 10 \\ && sig 0 && oldsig QUIT then n = $TIMEOUT while test -s $old_pid && test $n -ge 0 do printf '.' && sleep 1 && n = $(( $n - 1 )) done echo if test $n -lt 0 && test -s $old_pid then echo > & 2 \" $old_pid still exists after $TIMEOUT seconds\" exit 1 fi exit 0 fi echo > & 2 \"Couldn't upgrade, starting 'su - $USER -c \\\" $CMD \\\"' instead\" su - $USER -c \" $CMD \" ;; # A basic status checker. Just checks if the master process is responding to # the `kill` command. status ) sig 0 && echo > & 2 \" $DESC is running.\" && exit 0 echo > & 2 \" $DESC is not running.\" ;; # Reopen all logs owned by the master and all workers. reopen-logs ) sig USR1 ;; # Any other action gets the usage message. * ) # Usage echo > & 2 \"Usage: $0 <start|stop|restart|reload|upgrade|force-stop|reopen-logs>\" exit 1 ;; esac Then, execute chmod +x /etc/init.d/unicorn update-rc.d unicorn defaults service unicorn restart Prepare the configuration file of Unicorn under project directory Create config/unicorn.rb with content as config/unicorn.rb: # Set the current app's path for later reference. Rails.root isn't available at # this point, so we have to point up a directory. app_path = File . expand_path ( File . dirname ( __FILE__ ) + '/..' ) # The number of worker processes you have here should equal the number of CPU cores your server has. worker_processes ( ENV [ 'RAILS_ENV' ] == 'production' ? 2 : 1 ) # You can listen on a port or a socket. Listening on a socket is good in a # production environment, but listening on a port can be useful for local # debugging purposes. listen app_path + '/tmp/unicorn.sock' , backlog : 64 # For development, you may want to listen on port 3000 so that you can make sure # your unicorn.rb file is soundly configured. listen ( 3000 , backlog : 64 ) if ENV [ 'RAILS_ENV' ] == 'development' # After the timeout is exhausted, the unicorn worker will be killed and a new # one brought up in its place. Adjust this to your application's needs. The # default timeout is 60. Anything under 3 seconds won't work properly. timeout 60 # Set the working directory of this unicorn instance. working_directory app_path # Set the location of the unicorn pid file. This should match what we put in the # unicorn init script later. pid app_path + '/tmp/unicorn.pid' # You should define your stderr and stdout here. If you don't, stderr defaults # to /dev/null and you'll lose any error logging when in daemon mode. stderr_path app_path + '/log/unicorn.log' stdout_path app_path + '/log/unicorn.log' # Load the app up before forking. preload_app true # Garbage collection settings. GC . respond_to? ( :copy_on_write_friendly = ) && GC . copy_on_write_friendly = true # If using ActiveRecord, disconnect (from the database) before forking. before_fork do | server , worker | defined? ( ActiveRecord :: Base ) && ActiveRecord :: Base . connection . disconnect! end # After forking, restore your ActiveRecord connection. after_fork do | server , worker | defined? ( ActiveRecord :: Base ) && ActiveRecord :: Base . establish_connection end Install and configure Nginx apt-get install nginx Edit /etc/nginx/nginx.conf as below /etc/nginx/nginx.conf: # Run nginx as www-data. user www-data ; # One worker process per CPU core is a good guideline. worker_processes 1 ; pid /var/run/nginx.pid ; # For a single core server, 1024 is a good starting point. Use `ulimit -n` to # determine if your server can handle more. events { worker_connections 1024 ; } http { ## # Basic Settings ## sendfile on ; tcp_nopush on ; tcp_nodelay off ; keepalive_timeout 65 ; types_hash_max_size 2048 ; server_tokens off ; include /etc/nginx/mime.types ; default_type application/octet-stream ; ## # Logging Settings ## access_log /var/log/nginx/access.log ; error_log /var/log/nginx/error.log ; ## # Gzip Settings ## gzip on ; gzip_disable \"msie6\" ; gzip_http_version 1.1 ; gzip_proxied any ; gzip_min_length 500 ; gzip_types text/plain text/xml text/css text/comma-separated-values text/javascript application/x-javascript application/atom+xml ; ## # Unicorn Rails ## # The socket here must match the socket path that you set up in unicorn.rb. upstream unicorn { server unix:/home/deployer/apps/myflix/current/tmp/unicorn.sock fail_timeout = 0 ; } ## # Virtual Host Configs ## include /etc/nginx/conf.d/*.conf ; include /etc/nginx/sites-enabled/* ; } Create /etc/nginx/sites-available/myflix with content: /etc/nginx/sites-available/myflix: server { listen 80 ; server_name myflix.com ; # Set server name keepalive_timeout 300 ; client_max_body_size 4G ; root /home/deployer/apps/myflix/current/public ; # Set this to the public folder location of your Rails application. try_files $uri /index.html $uri .html $uri @unicorn ; location @unicorn { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ; proxy_set_header Host $http_host ; proxy_set_header X-Forwarded_Proto $scheme ; proxy_redirect off ; # This passes requests to unicorn, as defined in /etc/nginx/nginx.conf proxy_pass http://unicorn ; proxy_read_timeout 300s ; proxy_send_timeout 300s ; } # You can override error pages by redirecting the requests to a file in your # application's public folder, if you so desire: error_page 500 502 503 504 /500.html ; location = /500.html { root /home/deployer/apps/myflix/current/public ; } } Finally, execute the following commands: cd /etc/nginx/sites-enabled rm default ln -s ../sites-available/myflix myflix service nginx restart","url":"http://tsaith.github.io/setting-up-nginxunicorn-production-server.html"},{"tags":"Web","title":"Deploy production with Capistrano","text":"This article will describe how to deploy production with Capistrano . The official site provides useful explanations on the usage and structure of capistrano. Here we assume that you are already able to login your production server with SSH key. Installation Add the lines to Gemfile: Gemfile: gem 'capistrano-rails' , '1.1.2' gem 'capistrano-rbenv' , '2.0.3' , require : false Install and initialize capistrano: bundle install cap install Add the followings lines to Capfile . require 'capistrano/setup' require 'capistrano/deploy' require 'capistrano/rbenv' require 'capistrano/bundler' require 'capistrano/rails/migrations' require 'capistrano/rails/assets' Dir . glob ( 'lib/capistrano/tasks/*.rake' ) . each { | r | import r } Configuration Set up global configuration in config/deploy.rb as following sample. config/deploy.rb: # config valid only for current version of Capistrano lock '3.4.0' set :application , 'YOUR_APP_Name' set :domain , \" #{ fetch ( :application ) } .com\" set :user , \"deployer\" set :repo_url , \"git@bitbucket.org:YOUR_ACCOUNT_NAME/ #{ fetch ( :application ) } .git\" set :deploy_to , \"/home/deployer/apps/ #{ fetch ( :application ) } \" set :current_path , \" #{ fetch ( :deploy_to ) } /current\" set :shared_path , \" #{ fetch ( :deploy_to ) } /shared\" set :releases_path , \" #{ fetch ( :deploy_to ) } /releases\" set :default_env , { path : \"~/.rbenv/shims:~/.rbenv/bin:$PATH\" } set :rbenv_ruby , '2.1.5' set :deploy_via , :remote_cache set :linked_files , fetch ( :linked_files , [] ) . push ( 'config/application.yml' , 'config/database.yml' , 'config/secrets.yml' ) set :linked_dirs , fetch ( :linked_dirs , [] ) . push ( 'log' , 'tmp' ) Next, set up the IP of your production server in config/deploy/production.rb : config/deploy/production.rb: server '162.233.120.172' , user : 'deployer' , roles : %w{web app db} Be sure that db is added for database migration will be executed. Start to deploy All you have to do is execute this command: cap production deploy List all tasks To view all available tasks in capistrano: cap -T Define your own tasks You can write your own tasks and put them under lib/capistrano/tasks/ . For example, assume we have wrote a task named access_check.rake with following content: lib/capistrano/tasks/access_check.rake: desc \"Check that we can access everything\" task :check_write_permissions do on roles ( :all ) do | host | if test ( \"[ -w #{ fetch ( :deploy_to ) } ]\" ) info \" #{ fetch ( :deploy_to ) } is writable on #{ host } \" else error \" #{ fetch ( :deploy_to ) } is not writable on #{ host } \" end end end Now, we can check if we have enough writing permissions on the production server by executing: cap production check_write_permissions","url":"http://tsaith.github.io/deploy-production-with-capistrano.html"},{"tags":"Web","title":"Is your site accessible from China?","text":"The following sites provide conivient tools to detect if your site is blocked from the firewall of China. WebSitePulse GreatFire","url":"http://tsaith.github.io/is-your-site-accessible-from-china.html"},{"tags":"Misc","title":"Vi-mode in command-line and Rails Console","text":"Since both command-line and rails console treat characters with readline , we can add the line below in ~/.inputrc set editing-mode vi to switch from the default emacs-mode to vi-mode .","url":"http://tsaith.github.io/vi-mode-in-command-line-and-rails-console.html"},{"tags":"Web","title":"Custom domain for your app on Heroku","text":"First of all, apply a domain from any DNS provider like Godaddy . To add a domain to your app, please execute the following command under the project directory. heroku domains:add www.example.com To remove the domain from your app, please execute heroku domains:remove www.example.com","url":"http://tsaith.github.io/custom-domain-for-your-app-on-heroku.html"},{"tags":"Web","title":"Adding google analytics to octopress","text":"Go to Google Analytics to get the tracking id. Then, set the valud of google_analytics_tracking_id in the _config.yml of Octopress. _config.yml: # Google Analytics google_analytics_tracking_id: UA-59891323-1  Github Pages In case you use Github Pages for Octopress, please also add one line in the source/_includes/google_analytics.html as below. source/_includes/google_analytics.html: {% if site.google_analytics_tracking_id %} <script type= \"text/javascript\" > var _gaq = _gaq || []; _gaq . push ([ '_setAccount' , '{{ site.google_analytics_tracking_id }}' ]); _gaq . push ([ '_setDomainName' , 'github.io' ]); // add this line for Github Pages _gaq . push ([ '_trackPageview' ]); ( function () { var ga = document . createElement ( 'script' ); ga . type = 'text/javascript' ; ga . async = true ; ga . src = ( 'https:' == document . location . protocol ? 'https://ssl' : 'http://www' ) + '.google-analytics.com/ga.js' ; var s = document . getElementsByTagName ( 'script' )[ 0 ]; s . parentNode . insertBefore ( ga , s ); })(); </script> {% endif %} After publishing above settings, you are ready to view the traffic status in google analytics.","url":"http://tsaith.github.io/adding-google-analytics-to-octopress.html"},{"tags":"Web","title":" Rails  Bootstrap","text":"Bootstrap   Responsive Web Design  ;  Rails  Bootstrap    Gemfile  gem 'bootstrap-sass' gem 'autoprefixer-rails' gem 'sass-rails' gem 'sprockets-rails' , :require => 'sprockets/railtie'  bundle install   Bootstrap   app/assets/stylesheets/  application.css   application.css.sass  app/assets/stylesheets/application.css.sass: @import \"bootstrap-sprockets\" @import \"bootstrap\"  bootstrap-sprockets  bootstrap   app/assets/javascripts/application.js   //= require bootstrap-sprockets  app/assets/javascripts/application.js: // This is a manifest file that'll be compiled into application.js, which will include all the files // listed below. // // Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts, // or vendor/assets/javascripts of plugins, if any, can be referenced here using a relative path. // // It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the // compiled file. // // Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details // about supported directives. // //= require jquery //= require jquery_ujs //= require turbolinks //= require bootstrap-sprockets //= require_tree .  app/views/layouts/application.html.haml  Stylesheet  Javascript app/views/layouts/application.html.haml: !!! 5 %html ( lang= \"en-US\" ) %head %title Bed & Breakfast %meta ( charset= \"UTF-8\" ) %meta ( name= \"viewport\" content= \"width=device-width, initial-scale=1.0\" ) = csrf_meta_tag -#  Stylesheet = stylesheet_link_tag \"application\" , :media => \"all\" , 'data-turbolinks-track' => true -#  Javascript = javascript_include_tag \"application\" , 'data-turbolinks-track' => true %body %header = render 'shared/header' %section .content.clearfix = render 'shared/messages' = yield %footer &copy 2015 Bed & Breakfast  Bootstrap ","url":"http://tsaith.github.io/zai-rails-zhong-an-zhuang-yu-she-ding-bootstrap.html"},{"tags":"Web","title":" Rails ","text":" Stripe     Gemfile  gem 'stripe_event'  bundle install   active   users table  active   true  db/schema.rb: create_table \"users\" , force : true do | t | t . string \"full_name\" t . string \"email\" t . string \"password_digest\" t . string \"slug\" t . string \"token\" t . boolean \"admin\" t . string \"customer_token\" t . datetime \"created_at\" t . datetime \"updated_at\" t . boolean \"active\" , default : true #  end  initializer  config/initializers/stripe.rb  config/initializers/stripe.rb: Stripe . api_key = ENV [ 'STRIPE_SECRET_KEY' ] StripeEvent . configure do | events | #  events . subscribe 'charge.succeeded' do | event | user = User . where ( customer_token : event . data . object . customer ) . first Payment . create ( user : user , amount : event . data . object . amount , reference_id : event . data . object . id ) end #  events . subscribe 'charge.failed' do | event | user = User . where ( customer_token : event . data . object . customer ) . first user . deactivate! #  end end  Model  Controller  User model  deactivate!  app/models/user.rb: class User < ActiveRecord :: Base ...  ... def deactivate! self . update_column ( :active , false ) end end  SessionController   app/controllers/sessions_controller.rb: class SessionsController < ApplicationController ...  ... def create user = User . where ( email : params [ :email ] ) . first if user && user . authenticate ( params [ :password ] ) #  if user . active? session [ :user_id ] = user . id flash [ :success ] = \"Your've signed in, enjoy!\" redirect_to home_path else flash [ :success ] = \"Your account has been suspended, please contact customer service.\" redirect_to sign_in_path end else flash [ :danger ] = \"Invalid email or password.\" redirect_to sign_in_path end end end  Stripe webhook requests  Stripe  Webhook Settings  webhook requests  URL;   ","url":"http://tsaith.github.io/zai-rails-zhong-chu-li-xin-yong-qia-fu-kuan-shi-bai.html"},{"tags":"Web","title":"","text":" Stripe     Gemfile  gem 'stripe_event'  bundle install   routes  routes.rb  config/routes.rb: namespace :admin do resources :payments , only : [ :index ] end mount StripeEvent :: Engine , at : '/stripe_events'  payments table  payments table  db/schema.rb: create_table \"payments\" , force : true do | t | t . integer \"user_id\" t . integer \"amount\" t . string \"reference_id\" end  initializer  config/initializers/stripe.rb  config/initializers/stripe.rb: Stripe . api_key = ENV [ 'STRIPE_SECRET_KEY' ] StripeEvent . configure do | events | #  events . subscribe 'charge.succeeded' do | event | user = User . where ( customer_token : event . data . object . customer ) . first #  Payment . create ( user : user , amount : event . data . object . amount , reference_id : event . data . object . id ) end end  Stripe      Model/View/Controller  Payment model app/models/payment.rb: class Payment < ActiveRecord :: Base belongs_to :user end  PaymentsController app/controllers/admin/payments_controller.rb: class Admin :: PaymentsController < AdminsController def index @payments = Payment . all end end  view  app/views/admin/payments/index.html.haml: %section .admin_payments .container .row .col-sm-10.col-sm-offset-1 %section .payment_history %ul .nav.nav-tabs %li .active = link_to \"Recent Payments\" , admin_payments_path %li = link_to \"Add a New Video\" , new_admin_video_path %table .table %thead %tr %th Name %th Email %th Amount %th Reference ID %tbody - @payments . each do | payment | %tr %td = payment . user . full_name %td = payment . user . email %td = \"$ #{ payment . amount / 100 . 0 } \" %td = payment . reference_id  Stripe Webhooks  Stripe  Webhook Settings   webhook requests  URL;  th-myflix.herokuapp.com  URL  th-myflix.herokuapp.com/stripe_events   ngrok  public   webhook requests ","url":"http://tsaith.github.io/cha-kan-jiao-yi-ji-lu-de-hou-tai-gong-neng.html"},{"tags":"Web","title":"","text":"     Stripe   Rails   Plans  Stripe Plans  ID  base   customer_token  Rails  users table   customer_token  db/schema.rb: create_table \"users\" , force : true do | t | t . string \"full_name\" t . string \"email\" t . string \"password_digest\" t . string \"slug\" t . string \"token\" t . boolean \"admin\" t . string \"customer_token\" #  customer_token t . boolean \"active\" , default : true t . datetime \"created_at\" t . datetime \"updated_at\" end  Stripe API Key  config/initializers/stripe.rb  Stripe  API Key config/initializers/stripe.rb: Stripe . api_key = ENV [ 'STRIPE_SECRET_KEY' ]  Stripe customer     Stripe customer  customer token  app/services/user_signup.rb: class UserSignup attr_reader :error_message def initialize ( user ) @user = user end def sign_up ( stripe_token ) if @user . valid? #  Stripe customer customer = StripeWrapper :: Customer . create ( :user => @user , :card => stripe_token , :description => \"Sign up for #{ @user . email } \" ) if customer . successful? #  customer token @user . customer_token = customer . customer_token @user . save AppMailer . delay . send_welcome_email ( @user ) @status = :success self else @status = :failed @error_message = customer . error_message self end else @status = :failed @error_message = \"Invalid user information. Please check the errors below.\" self end end def successful? @status == :success end end class UserSignup attr_reader :error_message def initialize ( user ) @user = user end def sign_up ( stripe_token ) if @user . valid? #  Stripe customer customer = StripeWrapper :: Customer . create ( :user => @user , :card => stripe_token , :description => \"Sign up for #{ @user . email } \" ) if customer . successful? @user . save AppMailer . delay . send_welcome_email ( @user ) @status = :success self else @status = :failed @error_message = customer . error_message self end else @status = :failed @error_message = \"Invalid user information. Please check the errors below.\" self end end def successful? @status == :success end end StripeWrapper  Stripe customer   base app/models/stripe_wrapper.rb: module StripeWrapper class Customer attr_reader :response , :error_message def initialize ( options = {}) @response = options [ :response ] @error_message = options [ :error_message ] end def self . create ( options = {}) begin response = Stripe :: Customer . create ( :card => options [ :card ] , :plan => options [ :plan ] || \"base\" , #  base  :email => options [ :user ]. email ) new ( response : response ) rescue Stripe :: CardError => e new ( error_message : e . message ) end end def successful? response . present? end def customer_token response . id end end end","url":"http://tsaith.github.io/yi-zhao-qian-shu-fang-an-jin-xing-shou-fei.html"},{"tags":"Web","title":" Service Objects ","text":"  Controller ;  create   app/controllers/users_controller.rb: class UsersController < ApplicationController ...  ... def create @user = User . new ( user_params ) if @user . valid? #  #  charge = StripeWrapper :: Charge . create ( :amount => 999 , # in cents :currency => \"usd\" , :card => params [ :stripeToken ] , :description => \"Sign up for #{ @user . email } \" ) if charge . successful? @user . save session [ :user_id ] = @user . id AppMailer . delay . send_welcome_email ( @user ) #  flash [ :success ] = \"Thank you for registering with MyFlix.\" redirect_to home_path else flash [ :danger ] = charge . error_message render :new end else flash [ :danger ] = \"Invalid user information. Please check the errors below.\" render :new end end end    Service Objects  Controller    app/services   user_signup.rb app/services/user_signup.rb: class UserSignup attr_reader :error_message def initialize ( user ) @user = user end def sign_up ( stripe_token ) if @user . valid? #  #  charge = StripeWrapper :: Charge . create ( :amount => 999 , # in cents :currency => \"usd\" , :card => stripe_token , :description => \"Sign up for #{ @user . email } \" ) if charge . successful? @user . save AppMailer . delay . send_welcome_email ( @user ) #  @status = :success self else @status = :failed @error_message = charge . error_message self end else @status = :failed @error_message = \"Invalid user information. Please check the errors below.\" self end end def successful? @status == :success end end  create  app/controllers/users_controller.rb: class UsersController < ApplicationController ...  ... def create @user = User . new ( user_params ) #  result = UserSignup . new ( @user ) . sign_up ( params [ :stripeToken ] ) if result . successful? session [ :user_id ] = @user . id flash [ :success ] = \"Thank you for registering with MyFlix.\" redirect_to home_path else flash [ :danger ] = result . error_message render :new end end end  Controller   create  UserSignup ","url":"http://tsaith.github.io/shi-yong-service-objects-bian-xie-zhu-ce-fu-wu.html"},{"tags":"Web","title":" Decorator ","text":" Decorator Pattern   % header % h3 #{@video.title} % span Rating : - if @video . rating = \" #{ @video . rating } /5.0\" - else N / A % p #{@video.description}  % header % h3 #{@video.title} % span Rating : = @video . rating % p #{@video.description}  video rating  Video model  ;  decorator   Draper gem  decorator   Gemfile  gem 'draper'  bundle install    app/decorators/  video_decorator.rb  app/decorators/video_decorator.rb: class VideoDecorator < Draper :: Decorator delegate_all #  Video model  def rating object . rating . present? ? \" #{ object . rating } /5.0\" : \"N/A\" end end  VideoController  decorate  @video app/controllers/videos_controller.rb: class VideosController < ApplicationController ...  ... def show @video = Video . find_by ( slug : params [ :id ] ) . decorate #@video = Video.find_by(slug: params[:id]) end end  view  @video.rating % header % h3 #{@video.title} % span Rating : = @video . rating % p #{@video.description}","url":"http://tsaith.github.io/shi-yong-decorator-zuo-wei-wu-jian-de-biao-da-ceng.html"},{"tags":"Web","title":" Javascript","text":" Capybara  javascript    Gemfile  gem 'capybara' gem 'selenium-webdriver' gem 'capybara-webkit'  bundle install   port  spec_helper.rb  Capybara  port spec/spec_helper.rb: Capybara . server_port = 52662 # this line is required by Selenium      js: true  Capybara  Selenium  Firefox   spec/features/user_registers_spec.rb: require 'spec_helper.rb' feature \"User registers\" , { js : true , vcr : true } do #  js: true background do page . driver . allow_url ( \"js.stripe.com\" ) page . driver . allow_url ( \"api.stripe.com\" ) page . driver . allow_url ( \"www.gravatar.com\" ) visit sign_up_path end after { clear_email } scenario \"with valid user info and valid card\" do fill_in_valid_user_info fill_in_valid_card click_button \"Sign Up\" expect_to_see_welcome_message end scenario \"with valid user info and invalid card\" do fill_in_valid_user_info fill_in_invalid_card click_button \"Sign Up\" expect_to_see_invalid_card_message end def fill_in_valid_user_info fill_in \"Email Address\" , with : \"cloud@example.com\" fill_in \"Password\" , with : \"password\" fill_in \"Full Name\" , with : \"Cloud Strife\" end def fill_in_valid_card fill_in \"Credit Card Number\" , with : \"4242424242424242\" fill_in \"Security Code\" , with : \"123\" select \"4 - April\" , from : \"date_month\" select \"2018\" , from : \"date_year\" end def fill_in_invalid_card fill_in \"Credit Card Number\" , with : \"4242424242424242\" fill_in \"Security Code\" , with : \"\" select \"4 - April\" , from : \"date_month\" select \"2018\" , from : \"date_year\" end def expect_to_see_welcome_message expect ( page ) . to have_content \"Welcome, Cloud Strife\" end def expect_to_see_invalid_card_message expect ( page ) . to have_content \"Your card's security code is invalid.\" end end  Selenium      spec_helper.rb  :webkit  Capybara . javascript_driver = :webkit  :driver  describe 'some stuff which requires js' , :js => true do it 'will use the default js driver' it 'will switch to one specific driver' , :driver => :selenium end","url":"http://tsaith.github.io/zai-zheng-he-ce-shi-zhong-zhi-xing-javascript.html"},{"tags":"Web","title":"","text":"   double   ;       create  users_controller.rb: class UsersController < ApplicationController ...  ... def create @user = User . new ( user_params ) if @user . valid? #  charge = StripeWrapper :: Charge . create ( :amount => 999 , # in cents :currency => \"usd\" , :card => params [ :stripeToken ] , :description => \"Sign up for #{ @user . email } \" ) if charge . successful? @user . save session [ :user_id ] = @user . id AppMailer . delay . send_welcome_email ( @user ) flash [ :success ] = \"You are registered.\" redirect_to home_path else flash [ :danger ] = charge . error_message render :new end else flash [ :danger ] = \"There's something wrong during registration.\" render :new end end ...  ... end  ;   create   double  users_controller_spec.rb: require \"spec_helper\" describe UsersController do describe \"POST create\" do context \"with valid personal info and valid card\" do #  successful?  true let ( :charge ) { double ( :charge , successful? : true ) } before do #  StripeWrapper::Charge.create  charge  StripeWrapper :: Charge . should_receive ( :create ) . and_return ( charge ) end after { ActionMailer :: Base . deliveries . clear } it \"creates the user\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( User . count ) . to eq 1 end it \"sets flash success message\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( flash [ :success ] ) . to be_present end it \"redirects to the home page\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( response ) . to redirect_to home_path end it \"sends out email to the user\" do post :create , user : { email : \"alice@example.com\" , password : \"password\" , full_name : \"Alice Liddel\" } message = ActionMailer :: Base . deliveries . last expect ( message . to ) . to eq [ \"alice@example.com\" ] end end context \"with valid personal info and declined card\" do # successful?  false error_message  let ( :charge ) { double ( :charge , successful? : false , error_message : \"Your card was declined.\" ) } before do #  StripeWrapper::Charge.create  charge  StripeWrapper :: Charge . should_receive ( :create ) . and_return ( charge ) end after { ActionMailer :: Base . deliveries . clear } it \"does not create the user\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( User . count ) . to eq 0 end it \"renders the :new template\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( response ) . to render_template :new end it \"sets @user\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( assigns ( :user )) . to be_instance_of User end it \"sets the flash danger message\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( flash [ :danger ] ) . to be_present end it \"does not send out email\" do post :create , user : Fabricate . attributes_for ( :user ), stripeToken : \"123\" expect ( ActionMailer :: Base . deliveries ) . to be_empty end end context \"with invalid personal info\" do after { ActionMailer :: Base . deliveries . clear } it \"does not create the user\" do post :create , user : Fabricate . attributes_for ( :user , password : \"\" ) expect ( User . count ) . to eq 0 end it \"renders the :new template\" do post :create , user : Fabricate . attributes_for ( :user , password : \"\" ) expect ( response ) . to render_template :new end it \"sets @user\" do post :create , user : Fabricate . attributes_for ( :user , password : \"\" ) expect ( assigns ( :user )) . to be_instance_of User end it \"sets the flash danger message\" do post :create , user : Fabricate . attributes_for ( :user , password : \"\" ) expect ( flash [ :danger ] ) . to be_present end it \"does not send out email\" do post :create , user : { email : \"alice@example.com\" } expect ( ActionMailer :: Base . deliveries ) . to be_empty end end end end    ","url":"http://tsaith.github.io/zai-ce-shi-zhong-mo-ni-wu-jian-xing-wei.html"},{"tags":"Web","title":" API ","text":"  API ()  API  ;  VCR (Video Cassette Recorder)   API     Gemfile  group : test do gem 'vcr' gem 'webmock' end  bundle install  VCR  spec_helper.rb  VCR   Relish    spec/spec_helper.rb: require 'vcr' VCR . configure do | c | c . cassette_library_dir = 'spec/cassettes' c . hook_into :webmock c . configure_rspec_metadata! c . ignore_localhost = true #  request end RSpec . configure do | config | #  RSpec 3  config . treat_symbols_as_metadata_keys_with_true_values = true ...  ... end  :vcr   :vcr  API   stripe_wrapper_sepc.rb: require 'spec_helper' describe StripeWrapper :: Charge do let ( :token ) do Stripe :: Token . create ( :card => { :number => card_number , :exp_month => 1 , :exp_year => 2016 , :cvc => \"314\" , :description => \"some description\" } ) . id end context \"with valid card\" do let ( :card_number ) { '4242424242424242' } it \"charges the card successfully\" , :vcr do #  :vcr response = StripeWrapper :: Charge . create ( amount : 300 , card : token ) expect ( response ) . to be_successful end end context \"with invalid card\" do let ( :card_number ) { '4000000000000002' } it \"does not charge the card successfully\" , :vcr do #  :vcr response = StripeWrapper :: Charge . create ( amount : 300 , card : token ) expect ( response ) . not_to be_successful end it \"contains an error message\" , :vcr do #  :vcr response = StripeWrapper :: Charge . create ( amount : 300 , card : token ) expect ( response . error_message ) . to be_present end end end  :vcr  ;   spec/cassettes  $ tree spec/cassettes spec/cassettes  StripeWrapper_Charge  with_invalid_card   contains_an_error_message.yml   does_not_charge_the_card_successfully.yml  with_valid_card  charges_the_card_successfully.yml 3 directories, 3 files","url":"http://tsaith.github.io/du-li-de-api-ce-shi.html"},{"tags":"Web","title":" Database Cleaner","text":"    Database Cleaner     Gemfile  gem 'database_cleaner'  bundle install    RSpec   spec_helper.rb  config . use_transactional_fixtures = true  config . use_transactional_fixtures = false  spec/support/  database_cleaner.rb   spec/support/database_cleaner.rb: RSpec . configure do | config | config . before ( :suite ) do DatabaseCleaner . clean_with ( :truncation ) end config . before ( :each ) do DatabaseCleaner . strategy = :transaction end config . before ( :each , :js => true ) do DatabaseCleaner . strategy = :truncation end config . before ( :each ) do DatabaseCleaner . start end config . after ( :each ) do DatabaseCleaner . clean end end { % endcodeblock % }   Avdi Grimm   ","url":"http://tsaith.github.io/zai-ce-shi-zhong-shi-yong-database-cleaner.html"},{"tags":"Web","title":": Stripe","text":" Rails  Stripe ; Stripe  Paypal  merchant account  Stripe        Gemfile  gem 'stripe' , :git => 'https://github.com/stripe/stripe-ruby' gem 'figaro'  bundle install    Stripe   API Keys   API Keys  figaro () API keys  figaro install   config/application.yml  .gitignore   application.yml  keys config/application.yml: development : STRIPE_PUBLISHABLE_KEY :  test publishable key STRIPE_SECRET_KEY :  test secret key test : STRIPE_PUBLISHABLE_KEY :  test publishable key STRIPE_SECRET_KEY :  test secret key production : STRIPE_PUBLISHABLE_KEY :  live publishable key STRIPE_SECRET_KEY :  live secret key     Stripe     controller   users_controller.rb: class UsersController < ApplicationController ...  ... def create @user = User . new ( user_params ) if @user . save session [ :user_id ] = @user . id handle_invitation AppMailer . delay . send_welcome_email ( @user ) flash [ :success ] = \"Your are registered.\" #  Stripe  Stripe . api_key = ENV [ 'STRIPE_SECRET_KEY' ] token = params [ :stripeToken ] begin Stripe :: Charge . create ( :amount => 999 , # in cents :currency => \"usd\" , :card => token , :description => \"Sign up for #{ @user . email } \" ) rescue Stripe :: CardError => e flash [ :danger ] = e . message end redirect_to home_path else flash [ :danger ] = \"There's something wrong during registration.\" render :new end end ...  ... end   Stripe  Checkout     app/views/users/new.html.haml %section .register.container .row .col-sm-10.col-sm-offset-1 = bootstrap_form_for @user , layout : :horizontal , lablel_col : \"col-sm-2\" , control_col : \"col-sm-6\" do | f | %header %h1 Register %fieldset = f . email_field :email , label : \"Email Address\" = f . password_field :password = f . text_field :full_name , label : \"Full Name\" = hidden_field_tag :invitation_token , @invitation_token = f . form_group do -# Stripe  javascript <script src=\"https://checkout.stripe.com/checkout.js\" class=\"stripe-button\" data-key= #{ ENV [ 'STRIPE_PUBLISHABLE_KEY' ] } data-amount=\"999\" data-name=\"MyFlix Sign Up Charge\" data-description=\"$9.99 for the best video service\"> </script>    Stripe Custom Forms   view  Stripe.js   app/views/users/new.html.haml: <script type=\"text/javascript\" src=\"https://js.stripe.com/v2/\"></script> <script type=\"text/javascript\"> Stripe.setPublishableKey(\" #{ ENV [ 'STRIPE_PUBLISHABLE_KEY' ] } \"); </script> = javascript_include_tag 'payment' %section .register.container .row .col-sm-10.col-sm-offset-1 = bootstrap_form_for @user , layout : :horizontal , lablel_col : \"col-sm-2\" , control_col : \"col-sm-6\" , html : { id : \"payment-form\" } do | f | %header %h1 Register %fieldset = f . email_field :email , label : \"Email Address\" = f . password_field :password = f . text_field :full_name , label : \"Full Name\" = hidden_field_tag :invitation_token , @invitation_token %fieldset .credit_card %span .payment-errors .form-group %label .control-label.col-sm-2 Credit Card Number .col-sm-6 %input .form-control ( type= \"text\" data-stripe= \"number\" ) .form-group %label .control-label.col-sm-2 Security Code .col-sm-6 %input .form-control ( type= \"text\" data-stripe= \"cvc\" ) .form-group %label .control-label.col-sm-2 Expiration .col-sm-3 = select_month ( Date . today , { add_month_numbers : true }, class : 'form-control' , data : { stripe : \"exp-month\" }) .col-sm-2 = select_year ( Date . today . year , { start_year : Date . today . year , end_year : Date . today . year + 4 }, class : 'form-control' , data : { stripe : \"exp-year\" }) = f . form_group do = f . submit \"Sign up\" {% endcodeblock %}  payment.js  app/assets/javascripts/payment.js: jQuery ( function ( $ ) { $ ( '#payment-form' ). submit ( function ( event ) { var $form = $ ( this ); // Disable the submit button to prevent repeated clicks $form . find ( 'button' ). prop ( 'disabled' , true ); Stripe . card . createToken ( $form , stripeResponseHandler ); // Prevent the form from submitting with the default action return false ; }); function stripeResponseHandler ( status , response ) { var $form = $ ( '#payment-form' ); if ( response . error ) { // Show the errors on the form $form . find ( '.payment-errors' ). text ( response . error . message ); $form . find ( 'button' ). prop ( 'disabled' , false ); } else { // response contains id and card, which contains additional card details var token = response . id ; // Insert the token into the form so it gets submitted to the server $form . append ( $ ( '<input type=\"hidden\" name=\"stripeToken\" />' ). val ( token )); // and submit $form . get ( 0 ). submit (); } }; });","url":"http://tsaith.github.io/xin-yong-qia-jiao-yi-fu-wu-stripe.html"},{"tags":"Web","title":" Figaro ","text":" ( developmenttest  production)  ;  Figaro    Gemfile  gem 'figaro'  bundle install    figaro install   config/application.yml  .gitignore   application.yml   config/application.yml: development : SMTP_USER_NAME : test@example.com SMTP_PASSWORD : test_password test : SMTP_USER_NAME : test@example.com SMTP_PASSWORD : test_password staging : SMTP_USER_NAME : test@example.com SMTP_PASSWORD : test_password production : SMTP_USER_NAME : live@example.com SMTP_PASSWORD : live_password   Heroku  Figaro  Heroku  figaro heroku:set -e production","url":"http://tsaith.github.io/shi-yong-figaro-she-ding-huan-jing-bian-shu.html"},{"tags":"Web","title":"","text":"  ( ... );      users table  admin  $ rails g migration add_admin_to_users admin:boolean $ rake db:migrate  admin  db/schema.rb: create_table \"users\" , force : true do | t | t . string \"full_name\" t . string \"email\" t . string \"password_digest\" t . string \"slug\" t . datetime \"created_at\" t . datetime \"updated_at\" t . string \"token\" t . boolean \"admin\" #  end  routes  config/routes.rb: ...  ... namespace :admin do resources :videos , only : [ :new , :create ] end Controllers  app/controllers/admin   VideosController app/controllers/admin/videos_controller.rb: class Admin :: VideosController < AdminsController def new @video = Video . new end def create # ...  ... end end app/controllers/admin_controller.rb: class AdminsController < AuthenticatedController before_action :require_admin end app/controllers/authenticated_controller.rb: class AuthenticatedController < ApplicationController before_action :require_user end Views  app/views/shared/_header.html.haml: %li -#  = link_to \"Add Video\" , new_admin_video_path if current_user . admin? = link_to \"Invite a friend\" , new_invitation_path %a ( href= \"#\" ) Account %a ( href= \"#\" ) Plan and Billing %a ( href= \"/sign_out\" ) Sign Out  app/views/admin/videos/  app/views/admin/videos/new.html.haml: %section .admin_add_video .container .row .col-md-10.col-md-offset-1 = bootstrap_form_for [ :admin , @video ] , layout : :horizontal , label_col : \"col-sm-3\" , control_col : \"col-sm-6\" do | f | %ul .nav.nav-tabs %li %a ( href= \"\" ) Recent Payments %li .active %a ( href= \"\" ) Add a New Video %br %fieldset = f . text_field :title , control_col : \"col-sm-3\" = f . select :category_id , options_from_collection_for_select ( Category . all , :id , :name ) = f . text_area :description , rows : 8 .form-group %label .control-label.col-sm-3 Large Cover .col-sm-6 %col .btn.btn-file %input .form-control ( type= \"file\" ) .form-group %label .control-label.col-sm-3 Small Cover .col-sm-6 %col .btn.btn-file %input .form-control ( type= \"file\" ) %fieldset .actions.form-group .col-sm-6.col-md-offset-3 = f . submit \"Add Video\" , class : \"btn btn-default\"","url":"http://tsaith.github.io/guan-li-zhe-deng-ru-ji-zhi.html"},{"tags":"Web","title":" CarrierWave  AWS S3","text":"  Rails  CarrierWave  AWS S3   AWS S3  AWS     AWS  IAM ( Amazon S3 Full Access)    S3   S3   buckets    CarrierWave  ImageMagic   Mac Homebrew  brew install imagemagick  Gemfile  gem 'carrierwave' gem 'mini_magick' gem 'fog'  bundle install   MiniMagick  ImageMagick  Ruby   ImageMagick    ;    videos table  large_cover  small_cover  video_url  db/schema.rb: create_table \"videos\" , force : true do | t | t . string \"title\" t . integer \"category_id\" t . string \"large_cover\" #  t . string \"small_cover\" #  t . string \"video_url\" #  t . text \"description\" t . string \"slug\" t . datetime \"created_at\" t . datetime \"updated_at\" end  uploader  rails generate uploader large_cover rails generate uploader small_cover  uploader  app/uploaders/large_cover.rb: # encoding: utf-8 class LargeCoverUploader < CarrierWave :: Uploader :: Base include CarrierWave :: MiniMagick process :resize_to_fill => [ 665 , 375 ] #  # Override the directory where uploaded files will be stored. # This is a sensible default for uploaders that are meant to be mounted: def store_dir \"uploads/ #{ model . class . to_s . underscore } / #{ mounted_as } / #{ model . id } \" end end app/uploaders/small_cover.rb: # encoding: utf-8 class SmallCoverUploader < CarrierWave :: Uploader :: Base include CarrierWave :: MiniMagick process :resize_to_fill => [ 166 , 236 ] #  # Override the directory where uploaded files will be stored. # This is a sensible default for uploaders that are meant to be mounted: def store_dir \"uploads/ #{ model . class . to_s . underscore } / #{ mounted_as } / #{ model . id } \" end end  uploader  Video model  uploaders app/models/video.rb: class Video < ActiveRecord :: Base mount_uploader :large_cover , LargeCoverUploader mount_uploader :small_cover , SmallCoverUploader ...  ... end ###   `config/initializers`  `carrierwave.rb`  config / initializers / carrierwave . rb : :: :ruby CarrierWave . configure do | config | if Rails . env . staging? || Rails . env . production? config . storage = :fog config . fog_credentials = { :provider => 'AWS' , :aws_access_key_id => ENV [ 'AWS_ACCESS_KEY_ID' ] , :aws_secret_access_key => ENV [ 'AWS_SECRET_ACCESS_KEY' ] , :region => ENV [ 'S3_BUCKET_REGION' ] } config . fog_directory = ENV [ 'S3_BUCKET_NAME' ] else config . storage = :file config . enable_processing = Rails . env . development? end end  staging  production   fog  AWS  bucket;   public   :aws_access_key_id  :aws_secret_access_key   IAM  View  Controller   () S3   YouTube ;  Vimeo  Wistia   view  app/views/admin/videos/new.html.haml: %section .admin_add_video .container .row .col-md-10.col-md-offset-1 = bootstrap_form_for [ :admin , @video ] , layout : :horizontal , label_col : \"col-sm-3\" , control_col : \"col-sm-6\" do | f | %ul .nav.nav-tabs %li %a ( href= \"\" ) Recent Payments %li .active = link_to \"Add a New Video\" , new_admin_video_path %br %fieldset = f . text_field :title , control_col : \"col-sm-3\" = f . select :category_id , options_from_collection_for_select ( Category . all , :id , :name ) = f . text_area :description , rows : 8 = f . file_field :large_cover , class : \"btn btn-default btn-file\" = f . file_field :small_cover , class : \"btn btn-default btn-file\" = f . text_field :video_url , label : \"Video URL\" %fieldset .actions.form-group .col-sm-6.col-md-offset-3 = f . submit \"Add Video\" , class : \"btn btn-default\"  controller  app/controllers/admin/video_controller.rb: class Admin :: VideosController < AdminsController def new @video = Video . new end def create @video = Video . new ( video_params ) if @video . save flash [ :success ] = \"You have successfully added the video ' #{ @video . title } '.\" redirect_to new_admin_video_path else flash [ :danger ] = \"You cannot add this video. Please check the errors.\" render :new end end private def video_params params . require ( :video ) . permit ( :title , :category_id , :description , :large_cover , :small_cover , :video_url ) end end","url":"http://tsaith.github.io/shi-yong-carrierwave-shang-chuan-dang-an-dao-aws-s3.html"},{"tags":"Web","title":": Sentry","text":"  ;  Sentry    log   Sentry  Trial plan ;  Team  Project   Project  API Key    Gemfile  Sentry  Ruby  raven-ruby group :production , :staging do gem \"sentry-raven\" end  bundle install   production  staging   SENTRY_DSN  #  API Key export SENTRY_DSN=http://public:secret@example.com/project-id   Sentry ","url":"http://tsaith.github.io/jian-shi-chan-pin-cuo-wu-sentry.html"},{"tags":"Web","title":" paratropper ","text":" Heroku  staging  production servers  ;  paratrooper    Gemfile  gem 'paratrooper'  bundle install    lib/tasks/  deploy.rake  require 'paratrooper' namespace :deploy do desc 'Deploy app in staging environment' task :staging do deployment = Paratrooper :: Deploy . new ( \"amazing-staging-app\" , tag : 'staging' ) deployment . deploy end desc 'Deploy app in production environment' task :production do deployment = Paratrooper :: Deploy . new ( \"amazing-production-app\" ) do | deploy | deploy . tag = 'production' deploy . match_tag = 'staging' end deployment . deploy end end  amazing-staging-app  amazing-production-app  staging  production   deploy  staging  rake deploy:staging ;  deploy  production  rake deploy:production ","url":"http://tsaith.github.io/shi-yong-paratropper-zi-dong-hua-bu-shu-liu-cheng.html"},{"tags":"web","title":" Heroku  staging server","text":"  () ;   production   staging server  staging  production;  staging  production   Heroku  staging server  Heroku  production  myflix   staging  myflix-staging ;  $ heroku fork -a myflix myflix-staging Heroku  fork  myflix-staging  myflix  add-ons staging  production   git  myflix-staging  repository push  staging  $ git remote add myflix-staging git@heroku.com:myflix-staging.git","url":"http://tsaith.github.io/zai-heroku-shang-jia-she-staging-server.html"},{"tags":"Misc","title":" Percol ","text":"       percol  shell    percol  percol  python   python  brew install python  percol pip install percol  percol   ~/.percol.d/rc.py  # X / _ / X percol . view . PROMPT = \"<bold><yellow>X / _ / X</yellow></bold> %q\" # Emacs like percol . import_keymap ({ \"C-h\" : lambda percol : percol . command . delete_backward_char (), \"C-d\" : lambda percol : percol . command . delete_forward_char (), \"C-k\" : lambda percol : percol . command . kill_end_of_line (), \"C-y\" : lambda percol : percol . command . yank (), \"C-t\" : lambda percol : percol . command . transpose_chars (), \"C-a\" : lambda percol : percol . command . beginning_of_line (), \"C-e\" : lambda percol : percol . command . end_of_line (), \"C-b\" : lambda percol : percol . command . backward_char (), \"C-f\" : lambda percol : percol . command . forward_char (), \"M-f\" : lambda percol : percol . command . forward_word (), \"M-b\" : lambda percol : percol . command . backward_word (), \"M-d\" : lambda percol : percol . command . delete_forward_word (), \"M-h\" : lambda percol : percol . command . delete_backward_word (), \"C-n\" : lambda percol : percol . command . select_next (), \"C-p\" : lambda percol : percol . command . select_previous (), \"C-v\" : lambda percol : percol . command . select_next_page (), \"M-v\" : lambda percol : percol . command . select_previous_page (), \"M-<\" : lambda percol : percol . command . select_top (), \"M->\" : lambda percol : percol . command . select_bottom (), \"C-m\" : lambda percol : percol . finish (), \"C-j\" : lambda percol : percol . finish (), \"C-g\" : lambda percol : percol . cancel (), })  shell   ~/.bash_profile  # file navigation with percol [ $(uname -s | grep -c CYGWIN) -eq 1 ] && OS_NAME=\"CYGWIN\" || OS_NAME=`uname -s` function pclip() { if [ $OS_NAME == CYGWIN ]; then putclip $@; elif [ $OS_NAME == Darwin ]; then pbcopy $@; else if [ -x /usr/bin/xsel ]; then xsel -ib $@; else if [ -x /usr/bin/xclip ]; then xclip -selection c $@; else echo \"Neither xsel or xclip is installed!\" fi fi fi } function ff() { local fullpath=$* local filename= ${ fullpath ##*/ } # remove \"/\" from the beginning filename= ${ filename ##*./ } # remove \".../\" from the beginning echo file= $filename # only the filename without path is needed # filename should be reasonable local cli=`find $PWD -not -iwholename '*/target/*' -not -iwholename '*.svn*' -not -iwholename '*.git*' -not -iwholename '*.sass-cache*' -not -iwholename '*.hg*' -type f -iwholename '*' ${ filename } '*' -print | percol` echo ${ cli } echo -n ${ cli } |pclip; } function h () { # reverse history, pick up one line, remove new line characters and put it into clipboard if [ -z \"$1\" ]; then history | sed '1!G;h;$!d' | percol | sed -n 's/&#94; *[0-9][0-9]* *\\(.*\\)$/\\1/p'| tr -d '\\n' | pclip else history | grep \"$1\" | sed '1!G;h;$!d' | percol | sed -n 's/&#94; *[0-9][0-9]* *\\(.*\\)$/\\1/p'| tr -d '\\n' | pclip fi } function glsf () { local str=`git --no-pager log --oneline --stat $* | percol` if [[ $str =~ &#94;[[:space:]]*([a-z0-9A-Z_.\\/-]*).*$ ]]; then echo -n ${ BASH_REMATCH [ 1 ] } | pclip; echo ${ BASH_REMATCH [ 1 ] } fi } function ppgrep() { if [[ $1 == \"\" ]]; then PERCOL=percol else PERCOL=\"percol --query $1\" fi ps aux | eval $PERCOL | awk '{ print $2 }' } function ppkill() { if [[ $1 =~ \"&#94;-\" ]]; then QUERY=\"\" # options only else QUERY=$1 # with a query [[ $# > 0 ]] && shift fi ppgrep $QUERY | xargs kill $* }  terminal  source ~/.bash_profile    ff   Return   h   Ctrl + c ","url":"http://tsaith.github.io/shi-yong-percol-jin-xing-mo-hu-sou-xun.html"},{"tags":"Web","title":" Procfile  Foreman","text":" Heroku  app  Procfile  dynos  Procfile    process type  {% codeblock Procfile %} web: bundle exec rails server -p $PORT {% endcodeblock %}  Heroku  $PORT  5000   Foreman    Heroku Toolbelt  foreman   Procfile  app  Profile  web : bundle exec rails server - p $PORT  foreman start  $ foreman start 09:09:59 web.1 | started with pid 3111  http://localhost:5000/ ","url":"http://tsaith.github.io/shi-yong-procfile-he-foreman.html"},{"tags":"Web","title":" Heroku  concurrent server","text":" Unicorn  Sidekiq  Heroku  concurrent requests   Redis To Go  Sidekiq  Redis   Heroku  app  Redis To Go   gems  Gemfile  gem 'unicorn' gem 'sidekiq'  bundle install   Unicorn  config/  unicorn.rb  config/unicorn.rb: worker_processes Integer ( ENV [ \"WEB_CONCURRENCY\" ] || 3 ) timeout 15 preload_app true before_fork do | server , worker | Signal . trap 'TERM' do puts 'Unicorn master intercepting TERM and sending myself QUIT instead' Process . kill 'QUIT' , Process . pid end defined? ( ActiveRecord :: Base ) and ActiveRecord :: Base . connection . disconnect! end after_fork do | server , worker | Signal . trap 'TERM' do puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT' end defined? ( ActiveRecord :: Base ) and ActiveRecord :: Base . establish_connection end  Unicorn Heroku     Procfile  Procfile  web : bundle exec unicorn - p $PORT - c ./ config / unicorn . rb worker : bundle exec sidekiq - c 2 - v  Heroku ;  dynos   heroku ps    dynos;  web Sidekiq  Heroku  dyno   unicorn.rb   unicorn  worker  Sidekiq config/unicorn.rb: worker_processes Integer ( ENV [ \"WEB_CONCURRENCY\" ] || 3 ) timeout 15 preload_app true before_fork do | server , worker | Signal . trap 'TERM' do puts 'Unicorn master intercepting TERM and sending myself QUIT instead' Process . kill 'QUIT' , Process . pid end defined? ( ActiveRecord :: Base ) and ActiveRecord :: Base . connection . disconnect! #  @sidekiq_pid ||= spawn ( \"bundle exec sidekiq -c 2\" ) end after_fork do | server , worker | Signal . trap 'TERM' do puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT' end defined? ( ActiveRecord :: Base ) and ActiveRecord :: Base . establish_connection end  Procfile  web dyno  web : bundle exec unicorn - p $PORT - c ./ config / unicorn . rb","url":"http://tsaith.github.io/zai-heroku-shang-jia-she-concurrent-server.html"},{"tags":"Web","title":" Sidekiq ","text":" Sidekiq  threads ;    Sidekiq  Gemfile  gem 'sidekiq'  bundle   redis Sidekiq  redis   Mac   Homebrew  brew install redis  redis  sidekiq servers redis:  redis-server sidekiq:  Rails  bundle exec sidekiq   AppMailer . send_welcome_email ( @user ) . deliver  Sidekiq  delay method  AppMailer . delay . send_welcome_email ( @user )  Heroku  Redis   Heroku   Redis to Go   Sidekiq  REDIS_PROVIDER  Redis   Heroku  REDISTOGO ;  heroku config:set REDIS_PROVIDER=REDISTOGO   heroku config  $ heroku config === chlin-conifer Config Vars RACK_ENV: production RAILS_ENV: production REDISTOGO_URL: redis://redistogo:42528ab79e9e15ef9693733239b2d2c6@ray.redistogo.com:9795/ REDIS_PROVIDER: REDISTOGO_URL","url":"http://tsaith.github.io/shi-yong-sidekiq-chu-li-bei-jing-gong-zuo.html"},{"tags":"Web","title":"Heroku : Mailgun","text":"  gmail   gmail ( 2,000 )     Mailgun ;  Heroku  Mailgun add-on   Mailgun add-on  Heroku   Mailgun starter plan    config/environments/production.rb  # Mailer config . action_mailer . default_url_options = { :host => 'yourapp.herokuapp.com' } #  host config . action_mailer . delivery_method = :smtp config . action_mailer . smtp_settings = { address : ENV [ 'MAILGUN_SMTP_SERVER' ] , port : ENV [ 'MAILGUN_SMTP_PORT' ] , user_name : ENV [ 'MAILGUN_SMTP_LOGIN' ] , password : ENV [ 'MAILGUN_SMTP_PASSWORD' ] , domain : 'yourapp.herokuapp.com' , #  domain authentication : :plain , }  Heroku ","url":"http://tsaith.github.io/heroku-shang-de-you-jian-fu-wu-mailgun.html"},{"tags":"Web","title":" Concerns  Model ","text":"  config/application.rb  config . autoload_paths += %W( #{ Rails . root } /lib) # module paths  Rails  lib  module files   Invitation model  token  app/models/invitation.rb: class Invitation < ActiveRecord :: Base before_create :generate_token #  create  token belongs_to :inviter , class_name : \"User\" validates_presence_of :recipient_name , :recipient_email , :message def generate_token #  token self . token = SecureRandom . urlsafe_base64 end def clear_token #  token self . update_column ( :token , nil ) end end  ActiveSupport::Concern  token  lib/tokenable.rb: module Tokenable extend ActiveSupport :: Concern included do before_create :generate_token end def generate_token self . token = SecureRandom . urlsafe_base64 end def clear_token self . update_column ( :token , nil ) end end  model  app/models/invitation.rb: class Invitation < ActiveRecord :: Base include Tokenable #  token belongs_to :inviter , class_name : \"User\" validates_presence_of :recipient_name , :recipient_email , :message end  model ;  model   DHH   ","url":"http://tsaith.github.io/shi-yong-concerns-bang-model-shou-shen.html"},{"tags":"Web","title":" Invite ","text":"        (  )   routes.rb  config/routes.rb: ...  ... get 'sign_up' , to : 'users#new' get 'sign_up/:token' , to : 'users#new_with_invitation_token' , as : 'sign_up_with_invitation_token' resources :invitations , only : [ :new , :create ] get 'expired_token' , to : 'pages#expired_token' Database  invitaions table db/schema.rb: ...  ... create_table \"invitations\" , force : true do | t | t . integer \"inviter_id\" t . string \"recipient_name\" t . string \"recipient_email\" t . text \"message\" t . string \"token\" t . datetime \"created_at\" t . datetime \"updated_at\" end Controllers  invitation token  app/controllers/users_controller.rb: class UsersController < ApplicationController ...  ... def new @user = User . new end def new_with_invitation_token #  invitation token  invitation = Invitation . where ( token : params [ :token ] ) . first if invitation @invitation_token = invitation . token @user = User . new ( email : invitation . recipient_email ) render :new else redirect_to expired_token_path end end def create @user = User . new ( user_params ) if @user . save session [ :user_id ] = @user . id handle_invitation #  AppMailer . send_welcome_email ( @user ) . deliver flash [ :notice ] = \"Your are registered.\" redirect_to home_path else flash [ :error ] = \"There's something wrong during registration.\" render :new end end private ...  ... def handle_invitation invitation = Invitation . where ( token : params [ :invitation_token ] ) . first if invitation @user . follow ( invitation . inviter ) invitation . inviter . follow ( @user ) invitation . clear_token end end end  app/controllers/invitations_controller.rb: class InvitationsController < ApplicationController before_action :require_user def new @invitation = Invitation . new end def create @invitation = current_user . invitations . build ( invitation_params ) if @invitation . save #  AppMailer . send_invitation_email ( @invitation ) . deliver flash [ :success ] = \"You have successfully invited #{ @invitation . recipient_name } .\" redirect_to new_invitation_path else @invitation = Invitation . new flash [ :error ] = \"Failed to invite your friend.\" render :new end end private def invitation_params params . require ( :invitation ) . permit ( :recipient_name , :recipient_email , :message ) end end Views  app/views/shared/_header.html.haml: ...  ... %li = link_to \"Invite a friend\" , new_invitation_path #  %a ( href= \"#\" ) Account %a ( href= \"#\" ) Plan and Billing %a ( href= \"/sign_out\" ) Sign Out  app/views/invitations/new.html.haml: %section .invite.container .row .col-sm-10.col-sm-offset-1 = bootstrap_form_for @invitation do | f | %header %h1 Invite a friend to join MyFlix! %fieldset .row .col-sm-4 = f . text_field :recipient_name , label : \"Friend's Name\" = f . email_field :recipient_email , label : \"Friend's Email Address\" = f . text_area :message , label : \"Message\" , value : \"Please join this really cool site!\" , rows : 6 = f . submit \"Send Invitation\"  invitation token app/views/users/new.html.haml: %section .register.container .row .col-sm-10.col-sm-offset-1 -#%form.form-horizontal = bootstrap_form_for @user do | f | %header %h1 Register .row .col-sm-4 = f . email_field :email , label : \"Email Address\" = f . password_field :password = f . text_field :full_name , label : \"Full Name\" -#  invitation token = hidden_field_tag :invitation_token , @invitation_token = f . submit \"Sign up\"  app/views/pages/expired_token.html.haml: %section .invalid_token.container .row .col-sm-10.col-sm-offset-1 %p Your link is expired. Models app/models/invitation.rb: class Invitation < ActiveRecord :: Base before_create :generate_token belongs_to :inviter , class_name : \"User\" validates_presence_of :recipient_name , :recipient_email , :message def generate_token self . token = SecureRandom . urlsafe_base64 end def clear_token self . update_column ( :token , nil ) end end app/models/user.rb: class User < ActiveRecord :: Base ...  ... has_many :invitations , foreign_key : \"inviter_id\" def follow ( another_user ) following_relationships . create ( leader : another_user ) if can_follow? ( another_user ) end def follows? ( another_user ) following_relationships . map ( & :leader ) . include? ( another_user ) end def can_follow? ( another_user ) ! ( self == another_user || self . follows? ( another_user )) end end Mailer  app/mailers/app_mailer.rb: class AppMailer < ActionMailer :: Base default from : ENV [ 'MYFLIX_SMTP_USER_NAME' ] ...  ... def send_invitation_email ( invitation ) @invitation = invitation mail ( to : @invitation . recipient_email , subject : \"Invitation to join MyFlix!\" ) end end  app/views/app_mailer/send_invitation_email.html.haml: !!! 5 %html ( lang= \"en-US\" ) %body %p You are invited by #{ @invitation . inviter . full_name } to join MyFlix! %p #{ @invitation . message } %p = link_to \"Accept this invitation\" , sign_up_with_invitation_token_url ( @invitation . token )","url":"http://tsaith.github.io/zai-wang-zhan-zhong-jia-ru-invite-gong-neng.html"},{"tags":"Misc","title":" Emacs  Vim: Evil","text":" Vim   Vim   Emacs ;   Emacs    Emacs !  Vim    Emacs  Lisp   ?  Evil   Emacs  Vim  Evil M - x package-install Ret evil Ret   ~/.emacs/init.el  (require 'evil) (evil-mode 1)  C - z :  Emacs  Vim ","url":"http://tsaith.github.io/zai-emacs-zhong-shi-yong-vim-evil.html"},{"tags":"Web","title":": capybara-email","text":"   capybara-email  gem   Gemfile  gem 'capybara-email'  bundle    config/environmnets/test.rb  host config . action_mailer . default_url_options = { :host => 'localhost:3000' }   spec/spec_helper.rb  require 'capybara/email/rspec'    spec/features/user_resets_password_spec.rb: require 'spec_helper.rb' feature \"User resets password\" do scenario \"user sucessfully resets the password\" do #  alice alice = Fabricate ( :user , password : \"old_password\" ) #  Forgot Password?  # () visit sign_in_path click_link \"Forgot Password?\" #  # () fill_in \"Email Address\" , with : alice . email click_button \"Send Email\" #  # () open_email ( alice . email ) current_email . click_link \"Reset My Password\" #  # () fill_in \"New Password\" , with : \"new_password\" click_button \"Reset Password\" #  fill_in \"Email Address\" , with : alice . email fill_in \"Password\" , with : \"new_password\" click_button \"Sign in\" #  expect ( page ) . to have_content \"Welcome, #{ alice . full_name } \" end end { % endcodeblock %} {% blockquote Bill Gates %} Measuring programming progress by lines of code is like measuring aircraft building progress by weight .","url":"http://tsaith.github.io/zheng-he-ce-shi-de-you-jian-gong-ju-capybara-email.html"},{"tags":"Misc","title":": Emacs","text":"GNU  Richard Stallman  Guy Lewis Steele Jr. 1975  Emacs (Editor MACroS) Emacs  Lisp     @_@;  Emcas      Emacs  Mac  Homebrew  brew install emacs  Emacs  ~/.emacs.d  ~/.emacs.d/init.el    ;  Steve Purcell     Rails   Rails    C :  Ctrl M :  Alt Ret :  Return  Packages  Emacs   package-install  M - x package-install Ret Package Name Ret :   Package Menu M - x list-packages :  C - s :  i :  u :  d :  x : /  r :   C - x C - c :  Emacs C - z :  Emcas C - h C - h : Help for Help  C - x C - f :  C - x C - s :   C - d :  Del :   M - w :  C - u 3 M - w :  C - w :  C - u 3 C - w :  C - y :   C - x r s (#):  C - x r i (#):  Buffer  C - x b :  buffer C - x Left :  buffer C - x Right :  buffer  C - Space :  C - k :  M - 0 C - k :  C - x h :   C - x 1:  C - x 2:  C - x 3:  C - x 0:  M - x windmove-up:  M - x windmove-down:  M - x windmove-left:  M - x windmove-right:   C - a :  C - e :  M - a :  M - e :  M - g g :  Esc < :  Esc > :  C - v :  M - v :  C - x r Space a :  register a C - x r j a :  register a   M - % old_string Ret new_string Ret :  M - x replace-regexp Ret regexp Ret newstring Ret :   M - ; :  C - u M - ; :  Tab :  M - x linum-mode: /   C - _ :  M - _ :  C - g :  C - x z :  M - ! :   Packages Dired :  C - x d  c  r  d  +  z  gzip / m  u  U  g  &#94;  osx-cliboard :  OSX  M - x osx-clipboard-mode:  osx-clipboard-mode Eshell : Emacs Shell M - x eshell:  eshell Rinari : Rails  C - c ; f m  model C - c ; f v  view C - c ; f c  controller C - c ; f r  rspec C - c ; f M  mailer C - c ; f i  migration C - c ; f l  lib C - c ; f j  javascript C - c ; f o  log C - c ; c  console C - c ; w  web-server","url":"http://tsaith.github.io/bian-ji-qi-emacs.html"},{"tags":"Misc","title":": Vim","text":"   Vi  Emacs  ;  Vi (Visual Bill Joy  1976  )   Vim ; Vim     !  GNU  RMS  ( vi-vi-vi   XD )  Vim      ~/.vimrc  ~/.vim Vim    C  Ctrl M  Alt  command mode  Esc insert mode  command mode  i  a plain visual mode  command mode  v block visual mode  command mode  C + v command line  command mode  :  vi file_name  :w  :q  :q! () :e file_name   i  a  x  o   d w  d W ()  yy  3 yy  dd  3 dd  y  yank  p   J  d $  d &#94;  D   ma \"c y 'a  register c \"c p  register c  ma \"+ y 'a  3 \"+ yy  yank  :%y+  yank   gg  G  &#94;  $  C + f  C + b  M + f  M + b  M + F  M + b   :cd %:h  :lcd %:h  autocmd BufEnter * silent! lcd %:p:h   gf  ( goto file ) C + &#94;   :tab_new  :tabprevious  :tabnext  :ab tn tab_new  tab_new  tn  :vs  :sp  C + w v  C + w s  C + w left[right] arrow [] C + w up[down] arrow [] C + w h[l] [] C + w k[j] []  u :  C + r :  :set nu  :set nonu  :syntax enable  :set ai  :!  :!ls C + r %  insert mode   map <C-k> :tabprevious <CR>  C + k  :tabpreview map <C-j> :tabnext <CR>  C + j  :tabnext  plugins rails.vim : Rails (... ) :Rcd  () :Rmodel   model  :Rview   view  :Rcontroller   controller  snipMate :  Tab  ctrp :  C + p  fencview.vim :  :FencAutoDetect  nerdtree.vim :  :e .  supertab.vmb :  Tab   Vim   ","url":"http://tsaith.github.io/bian-ji-qi-vim.html"},{"tags":"Web","title":" rvm  rbenv","text":" rvm  ruby   rvm  gem   bundler   rbev  ruby   rvm  $ rvm implode Are you SURE you wish for rvm to implode? This will recursively remove /Users/tsaith/.rvm and other rvm traces? ( anything other than 'yes' will cancel ) > yes  .bashrc.bash_profile.profile  .zshrc  PATH= $ PATH : $ HOME /.rvm/bin # Add RVM to PATH for scripting  rbenv  exec $SHELL -l  shell   rbenv init -  shell  shims  echo 'eval \"$(rbenv init -)\"' >> ~/.bash_profile source ~/.bash_profile  Homebrew  brew update brew install rbenv brew install rbenv-gem-rehash brew install ruby-build  ruby  ruby  rbenv install -l  ruby 2.1.5  rbenv install 2.1.5  ruby  BUILD FAILED (OS X 10.9.5 using ruby-build 20141225) Inspect or clean up the working tree at /var/folders/2v/wtshnx5x4294fvlxyrk9t8kh0000gn/T/ruby-build.20150111114536.6196 Results logged to /var/folders/2v/wtshnx5x4294fvlxyrk9t8kh0000gn/T/ruby-build.20150111114536.6196.log Last 10 log lines: checking whether we are using the GNU C compiler... yes checking whether gcc accepts -g... yes checking for gcc option to accept ISO C89... none needed checking whether we are using the GNU C++ compiler... yes checking whether g++ accepts -g... yes checking how to run the C preprocessor... g++ configure: error: in `/var/folders/2v/wtshnx5x4294fvlxyrk9t8kh0000gn/T/ruby-build.20150111114536.6196/ruby-2.2.0': configure: error: C preprocessor \"g++\" fails sanity check See `config.log' for more details make: *** No targets specified and no makefile found. Stop.  xcode-select --install  Xcode;  Maverick 10.9.x  Can't install the software because it is not currently available from the Software Update server.  Apple Developer ","url":"http://tsaith.github.io/cong-rvm-qian-yi-dao-rbenv.html"},{"tags":"Web","title":" letter_opener ","text":" Rails   Email  letter_opener    Gemfile  group :development do gem 'letter_opener' end  bundle    config/environments/development.rb  config . action_mailer . delivery_method = :letter_opener    rails console $ rails c Loading development environment ( Rails 4.1.1 ) 2.1.5 :001 > AppMailer.send_welcome_email ( User.last ) .deliver  letter_opener ","url":"http://tsaith.github.io/shi-yong-letter_opener-jian-shi-you-jian.html"},{"tags":"Web","title":" RSpec  Functional Tests ","text":" RSpec   UsersController  create action  app/controllers/users_controller.rb: class UsersController < ApplicationController ...  ... def create @user = User . new ( user_params ) if @user . save session [ :user_id ] = @user . id flash [ :notice ] = \"Your are registered.\" #  AppMailer . send_welcome_email ( @user ) . deliver redirect_to home_path else flash [ :error ] = \"There's something wrong during registration.\" render :new end end end  create action   functional tests  spec/controllers/users_controller_spec.rb: require \"spec_helper\" describe UsersController do describe \"POST create\" do context \"sending emails\" do #  after { ActionMailer :: Base . deliveries . clear } #  inputs  it \"sends out email to the user with valid inputs\" do post :create , user : { email : \"alice@example.com\" , password : \"password\" , full_name : \"Alice Liddel\" } expect ( ActionMailer :: Base . deliveries ) . not_to be_empty end #  it \"sends out email to the right recipient\" do post :create , user : { email : \"alice@example.com\" , password : \"password\" , full_name : \"Alice Liddel\" } message = ActionMailer :: Base . deliveries . last expect ( message . to ) . to eq [ \"alice@example.com\" ] end #  it \"sends out email containing the user's name with valid inputs\" do post :create , user : { email : \"alice@example.com\" , password : \"password\" , full_name : \"Alice Liddel\" } message = ActionMailer :: Base . deliveries . last expect ( message . body ) . to include \"Alice Liddel\" end #  inputs  it \"does not send out email with invalid inputs\" do post :create , user : { email : \"alice@example.com\" } expect ( ActionMailer :: Base . deliveries ) . to be_empty end end end end  functional tests    ","url":"http://tsaith.github.io/shi-yong-rspec-zai-functional-tests-li-mian-ce-shi-you-jian.html"},{"tags":"Web","title":" Follow ","text":" Facebook  Twitter  Follow   Routes  routes.rb  app/config/routes.rb: Myflix :: Applation . routes . draw do ...  ... resources :relationships , only : [ :create , :destroy ] get 'people' , to : 'relationships#index' end Models  Relationship  app/models/relationship.rb: class Relationship < ActiveRecord :: Base belongs_to :leader , class_name : 'User' belongs_to :follower , class_name : 'User' end User  following_relationships  leading_relationships ; follow?  can_follow?  app/models/user.rb: class User < ActiveRecord :: Base ...  ... has_many :relationships has_many :following_relationships , class_name : 'Relationship' , foreign_key : 'follower_id' has_many :leading_relationships , class_name : 'Relationship' , foreign_key : 'leader_id' has_many :leaders , class_name : 'User' , through : :relationships def follows? ( another_user ) following_relationships . map ( & :leader ) . include? ( another_user ) end def can_follow? ( another_user ) ! ( self == another_user || self . follows? ( another_user )) end end Controllers  RelationshipsController app/controllers/relationships_controller.rb: class RelationshipsController < ApplicationController before_action :require_user def index #  following  @relationships = current_user . following_relationships end def create #  following  leader = User . find ( params [ :leader_id ] ) Relationship . create ( leader : leader , follower : current_user ) if current_user . can_follow? ( leader ) redirect_to people_path end def destroy #  following  relationship = Relationship . find ( params [ :id ] ) relationship . destroy if relationship . follower == current_user redirect_to people_path end end Views  Follow  app/views/users/show.rb: %section .user.container .row .col-sm-10.col-sm-offset-1 %article %header %img ( src= \"http://www.gravatar.com/avatar/#{Digest::MD5.hexdigest(@user.email.downcase)}?s=40\" ) %h2 #{ @user . full_name } 's video collections ( #{ @user . queue_items . count } ) -#  Follow  - if current_user . can_follow? ( @user ) = link_to \"Follow\" , relationships_path ( leader_id : @user . id ), method : :post , class : 'btn btn-default' %table .table %thead %tr %th ( width= \"30%\" ) Video Title %th ( width= \"15%\" ) Genre %tbody - @user . queue_items . each do | queue_item | %tr %td = link_to queue_item . video_title , queue_item . video %td = link_to queue_item . category_name , queue_item . category  Following  app/views/relationships/index.rb: %section .people %header %h2 People I Follow %table .table %thead %tr %th ( width= \"30%\" ) %th ( width= \"20%\" ) Videos in Queue %th ( width= \"20%\" ) Followers %th ( width= \"30%\" ) Unfollow %tbody - @relationships . each do | relationship | # following  %tr %td %img ( src= \"http://www.gravatar.com/avatar/#{Digest::MD5.hexdigest(relationship.leader.email.downcase)}?s=40\" ) = link_to relationship . leader . full_name , relationship . leader %td .extra-padding #{ relationship . leader . queue_items . count } %td .extra-padding #{ relationship . leader . leading_relationships . count } %td .extra-padding = link_to relationship , method : :delete do #  following  %i .glyphicon.glyphicon-remove","url":"http://tsaith.github.io/shi-zuo-follow-she-jiao-gong-neng.html"},{"tags":"Web","title":"","text":"  ;     Forgot Password?        Routes  routes config/routes.rb: get 'forgot_password' , to : 'forgot_passwords#new' resources :forgot_passwords , only : [ :create ] get 'forgot_password_confirmation' , to : 'forgot_passwords#confirm' resources :password_resets , only : [ :show , :create ] get 'expired_token' , to : 'password_resets#expired_token' Database  users table  token  db/schema.rb: create_table \"users\" , force : true do | t | t . string \"full_name\" t . string \"email\" t . string \"password_digest\" t . string \"role\" t . string \"slug\" t . datetime \"created_at\" t . datetime \"updated_at\" t . string \"token\" end Views  Forgot Password?  app/views/sessions/new.html.haml: %section .sign_in.container .row .col-sm-10.col-sm-offset-1 = bootstrap_form_tag url : sign_in_path do | f | %header %h1 Sign in .row .col-sm-4 = f . email_field :email , label : \"Email Address\" , placeholder : 'user_name@example.com' .row .col-sm-4 = f . password_field :password = f . submit \"Sign in\" = link_to \"Forgot Password?\" , forgot_password_path #   app/views/forgot_passwords/new.html.haml: %section .forgot_password.container .row .col-sm-10.col-bg-offset-1 = bootstrap_form_tag url : forgot_passwords_path do | f | %header %h1 Forgot Password? %p We will send you an email with a link that you can use to reset your password. .row .col-sm-4 = f . email_field :email , label : \"Email Address\" = f . submit \"Send Email\"  rails-bootstrap-forms  twitter bootstrap-style   app/views/forgot_passwords/confirm.html.haml: %section .confirm_password_reset.container .row .col-sm-10.col-sm-offset-1 %p We have sent an email with instruction to reset your password.  app/views/password_resets/show.html.haml: %section .reset_password.container .row .col-sm-10.col-sm-offset-1 = bootstrap_form_tag url : password_resets_path do | f | %header %h1 Reset Your Password .row .col-sm-4 = f . password_field :password , label : \"New Password\" = f . hidden_field :token , value : @token = f . submit \"Reset Password\"  token  app/views/password_resets/expired_token.html.haml: %section .invalid_token.container .row .col-sm-10.col-sm-offset-1 %p Your reset password link is expired. Controllers  ForgotPasswordsController app/controllers/forgot_passwords_controller.rb: class ForgotPasswordsController < ApplicationController def new ; end def create user = User . where ( email : params [ :email ] ) . first if user user . generate_token AppMailer . send_password_reset ( user ) . deliver redirect_to forgot_password_confirmation_path else flash [ :error ] = params [ :email ]. blank? ? \"Email cannot be blank.\" : \"There is no user with that email in the system.\" redirect_to forgot_password_path end end def confirm ; end end  PasswordResetsController app/controllers/password_resets_controller.rb: class PasswordResetsController < ApplicationController def show user = User . where ( token : params [ :id ] ) . first if user @token = params [ :id ] else redirect_to expired_token_path end end def create user = User . where ( token : params [ :token ] ) . first if user user . password = params [ :password ] if user . save user . clear_token flash [ :success ] = \"Your password has been changed. Please sign in.\" else flash [ :error ] = \"Invalid new password. Password did not change.\" end redirect_to sign_in_path else redirect_to expired_token_path end end def expired_token ; end end Models  generate_token  clear_token methods  User class  app/models/user.rb: class User < ActiveRecord :: Base ...  ... def generate_token self . update_column ( :token , SecureRandom . urlsafe_base64 ) end def clear_token self . update_column ( :token , nil ) end end Mailer  development.rb  production.rb  :host  config/environments/development.rb: # Mailer host config . action_mailer . default_url_options = { :host => 'localhost:3000' } config/environments/production.rb: # Mailer host config . action_mailer . default_url_options = { :host => '' }  AppMailer app/mailers/app_mailer.rb: class AppMailer < ActionMailer :: Base default from : ENV [ 'MYFLIX_SMTP_USER_NAME' ] def send_password_reset ( user ) @user = user mail ( to : @user . email , subject : \"Please reset your password\" ) end end MYFLIX_SMTP_USER_NAME       app/views/app_mailer/send_password_reset.html.haml: !!! 5 %html ( lang= \"en-US\" ) %body %p Please click on the link below to reset your password: %p = link_to \"Reset My Password\" , password_reset_url ( @user . token )","url":"http://tsaith.github.io/tou-guo-you-jian-yun-xu-shi-yong-zhe-zhong-she-mi-ma.html"},{"tags":"Web","title":"","text":"   Capybara  require 'spec_helper' feature \"User signs in\" do scenario \"with valid email and password\" do alice = Fabricate ( :user ) #  visit sign_in_path fill_in 'Email' , :with => alice . email fill_in 'Password' , :with => alice . password click_button 'Sign in' expect ( page ) . to have_content alice . full_name end end  Capybara     feature \"User signs in\" do scenario \"with valid email and password\" do alice = Fabricate ( :user ) #  sign_in ( alice ) expect ( page ) . to have_content alice . full_name end def sign_in ( user ) visit sign_in_path fill_in 'Email' , :with => user . email fill_in 'Password' , :with => user . password click_button 'Sign in' end end  ;   ","url":"http://tsaith.github.io/shi-yong-dan-yi-chou-xiang-ceng-zhuan-xie-ce-shi.html"},{"tags":"Web","title":" RSpec  Macros","text":"  macros    require 'spec_helper' feature \"User signs in\" do scenario \"with valid email and password\" do alice = Fabricate ( :user ) visit sign_in_path fill_in 'Email' , :with => alice . email fill_in 'Password' , :with => alice . password click_button 'Sign in' expect ( page ) . to have_content alice . full_name end end ;  spec/support/macros.rb  sign_in def sign_in ( a_user = nil ) user = a_user || Fabricate ( :user ) visit sign_in_path fill_in 'Email' , :with => user . email fill_in 'Password' , :with => user . password click_button 'Sign in' end  require 'spec_helper' feature \"User signs in\" do scenario \"with valid email and password\" do alice = Fabricate ( :user ) sign_in ( alice ) expect ( page ) . to have_content alice . full_name end end    sign_in  macro ","url":"http://tsaith.github.io/zai-rspec-zhong-shi-yong-macros.html"},{"tags":"Web","title":" RSpec  shared examples","text":" RSpec   shared examples    require \"spec_helper\" describe VideosController do describe \"GET index\" do it \"sets @categories for authenticated users\" do set_current_user category = Fabricate ( :category ) get :index expect ( assigns ( :categories )) . to eq [ category ] end it \"redirects to the sign in page\" do get :index expect ( response ) . to redirect_to sign_in_path end it \"sets the flash error message\" do get :index expect ( flash [ :error ] ) . to be_present end end describe \"GET show\" do it \"sets @video for authenticated user\" do set_current_user video = Fabricate ( :video ) get :show , id : video . slug expect ( assigns ( :video )) . to eq video end it \"redirects to the sign in page\" do video = Fabricate ( :video ) get :show , id : video . slug expect ( response ) . to redirect_to sign_in_path end it \"sets the flash error message\" do video = Fabricate ( :video ) get :show , id : video . slug expect ( flash [ :error ] ) . to be_present end end end  GET index  GET show   spec/support/shared_examples.rb  shared_examples \"requires sign in\" do it \"redirects to the sign in page\" do action expect ( response ) . to redirect_to sign_in_path end it \"sets the flash error message\" do action expect ( flash [ :error ] ) . to be_present end end  refactor  require \"spec_helper\" describe VideosController do describe \"GET index\" do it \"sets @categories for authenticated users\" do set_current_user category = Fabricate ( :category ) get :index expect ( assigns ( :categories )) . to eq [ category ] end it_behaves_like \"requires sign in\" do video = Fabricate ( :video ) let ( :action ) { get :index } end end describe \"GET show\" do it \"sets @video for authenticated user\" do set_current_user video = Fabricate ( :video ) get :show , id : video . slug expect ( assigns ( :video )) . to eq video end it_behaves_like \"requires sign in\" do video = Fabricate ( :video ) let ( :action ) { get :show , id : video . slug } end end end  ","url":"http://tsaith.github.io/zai-rspec-zhong-shi-yong-shared-examples.html"},{"tags":"Misc","title":"Bash ","text":" Mac  shell  Bash ctrl + a :  ctrl + e :  alt + f :  alt + b :  ctrl + k :  ctrl + u :  ctrl + w :  ctrl + t :  esc + t :  tab :  ctrl + d :  ctrl + c :  ctrl + z : ","url":"http://tsaith.github.io/bash-zhong-chang-yong-de-kuai-jie-jian.html"},{"tags":"Web","title":" Debug : Pry","text":" Rails  Ruby  pry  pry-nav  debug    Gemfile  group : development , : test do gem 'pry' gem 'pry-nav' end  bundle   debug  binding.pry class SessionsController < ApplicationController def new redirect_to home_path if current_user end def create user = User . where ( email : params [ :email ] ) . first if user && user . authenticate ( params [ :password ] ) session [ :user_id ] = user . id binding . pry #  flash [ :notice ] = \"Your've signed in, enjoy!\" redirect_to home_path else flash [ :error ] = \"Invalid email or password.\" redirect_to sign_in_path end end def destroy session [ :user_id ] = nil redirect_to home_path , notice : \"You are signed out!\" end end  server  binding.pry   From : /Users/ tsaith / projects / myflix / app / controllers / sessions_controller . rb @ line 11 SessionsController #create: 7 : def create 8 : user = User . where ( email : params [ :email ] ) . first 9 : if user && user . authenticate ( params [ :password ] ) 10 : session [ :user_id ] = user . id => 11 : binding . pry 12 : flash [ :notice ] = \"Your've signed in, enjoy!\" 13 : redirect_to home_path 14 : else 15 : flash [ :error ] = \"Invalid email or password.\" 16 : redirect_to sign_in_path 17 : end 18 : end [ 1 ] pry ( #<SessionsController>)> params => { \"utf8\" => \"\" , \"authenticity_token\" => \"Is1jphXlmnK8fRfJT2YdJqMcBFTNxuzn1bIum1o9D3U=\" , \"email\" => \"user@gmail.com\" , \"password\" => \"user_password\" , \"commit\" => \"Sign in\" , \"controller\" => \"sessions\" , \"action\" => \"create\" } [ 2 ] pry ( #<SessionsController>)> user.id => 1 [ 3 ] pry ( #<SessionsController>)> next From : /Users/ tsaith / projects / myflix / app / controllers / sessions_controller . rb @ line 12 SessionsController #create: 7 : def create 8 : user = User . where ( email : params [ :email ] ) . first 9 : if user && user . authenticate ( params [ :password ] ) 10 : session [ :user_id ] = user . id 11 : binding . pry => 12 : flash [ :notice ] = \"Your've signed in, enjoy!\" 13 : redirect_to home_path 14 : else 15 : flash [ :error ] = \"Invalid email or password.\" 16 : redirect_to sign_in_path 17 : end 18 : end [ 1 ] pry ( #<SessionsController>)>  Ctrl + d   alias  ~/.pryrc  Pry . commands . alias_command 'c' , 'continue' Pry . commands . alias_command 's' , 'step' Pry . commands . alias_command 'n' , 'next'","url":"http://tsaith.github.io/hao-yong-de-debug-gong-ju-pry.html"},{"tags":"Web","title":" rails: pow","text":" Rails   rails server  ; Basecamp  Pow   Pow  $ curl get.pow.cx | sh   ~/.pow   ~/projects/myflix  $ cd ~/.pow $ ln -s ~/projects/myflix   http://myflix.dev   RVM  pow  rbenv   rvm  .powenv  pow  if [ -z \" ${ rvm_path :- } \" ] && [ -x \" ${ HOME :- } /.rvm/bin/rvm\" ] then rvm_path = \" ${ HOME :- } /.rvm\" fi if [ -z \" ${ rvm_path :- } \" ] && [ -x \"/usr/local/rvm/bin/rvm\" ] then rvm_path = \"/usr/local/rvm\" fi # load environment of current project ruby if [ -n \" ${ rvm_path :- } \" ] && [ -x \" ${ rvm_path :- } /bin/rvm\" ] && rvm_project_environment = ` \" ${ rvm_path :- } /bin/rvm\" . do rvm env --path 2>/dev/null ` && [ -n \" ${ rvm_project_environment :- } \" ] && [ -s \" ${ rvm_project_environment :- } \" ] then echo \"RVM loading: ${ rvm_project_environment :- } \" \\. \" ${ rvm_project_environment :- } \" else echo \"RVM project not found at: $PWD \" fi  Pow Powder  pow   $ gem install powder :  ~/.pow/<> $ power link  $ powder open  .powenv  $ powder env  debug shell $ power debug  app $ powder restart","url":"http://tsaith.github.io/kuai-su-qi-dong-rails-pow.html"},{"tags":"Web","title":" RSpec  Feature Tests","text":" Rails  Feature Tests ;  RSpec  Capybara    Gemfile  gem 'capybara'  bundle  Capybara  'An error occurred while installing nokogiri'  Gem::Ext::BuildError: ERROR: Failed to build gem native extension. /Users/tsaith/.rvm/rubies/ruby-2.1.1/bin/ruby -r ./siteconf20141220-15553-1vqn6mc.rb extconf.rb checking if the C compiler accepts ... yes checking if the C compiler accepts -Wno-error=unused-command-line-argument-hard-error-in-future... no Building nokogiri using packaged libraries. checking for iconv... yes ************************************************************************ IMPORTANT NOTICE: Buidling Nokogiri with a packaged version of libxml2-2.9.2 with the following patches applied: - 0001-Revert-Missing-initialization-for-the-catalog-module.patch - 0002-Fix-missing-entities-after-CVE-2014-3660-fix.patch Team Nokogiri will keep on doing their best to provide security updates in a timely manner, but if this is a concern for you and want to use the system library instead; abort this installation process and reinstall nokogiri as follows: gem install nokogiri -- --use-system-libraries [--with-xml2-config=/path/to/xml2-config] [--with-xslt-config=/path/to/xslt-config] If you are using Bundler, tell it to use the option: bundle config build.nokogiri --use-system-libraries bundle install Note, however, that nokogiri is not fully compatible with arbitrary versions of libxml2 provided by OS/package vendors. ************************************************************************ Extracting libxml2-2.9.2.tar.gz into tmp/x86_64-apple-darwin12.5.0/ports/libxml2/2.9.2... OK Running patch with /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/nokogiri-1.6.5/ports/patches/libxml2/0001-Revert-Missing-initialization-for-the-catalog-module.patch... Running 'patch' for libxml2 2.9.2... OK Running patch with /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/nokogiri-1.6.5/ports/patches/libxml2/0002-Fix-missing-entities-after-CVE-2014-3660-fix.patch... Running 'patch' for libxml2 2.9.2... OK Running 'configure' for libxml2 2.9.2... ERROR, review '/Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/nokogiri-1.6.5/ext/nokogiri/tmp/x86_64-apple-darwin12.5.0/ports/libxml2/2.9.2/configure.log' to see what happened. *** extconf.rb failed *** Could not create Makefile due to some reason, probably lack of necessary libraries and/or headers. Check the mkmf.log file for more details. You may need configuration options. Provided configuration options: --with-opt-dir --without-opt-dir --with-opt-include --without-opt-include= ${ opt - dir } /include --with-opt-lib --without-opt-lib= ${ opt - dir } /lib --with-make-prog --without-make-prog --srcdir=. --curdir --ruby=/Users/tsaith/.rvm/rubies/ruby-2.1.1/bin/ruby --help --clean --use-system-libraries --enable-static --disable-static --with-zlib-dir --without-zlib-dir --with-zlib-include --without-zlib-include= ${ zlib - dir } /include --with-zlib-lib --without-zlib-lib= ${ zlib - dir } /lib --enable-cross-build --disable-cross-build /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/mini_portile-0.6.1/lib/mini_portile.rb:279:in `block in execute': Failed to complete configure task (RuntimeError) from /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/mini_portile-0.6.1/lib/mini_portile.rb:271:in `chdir' from /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/mini_portile-0.6.1/lib/mini_portile.rb:271:in `execute' from /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/mini_portile-0.6.1/lib/mini_portile.rb:66:in `configure' from /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/mini_portile-0.6.1/lib/mini_portile.rb:109:in `cook' from extconf.rb:268:in `block in process_recipe' from extconf.rb:167:in `tap' from extconf.rb:167:in `process_recipe' from extconf.rb:455:in ` <main> ' extconf failed, exit code 1 Gem files will remain installed in /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/gems/nokogiri-1.6.5 for inspection. Results logged to /Users/tsaith/.rvm/gems/ruby-2.1.1@myflix/extensions/x86_64-darwin-12/2.1.0-static/nokogiri-1.6.5/gem_make.out An error occurred while installing nokogiri (1.6.5), and Bundler cannot continue. Make sure that `gem install nokogiri -v '1.6.5'` succeeds before bundling.  Nokogiri bundle config build.nokogiri --use-system-libraries  bundle   spec_helper.rb  spec/spec_helper.rb  require 'capybara/rails' # This file is copied to spec/ when you run 'rails generate rspec:install' ENV [ \"RAILS_ENV\" ] ||= 'test' require File . expand_path ( \"../../config/environment\" , __FILE__ ) require 'rspec/rails' require 'capybara/rails'    spec/features/user_signs_in_spec.rb  require 'spec_helper' feature \"User signs in\" do scenario \"with valid email and password\" do alice = Fabricate ( :user ) #  visit sign_in_path #  fill_in 'Email' , :with => alice . email #  Email fill_in 'Password' , :with => alice . password #  Password click_button 'Sign in' #  Sign in  expect ( page ) . to have_content alice . full_name #  end end  feature  scenario  RSpec  describe ..., :type => :feature  it ; Relish   rspec ","url":"http://tsaith.github.io/shi-yong-rspec-xie-feature-tests.html"},{"tags":"Web","title":" RSpec  Functional Tests","text":" Rails  Functional Tests  controller ;   spec/controllers/  sessions_controller_spec.rb require \"spec_helper\" describe SessionsController do let ( :user ) { Fabricate ( :user ) } describe \"GET new\" do it \"redirects to the home page for authenticated users\" do session [ :user_id ] = user . id get :new expect ( response ) . to redirect_to home_path end end describe \"POST create\" do context \"with valid credentials\" do before do post :create , email : user . email , password : user . password end it \"puts the signed in user in the session\" do expect ( session [ :user_id ] ) . to eq user . id end it \"redirects to the home page\" do expect ( response ) . to redirect_to home_path end it \"sets the notice\" do expect ( flash [ :notice ] ) . not_to be_blank end end context \"with invalid credentials\" do before do post :create , email : user . email , password : user . password + \"sadsafds\" end it \"does not put the signed in user in the session\" do expect ( session [ :user_id ] ) . to be_nil end it \"redirects to the sign in page\" do expect ( response ) . to redirect_to sign_in_path end it \"sets the error message\" do expect ( flash [ :error ] ) . not_to be_blank end end end describe \"GET destroy\" do before do session [ :user_id ] = user . id get :destroy end it \"clears the session for the user\" do expect ( session [ :user_id ] ) . to be_nil end it \"redirects to the home page\" do expect ( response ) . to redirect_to home_path end it \"sets the notice\" do expect ( flash [ :notice ] ) . not_to be_blank end end end  new  create  destroy  Fabrication  User ;  spec/fabricators/  user_fabricator.rb Fabricator ( :user ) do email { Faker :: Internet . email } password { Faker :: Internet . password } full_name { Faker :: Name . name } end  user fabricator  Faker  email  password   rspec ","url":"http://tsaith.github.io/shi-yong-rspec-zhuan-xie-functional-tests.html"},{"tags":"Web","title":" RSpec  Unit Tests","text":";  Category model class Category < ActiveRecord :: Base has_many :videos , -> { order ( 'created_at DESC' ) } validates :name , presence : true , uniqueness : true def recent_videos videos . first ( 6 ) end end  spec/models/category_spec.rb  require 'spec_helper' require 'shoulda/matchers' describe Category do it { is_expected . to have_many :videos } it { is_expected . to validate_presence_of :name } it { is_expected . to validate_uniqueness_of :name } describe \"#recent_videos\" do let ( :category ) { Category . create! ( name : \"Game\" )} subject { category . recent_videos } it \"returns an empty array if the category does not have any videos\" do expect ( subject ) . to eq [] end it \"returns all videos if there are less than 6 videos\" do 1 . upto ( 5 ) { | index | category . videos . create ( title : \"FF #{ index } \" , description : \"Final Fantasy\" ) } expect ( subject . count ) . to eq 5 end it \"returns 6 videos if there are more than 6 videos\" do 1 . upto ( 7 ) { | index | category . videos . create ( title : \"FF #{ index } \" , description : \"Final Fantasy\" ) } expect ( subject . count ) . to eq 6 end it \"returns the videos in the reverse order by created_at\" do ff = category . videos . create ( title : \"FF\" , description : \"Final Fantasy\" , created_at : 2 . days . ago ) dq = category . videos . create ( title : \"DQ\" , description : \"Dragon Quest\" , created_at : 1 . day . ago ) expect ( subject ) . to eq [ dq , ff ] end end end","url":"http://tsaith.github.io/shi-yong-rspec-zhuan-xie-unit-tests.html"},{"tags":"Web","title":" RSpec ","text":"RSpec  Ruby  BDD (Behavior Deriven Development)      Gemfile  rspec-rails  gem group : development , : test do gem 'rspec-rails' , '2.99' end  RSpec   shoulda-matchers   group : test do gem 'shoulda-matchers' , '2.7.0' , require : false end  Gemfile  bundle   rails g rspec:install  RSpec   spec_helper.rb  spec/spec_helper.rb  ENV [ \"RAILS_ENV\" ] ||= 'test' require File . expand_path ( \"../../config/environment\" , __FILE__ ) require 'rspec/rails'   app/models/video.rb  Video model  class Video < ActiveRecord :: Base belongs_to :category validates_presence_of :title , :description end  Video model  Category  title  description   spec/models/video_spec.rb  require 'spec_helper' require 'shoulda/matchers' describe Video do it { should belong_to :category } it { should validate_presence_of :title } it { should validate_presence_of :description } end  rspec spec/models/video_spec.rb   rspec   spec/ ","url":"http://tsaith.github.io/shi-yong-rspec-zuo-zi-dong-ce-shi.html"},{"tags":"Misc","title":"iTerm2 ","text":"iTerm2  Mac  Terminal;    Preference   session  Profile -> General -> Login shell Profile -> General -> Reuse previous session's directory (...) Profile -> Colors -> Load Presets... -> Tango Dark  Profile -> Text -> Change Font  alt/option key  Emacs  Profile -> Keys -> Left option key acts as: +Esc Profile -> Keys -> Right option key acts as: +Esc  alt + Space / iTerm2 Profile -> Keys -> Show/hide iTerm2 with a system-wide hotkey","url":"http://tsaith.github.io/iterm2-zhong-hao-yong-de-she-ding.html"},{"tags":"Web","title":"","text":"  ;  Video  config/routes.rb  search  resources :videos , only : [ :show ] do collection do get 'search' , to : 'videos#search' end end  app/controllers/videos_controller.rb  search action def search @videos = Video . search_by_title ( params [ 'search_term' ] ) end  app/models/video.rb  search_by_title  def self . search_by_title ( str ) return [] if str . blank? where ( \"title LIKE ?\" , \"% #{ str } %\" ) . order ( \"created_at DESC\" ) end  Haml  views;  header   app/views/shared/_header.html.haml  = form_tag search_videos_path , method : 'get' , class : 'col-md-5 navbar-form' do = text_field_tag :search_term , params [ 'search_term' ] ||= '' , class : 'form-control' , placeholder : \"Search for videos here\" = submit_tag 'Search' , class : 'btn btn-default'  app/views/videos/search.html.haml - @videos . each do | video | .video.ul .li #{ video . title } .li = image_tag ( video . cover_image_url , size : cover_image_size )","url":"http://tsaith.github.io/shi-zuo-jian-yi-de-sou-xun-gong-neng.html"},{"tags":"Web","title":" Rails ","text":"( git)  ;  Rails    config/environments/  production.rb   password  ENV  # Delivery method of mailer config . action_mailer . delivery_method = :smtp # Settings of the mailer config . action_mailer . smtp_settings = { address : \"smtp.gmail.com\" , port : 587 , domain : \"gmail.com\" , authentication : \"plain\" , user_name : thtsai . demo @gmail . com , password : ENV [ 'SMTP_PASSWORD' ] , enable_starttls_auto : true }   Mac ~/.profile  export SMTP_PASSWORD='My password' ;  Heroku  heroku config:add SMTP_PASSWORD='My password' Rails ","url":"http://tsaith.github.io/an-quan-di-she-ding-rails-you-jian-mi-ma.html"},{"tags":"Web","title":" Rails  PostgresSQL","text":"PostgreSQL   Rails    Mac   Postgres.app  /Applications/   ~/.profile  export PATH= $ PATH :/Applications/Postgres.app/Contents/Versions/9.3/bin export PGHOST=localhost ( 9.3)  Rails   config/database.yml  development : adapter : postgresql encoding : unicode database : myflix_development pool : 5 username : YOUR_USERNAME password : YOUR_PASSWORD test : adapter : postgresql encoding : unicode database : myflix_test pool : 5 username : YOUR_USERNAME password : YOUR_PASSWORD production : adapter : postgresql encoding : unicode database : myflix_test pool : 5 username : YOUR_USERNAME password : YOUR_PASSWORD  Gemfile  gem 'pg'  bundle  Rails  PostgreSQL    PostgreSQL  : createdb db_name : dropdb db_name : psql -l PostgreSQL : : \\l : \\c db_name  tables: \\d : DROP DATABASE db_name; : DROP DATABASE db_name;  table: CREATE TABLE db_table(id int, text VARCHAR(50));  table: DROP TABLE db_table; : SELECT * FROM db_table WHERE id = 1; : INSERT INTO db_table(id, text) VALUES(1, 'A new record'); : UPDATE db_table SET text = 'str' WHERE id = 1; : DELETE FROM test WHERE id = 1;","url":"http://tsaith.github.io/zai-rails-zhong-shi-yong-postgressql.html"},{"tags":"Web","title":" Rails  gmail ","text":"  ;  Rails  gmail    config/environments/  development.rb  production.rb   delivery_method  smtp_settings  # Don't care if the mailer can't send. config . action_mailer . raise_delivery_errors = false # Delivery method of mailer config . action_mailer . delivery_method = :smtp # Settings of the mailer config . action_mailer . smtp_settings = { address : \"smtp.gmail.com\" , port : 587 , domain : \"gmail.com\" , authentication : \"plain\" , user_name : \"example@gmail.com\" , password : \"12345678\" , enable_starttls_auto : true }  Mailer  app/mailers/user_mailer.rb  UserMailer class  welcome_email method class UserMailer < ActionMailer :: Base default from :  /  def welcome_email ( user ) @user = user mail ( to : @user . email , subject : \"You have sucessfully registered.\" ) end end  views  app/views/user_mailer/  welcome_email.html.erb  welcome_email.text.erb .html.erb  HTML  <! DOCTYPE html> <html> <body> <p> You have successfully registered. </p> </body> </html>  .text.erb  You have successfully registered.  gmail   gmail  ;  gmail account    rails console  $ rails console Loading development environment ( Rails 4.0.0 ) 2.1.1 :001 > UserMailer.welcome_email ( User.last ) .deliver  welcome_email   :  config/environments/development.rb   rails server ","url":"http://tsaith.github.io/zai-rails-shi-yong-gmail-fa-song-you-jian.html"},{"tags":"Web","title":" Rails  module","text":" Rails       config/application.rb  config.autoload_paths += %W(#{config.root}/lib)  lib  modules  require File . expand_path ( '../boot' , __FILE__ ) require 'rails/all' # Require the gems listed in Gemfile, including any gems # you've limited to :test, :development, or :production. Bundler . require ( :default , Rails . env ) module PostitTemplate class Application < Rails :: Application # Settings in config/environments/* take precedence over those specified here. # Application configuration should go into files in config/initializers # -- all .rb files in that directory are automatically loaded. # Module paths config . autoload_paths += %W( #{ config . root } /lib) # Set Time.zone default to the specified zone and make Active Record auto-convert to this zone. # Run \"rake -D time\" for a list of tasks for finding time zone names. Default is UTC. config . time_zone = 'Taipei' # The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded. # config.i18n.load_path += Dir[Rails.root.join('my', 'locales', '*.{rb,yml}').to_s] # config.i18n.default_locale = :de # Tealeaf note: Bootstrap sass gem addition config . assets . precompile += %w(*.png *.jpg *.jpeg *.gif) end end   lib/ ;    voteable_th.rb VoteableTh Rails ( 4.1.6 )  voteable_th.rb  module VoteableTh extend ActiveSupport :: Concern included do has_many :votes , as : :voteable , :dependent => :destroy end def total_votes up_votes - down_votes end def up_votes self . votes . where ( vote : true ) . size end def down_votes self . votes . where ( vote : false ) . size end end   include  class Post < ActiveRecord :: Base include VoteableTh belongs_to :creator , class_name : \"User\" , foreign_key : \"user_id\" has_many :comments , :dependent => :destroy validates :title , presence : true , length : { minimum : 3 } validates :description , presence : true end","url":"http://tsaith.github.io/zai-rails-zhong-shi-yong-module.html"},{"tags":"Web","title":" gem","text":"    gem    gem  voteable-gem  lib  lib/ $ ls lib voteable_th.rb voteable_th.rb  module VoteableTh extend ActiveSupport :: Concern included do has_many :votes , as : :voteable , :dependent => :destroy end def total_votes up_votes - down_votes end def up_votes self . votes . where ( vote : true ) . size end def down_votes self . votes . where ( vote : false ) . size end end  voteable-gem  voteable.gemspec  gem specification Gem :: Specification . new do | s | s . name = 'voteable_th' # gem  s . version = '0.0.0' #  s . summary = \"A voting gem\" s . description = \"A voting gem for Rails\" s . authors = [ \"Tsung-Hua Tsai\" ] s . email = 'tsai.tsunghua@gmail.com' s . files = [ \"lib/voteable_th.rb\" ] #  s . homepage = 'http://tsaith.github.io/' s . license = 'MIT' end  gem build  gem $ gem build voteable.gemspec Successfully built RubyGem Name: voteable_th Version: 0.0.1 File: voteable_th-0.0.0.gem   Rubygems.org    gem push  gem  Rubygems.org $ gem push voteable_th-0.0.0.gem Pushing gem to https://rubygems.org... Successfully registered gem: voteable_th ( 0.0.0 )  gem   gem  $ gem search -r voteable_th *** REMOTE GEMS *** voteable_th ( 0.0.0 )  gem  bug   gem yank  $ gem yank voteable_th -v 0.0.0 Yanking gem from https://rubygems.org... Successfully yanked gem: voteable_th ( 0.0.0 )  $ gem yank voteable_th -v 0.0.0 --undo Unyanking gem from https://rubygems.org... Successfully unyanked gem: voteable_th ( 0.0.0 )  RubyGems Guides ","url":"http://tsaith.github.io/zhi-zuo-he-fa-bu-gem.html"},{"tags":"Web","title":" Rails  Ajax","text":"   Ajax   routes  config/routes.rb  view  post resources :posts do member do post :vote end end  view  html  app/views/posts/_post.html.erb  remote: true  javascript  < div class = \"row\" > < div id = \"post_vote_error_<%= post.to_param %>\" class = \"alert alert-error\" style = \"display:none\" > You can only vote on a post once . < /div> <div class=\"span0 well text-center\"> <%= link_to vote_post_path(post, vote: true), method: 'post', remote: true do %> <i class='icon-arrow-up'></i > < % end %> <br/> < span id = \"post_<%= post.slug %>_votes\" >< %= post.total_votes %> votes </span> <br/> <%= link_to vote_post_path ( post , vote : false ), method : 'post' , remote : true do %> <i class='icon-arrow-down'> < /i> <% end %> </ div > < /div> ...  app/views/posts/vote.js.erb javascript ;  < % if @vote . valid? %> $('#post_<%= @post.slug %> _votes ').html(' < %= @post.total_votes %> votes'); <% else %> $('#post_vote_error_<%= @post . to_param %>').show().fadeOut(3000); <% end %>  validates_uniqueness_of  class Vote < ActiveRecord :: Base belongs_to :user belongs_to :voteable , polymorphic : true validates_uniqueness_of :user , scope : [ :voteable_type , :voteable_id ] end  javascript  html  id  post_vote_error_<%= @post.to_param %>   controller  controller  vote method  respond_to  html  javascript  def vote @vote = Vote . create ( voteable : @post , creator : current_user , vote : params [ :vote ] ) respond_to do | format | format . html do if @vote . valid? flash [ :notice ] = \"Your vote is counted.\" else flash [ :error ] = \"You can only vote on a post once.\" end redirect_to :back end format . js end end","url":"http://tsaith.github.io/zai-rails-zhong-shi-yong-ajax.html"},{"tags":"Web","title":" polymorphic association","text":"   polymorphic association  Vote  Post  Comment   Table  votes table ;  votes  voteable_type  voteable_id  id  db/schema.rb  create_table \"votes\" , force : true do | t | t . boolean \"vote\" t . integer \"user_id\" t . string \"voteable_type\" t . integer \"voteable_id\" t . datetime \"created_at\" t . datetime \"updated_at\" end create_table \"posts\" , force : true do | t | t . string \"url\" t . string \"title\" t . text \"description\" t . integer \"user_id\" t . datetime \"created_at\" t . datetime \"updated_at\" end create_table \"comments\" , force : true do | t | t . text \"body\" t . integer \"user_id\" t . integer \"post_id\" t . datetime \"created_at\" t . datetime \"updated_at\" end  Models  app/models/vote.rb  polymorphic: true  voteable  polymorphic  voteable  app/models/vote.rb: class Vote < ActiveRecord :: Base belongs_to :user belongs_to :voteable , polymorphic : true validates_uniqueness_of :user , scope : [ :voteable_type , :voteable_id ] end  post.rb  comment.rb  has_many :votes, as: :voteable  post  comment  app/models/post.rb: class Post < ActiveRecord :: Base belongs_to :user has_many :comments , :dependent => :destroy has_many :votes , as : :voteable validates :title , presence : true validates :description , presence : true end app/models/comment.rb: class Comment < ActiveRecord :: Base belongs_to :user belongs_to :post has_many :votes , as : :voteable validates :body , presence : true validates :user_id , presence : true validates :post_id , presence : true end   Controllers  Views ","url":"http://tsaith.github.io/she-ding-polymorphic-association.html"},{"tags":"Web","title":" Heroku","text":"Heroku   ;    Keroku    Heroku toolbelt   heroku login  public ssh key  heroku create $ heroku create Creating agile-sea-7701... done , stack is cedar-14 https://agile-sea-7701.herokuapp.com/ | git@heroku.com:agile-sea-7701.git Git remote heroku added $ git remote heroku origin  git push heroku master Heroku   heroku ps:scale web=1  instance  $ heroku ps:scale web = 1 Scaling dynos... done , now running web at 1:1X.  heroku run rake db:migrate  Heroku  database migration  app  heroku apps:rename   heroku open  Good Luck!","url":"http://tsaith.github.io/bu-shu-zhuan-an-dao-heroku.html"},{"tags":"Web","title":" Rails ","text":"  gem ( Devise )  ;  Rails    bcrypt-ruby  Gemfile  gem 'bcrypt-ruby', '3.0.1'  bundle    users  users  password_digest   db/schema  create_table \"users\" , force : true do | t | t . string \"username\" t . datetime \"created_at\" t . datetime \"updated_at\" t . string \"password_digest\" end  routes  config/routes.rb  login  logout  get 'login' , to : 'sessions#new' post 'login' , to : 'sessions#create' get 'logout' , to : 'sessions#destroy'  model  User model has_secure_password ;  has_secure_password   class User < ActiveRecord :: Base has_secure_password validations : false validates :username , presence : true , uniqueness : true validates :password , presence : true , on : :create , length : { minimum : 5 } end  view  app/views/sessions/new.html.erb  < %= render 'shared/content_title', title: 'Please log in' %> <div class= 'well' > < %= form_tag '/login' do %> <div class= 'control-group' > < %= label_tag :username %> <%= text_field_tag :username , params [ :username ] || '' %> </div> < div > < %= label_tag :password %> <%= password_field_tag :password , params [ :password ] || '' %> </div> <%= submit_tag \"Login\" , class : 'btn btn-success' %> <% end %> < /div>  username  password  controller  app/controllers/sessions_controller.rb class SessionsController < ApplicationController def new end def create user = User . find_by ( username : params [ :username ] ) if user && user . authenticate ( params [ :password ] ) session [ :user_id ] = user . id flash [ :notice ] = \"Your've logged in!\" redirect_to root_path else flash [ :error ] = \"There's something wrong with username or password\" redirect_to register_path end end def destroy session [ :user_id ] = nil flash [ :notice ] = \"You've logged out!\" redirect_to root_path end end  create   user.authenticate(params[:password])   session[:user_id]  user id;  destroy   session[:user_id] = nil  user id  app/controllers/application_controller.rb  class ApplicationController < ActionController :: Base # Prevent CSRF attacks by raising an exception. # For APIs, you may want to use :null_session instead. protect_from_forgery with : :exception helper_method :current_user , :logged_in? def current_user @current_user ||= User . find ( session [ :user_id ] ) if session [ :user_id ] end def logged_in? !! current_user end def require_user unless logged_in? flash [ :error ] = \"Must be logged in to do that\" redirect_to root_path end end end current_user :  logged_in? : ? require_user :   ","url":"http://tsaith.github.io/zai-rails-shi-zuo-yan-zheng-ji-zhi.html"},{"tags":"Misc","title":"Vim ","text":"   Vi  Emacs  ; Vi  Vim   Vim     ~/.vimrc:  ~/.vim: Vim   vi file_name  Ecs  :w  :q  :q! () :e file_name  x  i  a  p  yy  3 yy  dd  3 dd  D  J  :set nu  :set nonu  ma \"c y 'a  register c \"c p  register c  ma \"+ y 'a  3 \"+ yy  :set ai  :tab_new  :ab tn tab_new  tab_new  tn :tabprevious  :tabnext  map <C-k> :tabprevious <CR>  Ctrl + k  :tabpreview map <C-j> :tabnext <CR>  Ctrl + j  :tabnext gg  G  :cd %:h  :lcd %:h  autocmd BufEnter * silent! lcd %:p:h  gf  ( goto file ) Ctrl + &#94;  :!  :!ls :syntax enable   :vs  Ctrl + w v  :sp  Ctrl + w s  Ctrl + w left[right] arrow  Ctrl + w up[down] arrow   plugin rails.vim : Rails (... ) Rcd  () Rmodel   model  Rview   view  Rcontroller   controller  snipMate :  Tab  ctrp :  Ctrl + p  Ctrl + v  fencview.vim :  :FencAutoDetect  nerdtree.vim :  :e .  supertab.vmb :  Tab  Tab   Vim  ","url":"http://tsaith.github.io/vim-de-chang-yong-zhi-ling.html"},{"tags":"Web","title":" Google Chrome ","text":"  Google Chrome  plugin   Google Chrome  Shortkeys ;  Shortkeys  : Chrome -> Preferences -> Extensions -> Shortkeys -> Options   command+shift+right  command+shift+left ","url":"http://tsaith.github.io/zai-google-chrome-zhong-zi-ding-kuai-jie-jian.html"},{"tags":"Web","title":" Flickr ","text":" ;   Flickr    Flickr    \"Share this photo\"  HTML code  HTML code  <img src=  <img src=\"https://farm8.staticflickr.com/7563/15655510442_e9803f8335_b.jpg\" width=\"1024\" height=\"768\" alt=\"FF-12\"> ;   Octopress   {% img https://farm8.staticflickr.com/7563/15655510442_e9803f8335_b.jpg %} ","url":"http://tsaith.github.io/zai-bu-luo-ge-zhong-jia-ru-flickr-tu-pian.html"},{"tags":"Web","title":" Rails ","text":" Rails  has_many through:      Post  Category  post  categories  Category  posts  Post  Category ;   tables  tables  postscategories  post_categories;  post_categories  post_id  category_id  column ( table   )  tables  db/schema.rb  table  ActiveRecord :: Schema . define ( version : 20141031042824 ) do create_table \"posts\" , force : true do | t | t . string \"title\" t . string \"url\" t . text \"description\" t . datetime \"created_at\" t . datetime \"updated_at\" end create_table \"categories\" , force : true do | t | t . string \"name\" t . datetime \"created_at\" t . datetime \"updated_at\" end create_table \"post_categories\" , force : true do | t | t . integer \"post_id\" t . integer \"category_id\" t . datetime \"created_at\" t . datetime \"updated_at\" end end  models  Post  Category  PostCategory   app/models/post.rb class Post < ActiveRecord :: Base has_many :post_categories has_many :categories , through : :post_categories end  app/models/category.rb class Category < ActiveRecord :: Base has_many :post_categories has_many :posts , through : :post_categories end  app/models/post_category.rb class PostCategory < ActiveRecord :: Base belongs_to :post belongs_to :category end  Rails ","url":"http://tsaith.github.io/zai-rails-zhong-she-ding-duo-dui-duo-guan-lian-xing.html"},{"tags":"Web","title":" Rails  routes","text":" Rails  http request   request  controller  action ;   config/routes.rb  root to:  request ; PostitTemplate :: Application . routes . draw do root to : 'posts#index' end  bundle exec rake routes  $ bundle exec rake routes Prefix Verb URI Pattern Controller#Action root GET / posts#index  http verb  GET  /  request  posts controller  index action  Post resources  PostitTemplate :: Application . routes . draw do resources :posts end  $ bundle exec rake routes Prefix Verb URI Pattern Controller#Action posts GET /posts ( .:format ) posts#index POST /posts ( .:format ) posts#create new_post GET /posts/new ( .:format ) posts#new edit_post GET /posts/:id/edit ( .:format ) posts#edit post GET /posts/:id ( .:format ) posts#show PATCH /posts/:id ( .:format ) posts#update PUT /posts/:id ( .:format ) posts#update DELETE /posts/:id ( .:format ) posts#destroy  only:  PostitTemplate :: Application . routes . draw do resources :posts , only : [ :new , :create ] end  new  create  $ bundle exec rake routes Prefix Verb URI Pattern Controller#Action posts POST /posts ( .:format ) posts#create new_post GET /posts/new ( .:format ) posts#new  except: PostitTemplate :: Application . routes . draw do resources :posts , except : [ :new , :create ] end  new  create  $ bundle exec rake routes Prefix Verb URI Pattern Controller#Action posts GET /posts ( .:format ) posts#index edit_post GET /posts/:id/edit ( .:format ) posts#edit post GET /posts/:id ( .:format ) posts#show PATCH /posts/:id ( .:format ) posts#update PUT /posts/:id ( .:format ) posts#update DELETE /posts/:id ( .:format ) posts#destroy  post  create comment  PostitTemplate :: Application . routes . draw do resources :posts do resources :comments , only : [ :create ] end end  comments controller  create action  $ bundle exec rake routes Prefix Verb URI Pattern Controller#Action post_comments POST /posts/:post_id/comments ( .:format ) comments#create posts GET /posts ( .:format ) posts#index POST /posts ( .:format ) posts#create new_post GET /posts/new ( .:format ) posts#new edit_post GET /posts/:id/edit ( .:format ) posts#edit post GET /posts/:id ( .:format ) posts#show PATCH /posts/:id ( .:format ) posts#update PUT /posts/:id ( .:format ) posts#update DELETE /posts/:id ( .:format ) posts#destroy {% blockquote Rick Cook %} Programming today is a race between software engineers striving to build bigger and better idiot-proof programs, and the universe trying to build bigger and better idiots. So far, the universe is winning.","url":"http://tsaith.github.io/zai-rails-zhong-she-ding-routes.html"},{"tags":"Web","title":" Rails ","text":",;  Rails    ;   migration   users table  migration  rails generate migration create_users () db/migrate/20141028055510_create_users.rb  table  username  column class CreateUsers < ActiveRecord :: Migration def change create_table :users do | t | t . string :username t . timestamps end end end  bundle exec rake db:migrate  users  table  posts table;  rails generate migration create_posts  db/migrate/20141028043352_create_posts.rb  table  title  user_id  column class CreatePosts < ActiveRecord :: Migration def change create_table :posts do | t | t . string :title t . integer :user_id t . timestamps end end end  bundle exec rake db:migrate  posts table  database schema  db/schema.rb ,  ActiveRecord :: Schema . define ( version : 20141028103914 ) do create_table \"users\" , force : true do | t | t . string \"username\" t . datetime \"created_at\" t . datetime \"updated_at\" end create_table \"posts\" , force : true do | t | t . string \"title\" t . integer \"user_id\" t . datetime \"created_at\" t . datetime \"updated_at\" end end  users  posts  tables  columns  models  User model  Post model   app/models/user.rb user  posts class User < ActiveRecord :: Base has_many :posts end  app/models/post.rb post  user class Post < ActiveRecord :: Base belongs_to :user end  User  Post ","url":"http://tsaith.github.io/zai-rails-zhong-she-ding-yi-dui-duo-guan-lian-xing.html"},{"tags":"Misc","title":"Homebrew: Mac ","text":" ;  Mac   Homebrew    ruby and curl  ruby -e \"$(curl -fsSL https://raw.github.com/mxcl/homebrew/go/install)\"  brew doctor  brew doctor  Homebrew    brew search   brew info   install  brew install   uninstall  brew uninstall   Homebrew brew update   ","url":"http://tsaith.github.io/homebrew-mac-zhuan-shu-de-tao-jian-guan-li-zhe.html"},{"tags":"Web","title":" SQLite ","text":" SQLite ;  DB Browser for SQLite     Homebrew  brew install sqlitebrowser   sqlitebrowser  SQLite Brower sqlitebrowser  Open Database  SQLite  ","url":"http://tsaith.github.io/yi-tao-mian-fei-de-sqlite-zi-liao-ku-liu-lan-qi.html"},{"tags":"Web","title":" Guard::LiveReload ","text":" ;  LiveReload ()   bundler   guard  guard-livereload  Gemfile  group : development do gem 'guard' gem 'guard-livereload' end  bundle  bundle  Guardfile bundle exec guard init  # A sample Guardfile # More info at https://github.com/guard/guard#readme #guard 'livereload', port: '4000' do guard 'livereload' do watch ( %r{app/views/.+\\.(erb|haml|slim)$} ) watch ( %r{app/helpers/.+\\.rb} ) watch ( %r{public/.+\\.(css|js|html)} ) watch ( %r{config/locales/.+\\.yml} ) # Rails Assets Pipeline watch ( %r{(app|vendor)(/assets/\\w+/(.+\\.(css|js|html|png|jpg))).*} ) { | m | \"/assets/ #{ m [ 3 ] } \" } end  Google Chrome  Chrome LiveReload Extension    bundle exec guard  bundle exec guard --debug  Google Chrome  LiveReload   Chrome  Guard::LiveReload  ","url":"http://tsaith.github.io/shi-yong-guardlivereload-zi-dong-shua-xin-liu-lan-qi.html"},{"tags":"Web","title":" Git","text":";  Git   Mac  Git    Mac  Homebrew   Git  brew install git  git config --global user.name \"Your Name\" git config --global user.email \"user@gmail.com\"  git config --global color.ui true   git init  .git/   GitHup repository  ( silver repository  repo);  git remote add origin https://github.com/silver/repo.git  git add -A  git add [ File Name ]  .txt  git add *.txt  git rm [ File Name ]  .txt  git rm *.txt  //  commit -m  git commit -m \"Add test.txt\"  repository  push  git push -u origin --all  git status  log git log  help  git help log   .gitignore ;  .tmp  .swp   .gitignore  *.tmp *.swp  commit  git diff HEAD  commit  git diff HEAD&#94; HEAD [Path / File]  commitment git reset --hard Head&#94;  Git    ","url":"http://tsaith.github.io/an-zhuang-he-shi-yong-git.html"},{"tags":"Web","title":" SSH Key","text":" web  ( GitHup, Heroku, AWS ...)  SSH Key ;  SSH Key  SSH key  ssh-keygen  private key   public key ;  id_rsa  id_rsa.pub  .ssh/  ? () ssh-keygen -t rsa -C \"your_email@example.com\"  ssh-agent  SSH key  ;  ssh-agent   private key  ~/.ssh/id_rsa ssh-add ~/.ssh/id_rsa ","url":"http://tsaith.github.io/chan-sheng-ssh-key.html"},{"tags":"Web","title":" Octopress ","text":" Octopress   ;    _config.yml  url : http://tsaith.github.io title : TH's Notes subtitle : Ruby / Rails / Life author : TH simple_search : https://www.google.com/search description :  About   source/_includes/custom/navigation.html  About  <ul class= \"main-navigation\" > <li><a href= \"{{ root_url }}/\" > Blog </a></li> <li><a href= \"{{ root_url }}/blog/archives\" > Archives </a></li> <li><a href= \"{{ root_url }}/about\" > About </a></li> </ul>  rake new_page['about']  source/about/index.markdown   ### About me Say something ...  Color Scheme Octopress  dark Solarized highlighting  light style  sass/custom/_colors.scss  uncomment //$solarized: light;  /* To use the light Solarized highlighting theme uncomment the following line */ $ solarized : light ;      source/_includes/navigation.html  <input type=\"hidden\" name=\"q\" value=\"site: {{ site.url | shorthand_url }} \" />  <input type=\"hidden\" name=\"sitesearch\" value=\" {{ site.url | shorthand_url }} \" />  Google    Disqus :     'Add Disqus to your site' \"shortname\"  Octopress  _config.yml  disqus_short_name:  \"shortname\"    2014-10-22-install-rails-on-mac.markdown [ link name ]({ % post_url 2014 - 10 - 22 - install - rails - on - mac % })  [ link name ]( / blog / 2014 / 10 / 22 / install - rails - on - mac )","url":"http://tsaith.github.io/dui-octopress-jin-xing-ke-zhi-hua.html"},{"tags":"Web","title":" Octopress  Whitespace theme","text":"Whitespace  Install $ cd octopress $ git clone git://github.com/lucaslew/whitespace.git .themes/whitespace $ rake install [ 'whitespace' ] # for zsh, use: rake install\\['whitespace'\\]","url":"http://tsaith.github.io/zai-octopress-shi-yong-whitespace-theme.html"},{"tags":"Web","title":" Octopress ","text":"Octopress   xdite    Octopress  Octopress  repository  git clone git://github.com/imathis/octopress.git directory_name ; bundle install  rake install   GitHup  GitHup  repository [].github.io;  tsaith tsaith.github.io   rake setup_github_pages setup_github_pages  GitHup repository  URL  GitHup pages  rake generate  deploy  GitHup pages rake deploy  source  push  GitHub repository git add . git commit -m \"\" git push origin source  [].github.io   new_post  source/_posts/  rake new_post[\"article title\"]  source/_posts/   --- layout: post title: \" Mac  Rails\" date: 2014-10-22 12:04:25 +0800 comments: true categories: Rails ---  Markdown   rake preview  http://localhost:4000  rake preview  rake generate  deploy  GitHup pages; rake generate rake deploy  push  source  GitHup repository!    2014-10-22-install-rails-on-mac.markdown []({% post_url 2014-10-22-install-rails-on-mac %})  []( /blog/2014/10/22/install-rails-on-mac )","url":"http://tsaith.github.io/shi-yong-octopress-jian-gou-bu-luo-ge.html"},{"tags":"Web","title":" Mac  Rails","text":": OSX 10.9.x  Rails  Install Rails   App Store  Xcode ()  Homebrew ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\"  brew doctor  Git brew install git  git config --global user.name \"/\" git config --global user.email \"\"  RVM \\curl -sSL https://get.rvm.io | bash  Ruby ( 2.1.1 ) rvm install 2.1.1  Rails gem install rails --no-ri --no-rdoc /Rails","url":"http://tsaith.github.io/zai-mac-shang-an-zhuang-rails.html"}]}